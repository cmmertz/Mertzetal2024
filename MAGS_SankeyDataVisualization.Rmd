---
title: "MAGS_SankeyDataVisualization"
author: "Conner Mertz"
date: "2023-08-28"
output: html_document
---

This script details how to make a phyloseq object from metagenomic processing pipeline output and how to visualize the data using Sankey diagrams. 


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
#load packages
library(plyr)
library(dplyr)
library(phyloseq)
library(metagMisc)
library(ggplot2)
library(remotes)
library(tidyverse)
library(vegan)
library("DESeq2")
library(ggsankey)
library(ggalluvial)
library(ggthemes)
library(RColorBrewer)
```

#How to make PS object from gapmind, abundance, and taxonomic classification outputs. 

format gapmind results to combine the candidates with the rules output
```{r}
#read in Gapmind candidates all bins file
gapmind_aa <- read.delim("/Users/connermertz/Dropbox (vlab)/Conner Mertz/UNM biology/Chapter 1 E1 vs E2/Methods/Metagenomics/methods_DataAnalysis/Metagenomic Pipeline/PipelineOutput/Gapmind_ALLBINS_candidates.txt")
#change name so target_ids match on both files
names(gapmind_aa)[1] ="Genomic_bins"

#read in Gapmind rules all bins file
gapmind_rules <- read.csv("/Users/connermertz/Dropbox (vlab)/Conner Mertz/UNM biology/Chapter 1 E1 vs E2/Methods/Metagenomics/methods_DataAnalysis/Metagenomic Pipeline/PipelineOutput/Gapmind_rules_import.csv", header=T)
#change name so target_ids match on both files
names(gapmind_rules)[1] ="Genomic_bins" 

#now we need to get our gapmind rules results and join it with our gapmind candidates (combining two data frames)
#we need the bins and the pathways to line up
Part_1 <- full_join(gapmind_aa, gapmind_rules, by = c("Genomic_bins","pathway","orgId", "gid"))

#write.csv(Part_1,"/Users/connermertz/Dropbox (vlab)/Conner Mertz/UNM biology/Chapter 1 E1 vs E2/Methods/Metagenomics/methods_DataAnalysis/Metagenomic Pipeline/PipelineOutput/Gapmind_Candidates_Rules_allbins.csv") #now delete the A colunm with the numbers.and resave. 

```

make abundance table 
```{r}
#read in abundance table
bin_abundance_table <- read.delim("/Users/connermertz/Dropbox (vlab)/Conner Mertz/UNM biology/Chapter 1 E1 vs E2/Methods/Metagenomics/methods_DataAnalysis/Metagenomic Pipeline/PipelineOutput/bin_abundance_table.txt")
#change name so target_ids match on both files
names(bin_abundance_table)[1] ="Genomic_bins" 

gapmind_can_rules <- read.csv("/Users/connermertz/Dropbox (vlab)/Conner Mertz/UNM biology/Chapter 1 E1 vs E2/Methods/Metagenomics/methods_DataAnalysis/Metagenomic Pipeline/PipelineOutput/Gapmind_Candidates_Rules_allbins.csv")
#change name so target_ids match on both files
names(gapmind_can_rules)[1] ="Genomic_bins" 

#Now we only want to keep the genes that showed up with gapmind, we don't need the other genes that showed up
Part_2 <- full_join(bin_abundance_table, gapmind_can_rules, by = c("Genomic_bins"))

#write.csv(Part_2,"/Users/connermertz/Dropbox (vlab)/Conner Mertz/UNM biology/Chapter 1 E1 vs E2/Methods/Metagenomics/methods_DataAnalysis/Metagenomic Pipeline/PipelineOutput/Gapmind_rules_candidates_abundances.csv")
#now you can open your files in excel, here you want to make sure the sample_IDs match between META and abundance files.
#you need to make sure both files are in the same order in the Genomic_bins column (same order as abundance inport file)
#once they are in the same order, add a column into the A spot, and number your items (1-alot in our case), we called this added column "bin_order"

#now delete Genomic_bins column and all other colmuns with letters in them from your Gapmind_rules_candidates_abundances.csv file and re-save it (just keep bin_order and abundances for each sample)


```

Assign Taxonomy
```{r}
#read in gapmind candidate+rules file
gapmind_can_rules <- read.csv("/Users/connermertz/Dropbox (vlab)/Conner Mertz/UNM biology/Chapter 1 E1 vs E2/Methods/Metagenomics/methods_DataAnalysis/Metagenomic Pipeline/PipelineOutput/Gapmind_Candidates_Rules_allbins.csv")
#change name so target_ids match on both files
names(gapmind_can_rules)[1] ="Genomic_bins" 

#read in your taxonomy classification file 
Taxonomy_classification <- read.delim("/Users/connermertz/Dropbox (vlab)/Conner Mertz/UNM biology/Chapter 1 E1 vs E2/Methods/Metagenomics/methods_DataAnalysis/Metagenomic Pipeline/PipelineOutput/METAGENOMIC_TAXONOMY_classification.txt") #if this doesn't load be sure to dowload the file from the cloud, then it will work
#change name so target_ids match on both files
names(Taxonomy_classification)[1] ="Genomic_bins"

#now we need to get our gapmind results and join it with our Taxonomy results from CAT (combining two data frames)
#we only want to keep the genes that showed up with gapmind, we don't need the other genes that showed up
Part_3 <- full_join(Taxonomy_classification, gapmind_can_rules, by = c("Genomic_bins"))

#write.csv(Part_3,"/Users/connermertz/Dropbox (vlab)/Conner Mertz/UNM biology/Chapter 1 E1 vs E2/Methods/Metagenomics/methods_DataAnalysis/Metagenomic Pipeline/PipelineOutput/Final_Gapmind_and_Taxonomy.csv") #I wnt into this file and made all the blank boxes NA's 
#now you can open your files in excel, here you want to make sure the sample_IDs match between files, you need to make sure both files are in the same order in the target_id column
#once they are in the same order, add a column into the A spot, and number your items, we called this added column "bin_order"


```


#Make your ps object and save as rds
```{r}
#make ps object
otu_gapmind<- read.csv("/Users/connermertz/Dropbox (vlab)/Conner Mertz/UNM biology/Chapter 1 E1 vs E2/Methods/Metagenomics/methods_DataAnalysis/Metagenomic Pipeline/PipelineOutput/Gapmind_rules_candidates_abundances.csv", header=T, row.names="bin_order")
#otu_gapmind[otu_gapmind == 0.0000000] <- NA #replace zeros with NA
otu_gapmind
#otu_gapmind[complete.cases(otu_gapmind), ]
#otu_gapmind
tax_mat<- read.csv("/Users/connermertz/Dropbox (vlab)/Conner Mertz/UNM biology/Chapter 1 E1 vs E2/Methods/Metagenomics/methods_DataAnalysis/Metagenomic Pipeline/PipelineOutput/Final_Gapmind_and_Taxonomy.csv", header=T, row.names="bin_order")
Meta <- read.csv("/Users/connermertz/Dropbox (vlab)/Conner Mertz/UNM biology/Chapter 1 E1 vs E2/Methods/Metagenomics/META_metagenomic samples E1_E2.csv", header=T, row.names='Sample_ID')
str(Meta)

otu_gapmind <- as.matrix(otu_gapmind)
tax_mat <- as.matrix(tax_mat)

OTU = otu_table(otu_gapmind, taxa_are_rows = TRUE)
TAX = tax_table(tax_mat)
samples = sample_data(Meta)

ps <- phyloseq(OTU, TAX, samples)
ps

# Save an object to a file
saveRDS(ps, "/Users/connermertz/Dropbox (vlab)/Conner Mertz/UNM biology/Chapter 1 E1 vs E2/Methods/Metagenomics/Metagenomic_final_ps.rds")
# Restore the object (these analyses work if you make the ps object fresh each time, not load it from rds file. I dunno why.)

```




Read in PS object
```{r}
#read in your ps RDS
ps <- readRDS("/Users/connermertz/Dropbox (vlab)/Conner Mertz/UNM biology/Chapter 1 E1 vs E2/Methods/Metagenomics/Metagenomic_final_ps.rds")
#READ IN META
Meta <- read.csv("/Users/connermertz/Dropbox (vlab)/Conner Mertz/UNM biology/Chapter 1 E1 vs E2/Methods/Metagenomics/META_metagenomic samples E1_E2.csv", header=T, row.names='Sample_ID')
str(Meta)

#sample_sums(ps)
#don't rarefy this data
#ps <- rarefy_even_depth(ps, sample.size = min(sample_sums(ps)),
#  rngseed = FALSE, replace = TRUE, trimOTUs = TRUE, verbose = TRUE)
#sample_sums(ps)
```

#subset
```{r}
### Make new phyloseq object of just E1
E1_ps <- subset_samples(ps, Experiment=="E1")
#sample_names(E1_ps)                                             ### List of sample names from design file

### Make new phyloseq object of just E1
E2_ps <- subset_samples(ps, Experiment=="E2")
#sample_names(E1_ps)                                             ### List of sample names from design file


#subset samples for just measured essential AAs
ps_E1_ESS_measured <- subset_taxa(E1_ps, pathway == c("val", "leu", "ile", "phe", "lys", "thr" ))
ps_E2_ESS_measured <- subset_taxa(E2_ps, pathway == c("val", "leu", "ile", "phe", "lys", "thr"))


ps_NONESS <- subset_taxa(ps, pathway == c("gly", "ser", "pro", "chorismate","asn","cys","gln"))
tax_table(ps_NONESS)

#Only keep Gapmind Medium and High confidence levels for candidates from ublast
#High confidence: aligns at 40% identity, covers 80% of the characterized protein, candidate is less similar to proteins with other functions
#medium confidence: aligns at 30% identity and 80% coverage and less similar to proteins with other functions OR 40% identify and 70% coverage. 
ps_E1_ESS_measured_score <- subset_taxa(ps_E1_ESS_measured, score == c(" 2", " 1"))
ps_E2_ESS_measured_score <- subset_taxa(ps_E2_ESS_measured, score == c(" 2", " 1"))


ps_NONESS_score <- subset_taxa(ps_NONESS, score == c(" 2", " 1"))
```

Make PS objects into table for Sankey plots
```{r}
#convert ps object into proper format
E1_sankey <- psmelt(ps_E1_ESS_measured_score) #make table
E1_sankey <- E1_sankey %>% filter(phylum!= "no_support") #remove phyla with no support

E2_sankey <- psmelt(ps_E2_ESS_measured_score) #make table
E2_sankey <- E2_sankey %>% filter(phylum!= "no_support") #remove phyla with no support

```



set up colors for all plots
```{r}
#Set up- colors to match diet treatment
#first you want to factor your items. These are the names of the Location in the order I want them to be every time. 
Meta$Percent_Protein <-factor(Meta$Percent_Protein, levels=c("2.5P", "5P", "10P"))

#now create an object that is a list of colors in a certain order.The colors I chose are "color-blind friendly":
DietScale <- c("#cb146e", "#f7ce45","#1983fc")
#scales::show_col(DietScale)

#now we want to merge the two. We are taking the order from the locations and telling it that it needs to match the order from the cbPalette.
names(DietScale) <- levels(Meta$Percent_Protein)
#Have you ever used the scale_colour_manual command? Now we can combine that command and all of the stuff we want in it into a new object, LocationColors. At the end of your ggplot code, just add a +DietColor (or whatever you decide to name it), and it should pull the colors you made! 
DietColors<- scale_fill_manual(name="Percent_Protein", values=DietScale)


#first you want to factor your items. These are the names of the category in the order I want them to be every time. 
Meta$Exp_Diet_Location <-factor(Meta$Exp_Diet_Location, levels=c("E1_2.5P_CEC", "E1_5P_CEC", "E1_10P_CEC","E2_2.5P_CEC", "E2_5P_CEC", "E2_10P_CEC"))

#now create an object that is a list of colors in a certain order.The colors I chose are "color-blind friendly":
Exp_Diet_Scale <- c("#B2182B", "#D6604D","#F4A582","#2166AC", "#4393C3","#92C5DE")
#scales::show_col(DietScale)

#now we want to merge the two. We are taking the order from the locations and telling it that it needs to match the order from the cbPalette.
names(Exp_Diet_Scale) <- levels(Meta$Exp_Diet_Location)
#Have you ever used the scale_colour_manual command? Now we can combine that command and all of the stuff we want in it into a new object, LocationColors. At the end of your ggplot code, just add a +DietColor (or whatever you decide to name it), and it should pull the colors you made! 
Exp_DietColors<- scale_colour_manual(name="Exp_Diet_Location", values=Exp_Diet_Scale)
```

#for abundance plots

```{r}
#pathwayColor <- c(arg = "#c49a38",
#  asn = "#6170d5", 
#  chorismate = "#91b23e", 
#  cys = "#ab71d3",
#  gln = "#4fc083", 
#  gly = "#6b9645",
#  his = "#533585",
#  ile = "#33d4d1",
#  leu = "#cb3f7d", 
#  lys = "#628bd5", 
#  met = "#bd582b" ,
#  phe = "#ca83cc",
#  pro = "#b38044",
#  ser= "#81285e",
#  thr= "#ae473a",
#  trp= "#d46f9a",
#  tyr= "#c24c5f",
#  val= "#bd4ca4") 

#Then use this code in for your plot
#scale_fill_manual(values = pathwayColor)


ESS_pathwayColor <- c(val = "#0060bf", 
                      leu = "#f0cc41", 
                      ile = "#9a0079", 
                      phe = "#535700", 
                      lys = "#ff889f", 
                      thr = "#960300") 



#Make colors the same for Phylum pathways

phylumColor <- c(Bacteroidetes = "#f37c37",
  Firmicutes = "#028cfb", 
  Proteobacteria = "#bf329b",
  no_support = "#b9843b") 


familyColor <- c(Bacteroidaceae= "#00226b",
Desulfovibrionaceae= "#edb331",
Enterococcaceae= "#c6b0ff",
Helicobacteraceae= "#ff875e",
Lachnospiraceae= "#f6477f",
Lactobacillaceae= "#623d00",
Muribaculaceae= "#85003d",
Porphyromonadaceae= "#01b1f4",
Rikenellaceae= "#b35a58",
Tannerellaceae= "#54b543")

#Then use this code in for your plot
#scale_fill_manual(values = PhylumColor)

#Tip: it can be rather difficult to find acceptable colors when you have many discrete variables. Check out this great open-source tool, which allows you to randomly generate as many colors as you need, and gives them in a nice, easily copy-pasteable form - https://medialab.github.io/iwanthue/

#https://medialab.github.io/iwanthue/
```

#relative abundance by phylum
```{r}
#For taxonomic figures - filter out Phyla that are less than 1% relative abundance in entire data set, not just per sample. 
#https://github.com/joey711/phyloseq/issues/494
#For taxonomic figures - filter out Phyla that account for less than 1% by relative abundance per sample
E1_E2_phyla_ab1 <- ps %>%
  tax_glom(taxrank = "phylum", NArm = FALSE) %>%        # Agglomerate at Phyla level and KEEP unclassified Phyla
  transform_sample_counts(function(x) {x/sum(x)}) %>%   # Transform to relative abundance
  psmelt() %>%                                          # Melt to long format
  filter(Abundance > 0.01)                              # Filter out low abundance taxa (less than 1% relative abundance)
```

#set order of x axis
```{r}
#set order of x axis for Sankey
#X axes for E1 and E2
#repeat for each major phyloseq object I have created
#indicate levels
Percent_Protein.order <- c("2.5P", "5P", "10P") 
E1_sankey$Percent_Protein <- factor(E1_sankey$Percent_Protein, levels= Percent_Protein.order)
levels(get_variable(E1_sankey, "Percent_Protein"))

Percent_Protein.order <- c("2.5P", "5P", "10P") 
E2_sankey$Percent_Protein <- factor(E2_sankey$Percent_Protein, levels= Percent_Protein.order)
levels(get_variable(E2_sankey, "Percent_Protein"))

#set order for pathways
pathway.order <- c("arg", "asn", "chorismate", "cys", "gln", "gly", "his", "ile", "leu", "lys", "met", "phe", "pro", "ser", "thr", "trp", "tyr", "val") 
E1_sankey$pathway <- factor(E1_sankey$pathway, levels= pathway.order)
levels(get_variable(E1_sankey, "pathway"))

pathway.order <- c("arg", "asn", "chorismate", "cys", "gln", "gly", "his", "ile", "leu", "lys", "met", "phe", "pro", "ser", "thr", "trp", "tyr", "val") 
E2_sankey$pathway <- factor(E2_sankey$pathway, levels= pathway.order)
levels(get_variable(E2_sankey, "pathway"))

#set order for MostLikelySeriesofSteps
MostLikelySeriesofStepsinPathway.order <- c(
  "argA argB argC argD'B argF'B argE'B argG argH", 
  "argA argB argC argD argE carA carB argI argG argH", 
  "argJ argB argC argD carA carB argI argG argH", 
  "aspS2 gatA gatB gatC", "asnA", "asnB", 
  "aroG aroB aroD aroE aroL aroA aroC", 
  "tpiA fbp asp-kinase asd aroA' aroB' aroD aroE aroL aroA aroC", 
  "cysE cysK", "CBS CGL","serA serC PSSH",  
  "gltX glnA gatA gatB gatC", "glnA", "glyA", 
  "prs hisG hisI hisE hisA hisF hisH hisB hisC hisN hisD", 
  "cimA leuC leuD leuB ilvI ilvH ilvC ilvD ilvE", 
  "ilvA ilvI ilvH ilvC ilvD ilvE",  
  "ilvH ilvI ilvC ilvD leuA leuC leuD leuB ilvE", 
  "asp-kinase asd dapA dapB dapD dapC dapE dapF lysA",
  "asp-kinase asd dapA dapB DAPtransferase dapF lysA",
  "asp-kinase asd dapA dapB ddh lysA", 
  "asp-kinase asd asd-S-transferase asd-S-ferredoxin asd-S-perS metE", 
  "asp-kinase asd hom hom_kinase metB metC metE", 
  "asp-kinase asd hom metA metB metC metE", 
  "asp-kinase asd hom metA metB metC metH B12-reactivation-domain", 
  "asp-kinase asd hom metX metB metC metE", 
  "asp-kinase asd hom metX metB metC metH B12-reactivation-domain", 
  "asp-kinase asd hom metX metY metE", 
  "asp-kinase asd hom metX metY metH B12-reactivation-domain", 
  "asp-kinase asd hom metX metY metH ramA",  
  "cmutase preph-dehydratase ilvE", 
  "argA argB argC argD argE cyclodeaminase", 
  "argJ argB argC argD cyclodeaminase", 
  "argA argB argC argD argE OAT proC", 
  "argJ argB argC argD OAT proC", 
  "proB proA proC", 
  "serA serC serB", 
  "asp-kinase asd hom thrB thrC", 
  "trpE trpD_1 trpD_2 PRAI IGPS trpA trpB", 
  "trpED trpD_2 PRAI IGPS trpA trpB", 
  "cmutase pre-dehydr tyrB", 
  "PAH", 
  "ilvH ilvI ilvC ilvD ilvE") 
E1_sankey$MostLikelySeriesofStepsinPathway <- factor(E1_sankey$MostLikelySeriesofStepsinPathway, levels= MostLikelySeriesofStepsinPathway.order)
levels(get_variable(E1_sankey, "MostLikelySeriesofStepsinPathway"))

MostLikelySeriesofStepsinPathway.order <- c(
 "argA argB argC argD'B argF'B argE'B argG argH", 
  "argA argB argC argD argE carA carB argI argG argH", 
  "argJ argB argC argD carA carB argI argG argH", 
  "aspS2 gatA gatB gatC", "asnA", "asnB", 
  "aroG aroB aroD aroE aroL aroA aroC", 
  "tpiA fbp asp-kinase asd aroA' aroB' aroD aroE aroL aroA aroC", 
  "cysE cysK", "CBS CGL","serA serC PSSH",  
  "gltX glnA gatA gatB gatC", "glnA", "glyA", 
  "prs hisG hisI hisE hisA hisF hisH hisB hisC hisN hisD", 
  "cimA leuC leuD leuB ilvI ilvH ilvC ilvD ilvE", 
  "ilvA ilvI ilvH ilvC ilvD ilvE",  
  "ilvH ilvI ilvC ilvD leuA leuC leuD leuB ilvE", 
  "asp-kinase asd dapA dapB dapD dapC dapE dapF lysA",
  "asp-kinase asd dapA dapB DAPtransferase dapF lysA",
  "asp-kinase asd dapA dapB ddh lysA", 
  "asp-kinase asd asd-S-transferase asd-S-ferredoxin asd-S-perS metE", 
  "asp-kinase asd hom hom_kinase metB metC metE", 
  "asp-kinase asd hom metA metB metC metE", 
  "asp-kinase asd hom metA metB metC metH B12-reactivation-domain", 
  "asp-kinase asd hom metX metB metC metE", 
  "asp-kinase asd hom metX metB metC metH B12-reactivation-domain", 
  "asp-kinase asd hom metX metY metE", 
  "asp-kinase asd hom metX metY metH B12-reactivation-domain", 
  "asp-kinase asd hom metX metY metH ramA",  
  "cmutase preph-dehydratase ilvE", 
  "argA argB argC argD argE cyclodeaminase", 
  "argJ argB argC argD cyclodeaminase", 
  "argA argB argC argD argE OAT proC", 
  "argJ argB argC argD OAT proC", 
  "proB proA proC", 
  "serA serC serB", 
  "asp-kinase asd hom thrB thrC", 
  "trpE trpD_1 trpD_2 PRAI IGPS trpA trpB", 
  "trpED trpD_2 PRAI IGPS trpA trpB", 
  "cmutase pre-dehydr tyrB", 
  "PAH", 
  "ilvH ilvI ilvC ilvD ilvE")
E2_sankey$MostLikelySeriesofStepsinPathway <- factor(E2_sankey$MostLikelySeriesofStepsinPathway, levels= MostLikelySeriesofStepsinPathway.order)
levels(get_variable(E2_sankey, "MostLikelySeriesofStepsinPathway"))


MostLikelyPathway.order <- c("argA argB argC argD'B argF'B argE'B argG argH", "ornithine carA carB argI argG argH", "to_asn_tRNA", "to_asparagine",  "3-dehydroquinate aroD aroE aroL aroA aroC", "from-serine", "from-serine-homocysteine", "serA serC from-phosphoserine", "to_gln_tRNA", "to_glutamine", "from_serine", "prs hisG hisI hisE hisA hisF hisH hisB hisC hisN hisD", "oxobutanoate ilvI ilvH ilvC ilvD ilvE", "ilvH ilvI ilvC ilvD leuA leuC leuD leuB ilvE", "meso-DAP lysA", "homocysteine methionine_synthase", "cmutase preph-dehydratase ilvE", "ornithine cyclodeaminase", "serA serC serB", "homoserine thrB thrC", "anthranilate-synthase trpD_2 PRAI IGPS trpA trpB", "cmutase pre-dehydr tyrB", "from-phe", "ilvH ilvI ilvC ilvD ilvE") 
E1_sankey$MostLikelyPathway <- factor(E1_sankey$MostLikelyPathway, levels= MostLikelyPathway.order)
levels(get_variable(E1_sankey, "MostLikelyPathway"))

MostLikelyPathway.order <- c("argA argB argC argD'B argF'B argE'B argG argH", "ornithine carA carB argI argG argH", "to_asn_tRNA", "to_asparagine",  "3-dehydroquinate aroD aroE aroL aroA aroC", "from-serine", "from-serine-homocysteine", "serA serC from-phosphoserine", "to_gln_tRNA", "to_glutamine", "from_serine", "prs hisG hisI hisE hisA hisF hisH hisB hisC hisN hisD", "oxobutanoate ilvI ilvH ilvC ilvD ilvE", "ilvH ilvI ilvC ilvD leuA leuC leuD leuB ilvE", "meso-DAP lysA", "homocysteine methionine_synthase", "cmutase preph-dehydratase ilvE", "ornithine cyclodeaminase", "serA serC serB", "homoserine thrB thrC", "anthranilate-synthase trpD_2 PRAI IGPS trpA trpB", "cmutase pre-dehydr tyrB", "from-phe", "ilvH ilvI ilvC ilvD ilvE") 
E2_sankey$MostLikelyPathway <- factor(E2_sankey$MostLikelyPathway, levels= MostLikelyPathway.order)
levels(get_variable(E2_sankey, "MostLikelyPathway"))




Percent_Protein.order <- c("2.5P", "5P", "10P") 
E1_E2_phyla_ab1$Percent_Protein <- factor(E1_E2_phyla_ab1$Percent_Protein, levels= Percent_Protein.order)
levels(get_variable(E1_E2_phyla_ab1, "Percent_Protein"))

#set order of x axis
#X axes for E1 and E2
#repeat for each major phyloseq object I have created
#indicate levels
Percent_Protein.order <- c("2.5P", "5P", "10P") 
sample_data(ps)$Percent_Protein <- factor(sample_data(ps)$Percent_Protein, levels= Percent_Protein.order)
levels(get_variable(ps, "Percent_Protein"))
#X axes for Exp_Diet_Location
#repeat for each major phyloseq object I have created
Exp_Diet_Location.order1 <- c("E1_2.5P_CEC", "E1_5P_CEC", "E1_10P_CEC","E2_2.5P_CEC", "E2_5P_CEC", "E2_10P_CEC")
sample_data(ps)$Exp_Diet_Location <- factor(sample_data(ps)$Exp_Diet_Location, levels= Exp_Diet_Location.order1)
levels(get_variable(ps, "Exp_Diet_Location"))


#set order of x axis
#X axes for E1
#repeat for each major phyloseq object I have created
#indicate levels
Percent_Protein.order2 <- c("2.5P", "5P", "10P") 
sample_data(E1_ps)$Percent_Protein <- factor(sample_data(E1_ps)$Percent_Protein, levels= Percent_Protein.order2)
levels(get_variable(E1_ps, "Percent_Protein"))
#X axes for E1 Exp_Diet_Location
#repeat for each major phyloseq object I have created
Exp_Diet_Location.order2 <- c("E1_2.5P_CEC", "E1_5P_CEC", "E1_10P_CEC")
sample_data(E1_ps)$Exp_Diet_Location <- factor(sample_data(E1_ps)$Exp_Diet_Location, levels= Exp_Diet_Location.order2)
levels(get_variable(E1_ps, "Exp_Diet_Location"))

#set order of x axis
#X axes for E2
#repeat for each major phyloseq object I have created
#indicate levels
Percent_Protein.order3 <- c("2.5P", "5P", "10P") 
sample_data(E2_ps)$Percent_Protein <- factor(sample_data(E2_ps)$Percent_Protein, levels= Percent_Protein.order3)
levels(get_variable(E2_ps, "Percent_Protein"))
#X axes for E2 Exp_Diet_Location
#repeat for each major phyloseq object I have created
Exp_Diet_Location.order3 <- c("E2_2.5P_CEC", "E2_5P_CEC", "E2_10P_CEC")
sample_data(E2_ps)$Exp_Diet_Location <- factor(sample_data(E2_ps)$Exp_Diet_Location, levels= Exp_Diet_Location.order3)
levels(get_variable(E2_ps, "Exp_Diet_Location"))




```
Look at relative Abundance by phylum of metagenomic data set
```{r}
#Relative Abundance by Phylum 
taxa_plot <- ggplot(E1_E2_phyla_ab1, aes(x = Animal_ID, y = Abundance, fill = phylum)) +
  guides(fill = guide_legend(title.position = "top")) +
  labs(x = "Individual", y = "Relative Abundance (1% >)", fill = "phylum") +
  labs(title = "Relative Abundance by Phylum of metagenomic results")+
  facet_wrap(Experiment~Percent_Protein, scale = "free_x") +
  geom_bar(stat = "identity", position = "fill") +
  scale_fill_manual(values = phylumColor) +
  guides(fill = guide_legend(reverse = FALSE, keywidth = 1, keyheight = 1)) +
  theme_bw() +
  theme(
    title =element_text(size=22, face='bold'),
    axis.text.x = element_text(color="black", size=16, angle = 60, hjust= 1),
    axis.text.y = element_text(color="black", size=16),
    strip.text.y = element_text(color="black", size=16),
    legend.title = element_text(color="black", size=22),
    legend.text = element_text(color="black", size=14),
    legend.position = "right",
    strip.text = element_text(size = 20),
    axis.title.x = element_text(color="black", size=22),
    axis.title.y = element_text(color="black", size=22, angle=90),
    panel.grid.major = element_blank(), # switch off major grid lines
   panel.grid.minor = element_blank(), # switch off minor grid lines
    panel.border = element_rect(colour = "black", fill=NA, size=.75)
  )
#CREATE A PDF AND SAVES IT TO THE RIGHT DIRECTORY/FOLDER. 
pdf("/Users/connermertz/Dropbox (vlab)/Conner Mertz/UNM biology/Chapter 1 E1 vs E2/Methods/Metagenomics/methods_DataAnalysis/Metagenomic Pipeline/Plots/Relative Abundance/Phylum_RelAbundance_E1_E2.pdf", height = 10, width =11)
taxa_plot
dev.off()


```


Now plot the Sankey!:
Use these to generate plots
https://github.com/AnantharamanLab/METABOLIC/blob/master/draw_metabolic_Sankey_diagram.R

https://cran.r-project.org/web/packages/ggalluvial/vignettes/ggalluvial.html

E1 essential AAs measured for d13C with only med-high confidence scores
fill= percent_Protein
```{r}
E1_ESS_sankey <- ggplot(as.data.frame(E1_sankey),
       aes(y = Abundance, axis1 = phylum, axis2 = Percent_Protein, axis3 = pathway)) +
  geom_alluvium(aes(fill = Percent_Protein), width = 1/12)+
    geom_stratum(width = 1/12, fill = "black", color = "white") +
  geom_label(stat = "stratum", aes(label = after_stat(stratum))) +
  DietColors +
  scale_x_discrete(limits = c("phylum", "Percent_Protein", "pathway"), expand = c(.05, .05)) +
  #scale_fill_brewer(type = "qual", palette = "Set1") +
  ggtitle("Synthetic Treatment: \n only med-high gapmind confidence scores") +
theme_bw() +
  theme(
    title =element_text(size=22, face='bold'),
    axis.text.x = element_text(color="black", size=14),
    axis.text.y = element_text(color="black", size=16),
    strip.text.y = element_text(color="black", size=16),
    legend.title = element_text(color="black", size=22),
    legend.text = element_text(color="black", size=16),
    legend.position = "right",
    strip.background = element_blank(), #to remove facet wrap title
    strip.text = element_text(size = 20),
    axis.title.x = element_text(color="black", size=22),
    axis.title.y = element_text(color="black", size=22, angle=90),
    panel.grid.major = element_blank(), # switch off major grid lines
   panel.grid.minor = element_blank(), # switch off minor grid lines
    panel.border = element_rect(colour = "black", fill=NA, size=.75)
  )
#CREATE A PDF AND SAVES IT TO THE RIGHT DIRECTORY/FOLDER. 
#pdf("/Users/connermertz/Dropbox (vlab)/Conner Mertz/UNM biology/Chapter 1 E1 vs E2/Methods/Metagenomics/methods_DataAnalysis/Metagenomic Pipeline/Plots/SANKEY/General_By_Phylum/E1_byPhylum_overall_fill_Percent_Protein.pdf", height = 10, width =12)
E1_ESS_sankey
#dev.off()
 



```
Sankey Plot E1 Overall but fill = phylum
```{r}
E1_ESS_sankey <- ggplot(as.data.frame(E1_sankey),
       aes(y = Abundance, axis1 = phylum, axis2 = Percent_Protein, axis3 = pathway)) +
  geom_alluvium(aes(fill = phylum), width = 1/12)+
    geom_stratum(width = 1/12, fill = "black", color = "white") +
  geom_label(stat = "stratum", aes(label = after_stat(stratum))) +
  scale_fill_manual(values = phylumColor) +
  scale_x_discrete(limits = c("phylum", "Percent_Protein", "pathway"), expand = c(.05, .05)) +
  #scale_fill_brewer(type = "qual", palette = "Set1") +
  ggtitle("Synthetic Treatment: \n only med-high gapmind confidence scores") +
theme_bw() +
  theme(
    title =element_text(size=22, face='bold'),
    axis.text.x = element_text(color="black", size=14),
    axis.text.y = element_text(color="black", size=16),
    strip.text.y = element_text(color="black", size=16),
    legend.title = element_text(color="black", size=22),
    legend.text = element_text(color="black", size=16),
    legend.position = "right",
    strip.background = element_blank(), #to remove facet wrap title
    strip.text = element_text(size = 20),
    axis.title.x = element_text(color="black", size=22),
    axis.title.y = element_text(color="black", size=22, angle=90),
    panel.grid.major = element_blank(), # switch off major grid lines
   panel.grid.minor = element_blank(), # switch off minor grid lines
    panel.border = element_rect(colour = "black", fill=NA, size=.75)
  )
#CREATE A PDF AND SAVES IT TO THE RIGHT DIRECTORY/FOLDER. 
#pdf("/Users/connermertz/Dropbox (vlab)/Conner Mertz/UNM biology/Chapter 1 E1 vs E2/Methods/Metagenomics/methods_DataAnalysis/Metagenomic Pipeline/Plots/SANKEY/General_By_Phylum/E1_byPhylum_overall_fill_phylum.pdf", height = 10, width =12)
E1_ESS_sankey
#dev.off()

```










Calc widths of curved lines
```{r}
# recover the built plot
p_build <- ggplot_build(E1_ESS_sankey)
# extract the data for the alluvium graphical objects
p_alluv <- p_build$data[[1L]]
# what are the fill colors
unique(p_alluv$fill)
#"#f37c37" "#028cfb" "#bf329b"
    #Bacteroidetes = "#f37c37",
    #Firmicutes = "#028cfb", 
    #Proteobacteria = "#bf329b",

####BACTEROIDETES##############
# filter to low protein and Bacteroidetes
p_alluv_2.5P_Bacteroidetes <-
  p_alluv[p_alluv$stratum == "2.5P" & p_alluv$fill == "#f37c37", ]
# remove (redundant) stratum column (to avoid confusion in merge)
p_alluv_2.5P_Bacteroidetes <- subset(p_alluv_2.5P_Bacteroidetes, select = -stratum)

# filter to pathway data for phylum
p_alluv_pathway_bacteroidetes <-
  p_alluv[p_alluv$x == 3 & p_alluv$fill == "#f37c37", ]
# select only alluvia (by which to merge) and class
p_alluv_pathway_bacteroidetes <- p_alluv_pathway_bacteroidetes[, c("alluvium", "stratum")]
# merge path data into 2.5P Bacteroidetes data
p_alluv_2.5P_Bacteroidetes <-
  merge(p_alluv_2.5P_Bacteroidetes, p_alluv_pathway_bacteroidetes, by = "alluvium")

# calculate ribbon heights
p_alluv_2.5P_Bacteroidetes$height <- p_alluv_2.5P_Bacteroidetes$ymax - p_alluv_2.5P_Bacteroidetes$ymin
# restrict to class strata and ribbon heights
p_alluv_2.5P_Bacteroidetes <- subset(p_alluv_2.5P_Bacteroidetes, select = c(stratum, height))
# add heights within strata 
E1_2.5P_bacteroidetes <- aggregate(
  p_alluv_2.5P_Bacteroidetes$height,
  by = subset(p_alluv_2.5P_Bacteroidetes, select = stratum),
  FUN = sum
)


# filter to medium protein and Bacteroidetes
p_alluv_5P_Bacteroidetes <-
  p_alluv[p_alluv$stratum == "5P" & p_alluv$fill == "#f37c37", ]
# remove (redundant) stratum column (to avoid confusion in merge)
p_alluv_5P_Bacteroidetes <- subset(p_alluv_5P_Bacteroidetes, select = -stratum)

# filter to pathway data for phylum
p_alluv_pathway_bacteroidetes <-
  p_alluv[p_alluv$x == 3 & p_alluv$fill == "#f37c37", ]
# select only alluvia (by which to merge) and class
p_alluv_pathway_bacteroidetes <- p_alluv_pathway_bacteroidetes[, c("alluvium", "stratum")]
# merge path data into 5P Bacteroidetes data
p_alluv_5P_Bacteroidetes <-
  merge(p_alluv_5P_Bacteroidetes, p_alluv_pathway_bacteroidetes, by = "alluvium")

# calculate ribbon heights
p_alluv_5P_Bacteroidetes$height <- p_alluv_5P_Bacteroidetes$ymax - p_alluv_5P_Bacteroidetes$ymin
# restrict to class strata and ribbon heights
p_alluv_5P_Bacteroidetes <- subset(p_alluv_5P_Bacteroidetes, select = c(stratum, height))
# add heights within strata 
E1_5P_bacteroidetes <-aggregate(
  p_alluv_5P_Bacteroidetes$height,
  by = subset(p_alluv_5P_Bacteroidetes, select = stratum),
  FUN = sum
)

# filter to high protein and Bacteroidetes
p_alluv_10P_Bacteroidetes <-
  p_alluv[p_alluv$stratum == "10P" & p_alluv$fill == "#f37c37", ]
# remove (redundant) stratum column (to avoid confusion in merge)
p_alluv_10P_Bacteroidetes <- subset(p_alluv_10P_Bacteroidetes, select = -stratum)

# filter to pathway data for phylum
p_alluv_pathway_bacteroidetes <-
  p_alluv[p_alluv$x == 3 & p_alluv$fill == "#f37c37", ]
# select only alluvia (by which to merge) and class
p_alluv_pathway_bacteroidetes <- p_alluv_pathway_bacteroidetes[, c("alluvium", "stratum")]
# merge path data into 10P Bacteroidetes data
p_alluv_10P_Bacteroidetes <-
  merge(p_alluv_10P_Bacteroidetes, p_alluv_pathway_bacteroidetes, by = "alluvium")

# calculate ribbon heights
p_alluv_10P_Bacteroidetes$height <- p_alluv_10P_Bacteroidetes$ymax - p_alluv_10P_Bacteroidetes$ymin
# restrict to class strata and ribbon heights
p_alluv_10P_Bacteroidetes <- subset(p_alluv_10P_Bacteroidetes, select = c(stratum, height))
# add heights within strata (combine adult and child counts)
E1_10P_bacteroidetes <-aggregate(
  p_alluv_10P_Bacteroidetes$height,
  by = subset(p_alluv_10P_Bacteroidetes, select = stratum),
  FUN = sum
)
#export bacteroidetes data
E1_2.5P_bacteroidetes
E1_5P_bacteroidetes
E1_10P_bacteroidetes

####firmicutes##############
# filter to low protein and firmicutes
p_alluv_2.5P_firmicutes <-
  p_alluv[p_alluv$stratum == "2.5P" & p_alluv$fill == "#028cfb", ]
# remove (redundant) stratum column (to avoid confusion in merge)
p_alluv_2.5P_firmicutes <- subset(p_alluv_2.5P_firmicutes, select = -stratum)

# filter to pathway data for phylum
p_alluv_pathway_firmicutes <-
  p_alluv[p_alluv$x == 3 & p_alluv$fill == "#028cfb", ]
# select only alluvia (by which to merge) and class
p_alluv_pathway_firmicutes <- p_alluv_pathway_firmicutes[, c("alluvium", "stratum")]
# merge path data into 2.5P firmicutes data
p_alluv_2.5P_firmicutes <-
  merge(p_alluv_2.5P_firmicutes, p_alluv_pathway_firmicutes, by = "alluvium")

# calculate ribbon heights
p_alluv_2.5P_firmicutes$height <- p_alluv_2.5P_firmicutes$ymax - p_alluv_2.5P_firmicutes$ymin
# restrict to class strata and ribbon heights
p_alluv_2.5P_firmicutes <- subset(p_alluv_2.5P_firmicutes, select = c(stratum, height))
# add heights within strata 
E1_2.5P_firmicutes <- aggregate(
  p_alluv_2.5P_firmicutes$height,
  by = subset(p_alluv_2.5P_firmicutes, select = stratum),
  FUN = sum
)


# filter to medium protein and firmicutes
p_alluv_5P_firmicutes <-
  p_alluv[p_alluv$stratum == "5P" & p_alluv$fill == "#028cfb", ]
# remove (redundant) stratum column (to avoid confusion in merge)
p_alluv_5P_firmicutes <- subset(p_alluv_5P_firmicutes, select = -stratum)

# filter to pathway data for phylum
p_alluv_pathway_firmicutes <-
  p_alluv[p_alluv$x == 3 & p_alluv$fill == "#028cfb", ]
# select only alluvia (by which to merge) and class
p_alluv_pathway_firmicutes <- p_alluv_pathway_firmicutes[, c("alluvium", "stratum")]
# merge path data into 5P firmicutes data
p_alluv_5P_firmicutes <-
  merge(p_alluv_5P_firmicutes, p_alluv_pathway_firmicutes, by = "alluvium")

# calculate ribbon heights
p_alluv_5P_firmicutes$height <- p_alluv_5P_firmicutes$ymax - p_alluv_5P_firmicutes$ymin
# restrict to class strata and ribbon heights
p_alluv_5P_firmicutes <- subset(p_alluv_5P_firmicutes, select = c(stratum, height))
# add heights within strata 
E1_5P_firmicutes <-aggregate(
  p_alluv_5P_firmicutes$height,
  by = subset(p_alluv_5P_firmicutes, select = stratum),
  FUN = sum
)

# filter to high protein and firmicutes
p_alluv_10P_firmicutes <-
  p_alluv[p_alluv$stratum == "10P" & p_alluv$fill == "#028cfb", ]
# remove (redundant) stratum column (to avoid confusion in merge)
p_alluv_10P_firmicutes <- subset(p_alluv_10P_firmicutes, select = -stratum)

# filter to pathway data for phylum
p_alluv_pathway_firmicutes <-
  p_alluv[p_alluv$x == 3 & p_alluv$fill == "#028cfb", ]
# select only alluvia (by which to merge) and class
p_alluv_pathway_firmicutes <- p_alluv_pathway_firmicutes[, c("alluvium", "stratum")]
# merge path data into 10P firmicutes data
p_alluv_10P_firmicutes <-
  merge(p_alluv_10P_firmicutes, p_alluv_pathway_firmicutes, by = "alluvium")

# calculate ribbon heights
p_alluv_10P_firmicutes$height <- p_alluv_10P_firmicutes$ymax - p_alluv_10P_firmicutes$ymin
# restrict to class strata and ribbon heights
p_alluv_10P_firmicutes <- subset(p_alluv_10P_firmicutes, select = c(stratum, height))
# add heights within strata (combine adult and child counts)
E1_10P_firmicutes <-aggregate(
  p_alluv_10P_firmicutes$height,
  by = subset(p_alluv_10P_firmicutes, select = stratum),
  FUN = sum
)

#export firmicutes data
E1_2.5P_firmicutes
E1_5P_firmicutes
E1_10P_firmicutes


####proteobacteria##############
# filter to low protein and proteobacteria
p_alluv_2.5P_proteobacteria <-
  p_alluv[p_alluv$stratum == "2.5P" & p_alluv$fill == "#bf329b", ]
# remove (redundant) stratum column (to avoid confusion in merge)
p_alluv_2.5P_proteobacteria <- subset(p_alluv_2.5P_proteobacteria, select = -stratum)

# filter to pathway data for phylum
p_alluv_pathway_proteobacteria <-
  p_alluv[p_alluv$x == 3 & p_alluv$fill == "#bf329b", ]
# select only alluvia (by which to merge) and class
p_alluv_pathway_proteobacteria <- p_alluv_pathway_proteobacteria[, c("alluvium", "stratum")]
# merge path data into 2.5P proteobacteria data
p_alluv_2.5P_proteobacteria <-
  merge(p_alluv_2.5P_proteobacteria, p_alluv_pathway_proteobacteria, by = "alluvium")

# calculate ribbon heights
p_alluv_2.5P_proteobacteria$height <- p_alluv_2.5P_proteobacteria$ymax - p_alluv_2.5P_proteobacteria$ymin
# restrict to class strata and ribbon heights
p_alluv_2.5P_proteobacteria <- subset(p_alluv_2.5P_proteobacteria, select = c(stratum, height))
# add heights within strata 
E1_2.5P_proteobacteria <- aggregate(
  p_alluv_2.5P_proteobacteria$height,
  by = subset(p_alluv_2.5P_proteobacteria, select = stratum),
  FUN = sum
)


# filter to medium protein and proteobacteria
p_alluv_5P_proteobacteria <-
  p_alluv[p_alluv$stratum == "5P" & p_alluv$fill == "#bf329b", ]
# remove (redundant) stratum column (to avoid confusion in merge)
p_alluv_5P_proteobacteria <- subset(p_alluv_5P_proteobacteria, select = -stratum)

# filter to pathway data for phylum
p_alluv_pathway_proteobacteria <-
  p_alluv[p_alluv$x == 3 & p_alluv$fill == "#bf329b", ]
# select only alluvia (by which to merge) and class
p_alluv_pathway_proteobacteria <- p_alluv_pathway_proteobacteria[, c("alluvium", "stratum")]
# merge path data into 5P proteobacteria data
p_alluv_5P_proteobacteria <-
  merge(p_alluv_5P_proteobacteria, p_alluv_pathway_proteobacteria, by = "alluvium")

# calculate ribbon heights
p_alluv_5P_proteobacteria$height <- p_alluv_5P_proteobacteria$ymax - p_alluv_5P_proteobacteria$ymin
# restrict to class strata and ribbon heights
p_alluv_5P_proteobacteria <- subset(p_alluv_5P_proteobacteria, select = c(stratum, height))
# add heights within strata 
E1_5P_proteobacteria <- aggregate(
  p_alluv_5P_proteobacteria$height,
  by = subset(p_alluv_5P_proteobacteria, select = stratum),
  FUN = sum
)

# filter to high protein and proteobacteria
p_alluv_10P_proteobacteria <-
  p_alluv[p_alluv$stratum == "10P" & p_alluv$fill == "#bf329b", ]
# remove (redundant) stratum column (to avoid confusion in merge)
p_alluv_10P_proteobacteria <- subset(p_alluv_10P_proteobacteria, select = -stratum)

# filter to pathway data for phylum
p_alluv_pathway_proteobacteria <-
  p_alluv[p_alluv$x == 3 & p_alluv$fill == "#bf329b", ]
# select only alluvia (by which to merge) and class
p_alluv_pathway_proteobacteria <- p_alluv_pathway_proteobacteria[, c("alluvium", "stratum")]
# merge path data into 10P proteobacteria data
p_alluv_10P_proteobacteria <-
  merge(p_alluv_10P_proteobacteria, p_alluv_pathway_proteobacteria, by = "alluvium")

# calculate ribbon heights
p_alluv_10P_proteobacteria$height <- p_alluv_10P_proteobacteria$ymax - p_alluv_10P_proteobacteria$ymin
# restrict to class strata and ribbon heights
p_alluv_10P_proteobacteria <- subset(p_alluv_10P_proteobacteria, select = c(stratum, height))
# add heights within strata (combine adult and child counts)
E1_10P_proteobacteria <- aggregate(
  p_alluv_10P_proteobacteria$height,
  by = subset(p_alluv_10P_proteobacteria, select = stratum),
  FUN = sum
)
#export proteobacteria data
E1_2.5P_proteobacteria
E1_5P_proteobacteria
E1_10P_proteobacteria

E1_2.5P_bacteroidetes

```


Sankey Plot E2 essential AAs
```{r}
E2_ESS_sankey <- ggplot(as.data.frame(E2_sankey),
       aes(y = Abundance, axis1 = phylum, axis2 = Percent_Protein, axis3 = pathway)) +
  geom_alluvium(aes(fill = Percent_Protein), width = 1/12)+
    geom_stratum(width = 1/12, fill = "black", color = "white") +
  geom_label(stat = "stratum", aes(label = after_stat(stratum))) +
  DietColors +
  scale_x_discrete(limits = c("phylum", "Percent_Protein", "pathway"), expand = c(.05, .05)) +
  #scale_fill_brewer(type = "qual", palette = "Set1") +
  ggtitle("SemiNatural Treatment: \n only med-high gapmind confidence scores") +
theme_bw() +
  theme(
    title =element_text(size=22, face='bold'),
    axis.text.x = element_text(color="black", size=14),
    axis.text.y = element_text(color="black", size=16),
    strip.text.y = element_text(color="black", size=16),
    legend.title = element_text(color="black", size=22),
    legend.text = element_text(color="black", size=16),
    legend.position = "right",
    strip.background = element_blank(), #to remove facet wrap title
    strip.text = element_text(size = 20),
    axis.title.x = element_text(color="black", size=22),
    axis.title.y = element_text(color="black", size=22, angle=90),
    panel.grid.major = element_blank(), # switch off major grid lines
   panel.grid.minor = element_blank(), # switch off minor grid lines
    panel.border = element_rect(colour = "black", fill=NA, size=.75)
  )
#CREATE A PDF AND SAVES IT TO THE RIGHT DIRECTORY/FOLDER. 
pdf("/Users/connermertz/Dropbox (vlab)/Conner Mertz/UNM biology/Chapter 1 E1 vs E2/Methods/Metagenomics/methods_DataAnalysis/Metagenomic Pipeline/Plots/SANKEY/General_By_Phylum/E2_byPhylum_overall_fill_Percent_Protein.pdf", height = 10, width =12)
E2_ESS_sankey
#dev.off()
 
```

E2 essential AAs measured for d13C with only med-high confidence scores
```{r}
E2_ESS_sankey <- ggplot(as.data.frame(E2_sankey),
       aes(y = Abundance, axis1 = phylum, axis2 = Percent_Protein, axis3 = pathway)) +
  geom_alluvium(aes(fill = phylum), width = 1/12)+
    geom_stratum(width = 1/12, fill = "black", color = "white") +
  geom_label(stat = "stratum", aes(label = after_stat(stratum))) +
  scale_x_discrete(limits = c("phylum", "Percent_Protein", "pathway"), expand = c(.05, .05)) +
  scale_fill_manual(values = phylumColor) +
  ggtitle("SemiNatural Treatment: ESSAA Sankey Plot \n including only med-high gapmind confidence scores") +
theme_bw() +
  theme(
    title =element_text(size=22, face='bold'),
    axis.text.x = element_text(color="black", size=14),
    axis.text.y = element_text(color="black", size=16),
    strip.text.y = element_text(color="black", size=16),
    legend.title = element_text(color="black", size=22),
    legend.text = element_text(color="black", size=16),
    legend.position = "right",
    strip.background = element_blank(), #to remove facet wrap title
    strip.text = element_text(size = 20),
    axis.title.x = element_text(color="black", size=22),
    axis.title.y = element_text(color="black", size=22, angle=90),
    panel.grid.major = element_blank(), # switch off major grid lines
   panel.grid.minor = element_blank(), # switch off minor grid lines
    panel.border = element_rect(colour = "black", fill=NA, size=.75)
  )
#CREATE A PDF AND SAVES IT TO THE RIGHT DIRECTORY/FOLDER. 
#pdf("/Users/connermertz/Dropbox (vlab)/Conner Mertz/UNM biology/Chapter 1 E1 vs E2/Methods/Metagenomics/methods_DataAnalysis/Metagenomic Pipeline/Plots/SANKEY/E2_ESS-Measure_med_high_overall_phylum.pdf", height = 10, width =12)
E2_ESS_sankey
#dev.off()
```

Calc Height of curved lines for E2
```{r}
# recover the built plot
p_build <- ggplot_build(E2_ESS_sankey)
# extract the data for the alluvium graphical objects
p_alluv <- p_build$data[[1L]]
# what are the fill colors
unique(p_alluv$fill)
#"#f37c37" "#028cfb" "#bf329b"
    #Bacteroidetes = "#f37c37",
    #Firmicutes = "#028cfb", 
    #Proteobacteria = "#bf329b",

####BACTEROIDETES##############
# filter to low protein and Bacteroidetes
p_alluv_2.5P_Bacteroidetes <-
  p_alluv[p_alluv$stratum == "2.5P" & p_alluv$fill == "#f37c37", ]
# remove (redundant) stratum column (to avoid confusion in merge)
p_alluv_2.5P_Bacteroidetes <- subset(p_alluv_2.5P_Bacteroidetes, select = -stratum)

# filter to pathway data for phylum
p_alluv_pathway_bacteroidetes <-
  p_alluv[p_alluv$x == 3 & p_alluv$fill == "#f37c37", ]
# select only alluvia (by which to merge) and class
p_alluv_pathway_bacteroidetes <- p_alluv_pathway_bacteroidetes[, c("alluvium", "stratum")]
# merge path data into 2.5P Bacteroidetes data
p_alluv_2.5P_Bacteroidetes <-
  merge(p_alluv_2.5P_Bacteroidetes, p_alluv_pathway_bacteroidetes, by = "alluvium")

# calculate ribbon heights
p_alluv_2.5P_Bacteroidetes$height <- p_alluv_2.5P_Bacteroidetes$ymax - p_alluv_2.5P_Bacteroidetes$ymin
# restrict to class strata and ribbon heights
p_alluv_2.5P_Bacteroidetes <- subset(p_alluv_2.5P_Bacteroidetes, select = c(stratum, height))
# add heights within strata 
E2_2.5P_bacteroidetes <- aggregate(
  p_alluv_2.5P_Bacteroidetes$height,
  by = subset(p_alluv_2.5P_Bacteroidetes, select = stratum),
  FUN = sum
)


# filter to medium protein and Bacteroidetes
p_alluv_5P_Bacteroidetes <-
  p_alluv[p_alluv$stratum == "5P" & p_alluv$fill == "#f37c37", ]
# remove (redundant) stratum column (to avoid confusion in merge)
p_alluv_5P_Bacteroidetes <- subset(p_alluv_5P_Bacteroidetes, select = -stratum)

# filter to pathway data for phylum
p_alluv_pathway_bacteroidetes <-
  p_alluv[p_alluv$x == 3 & p_alluv$fill == "#f37c37", ]
# select only alluvia (by which to merge) and class
p_alluv_pathway_bacteroidetes <- p_alluv_pathway_bacteroidetes[, c("alluvium", "stratum")]
# merge path data into 5P Bacteroidetes data
p_alluv_5P_Bacteroidetes <-
  merge(p_alluv_5P_Bacteroidetes, p_alluv_pathway_bacteroidetes, by = "alluvium")

# calculate ribbon heights
p_alluv_5P_Bacteroidetes$height <- p_alluv_5P_Bacteroidetes$ymax - p_alluv_5P_Bacteroidetes$ymin
# restrict to class strata and ribbon heights
p_alluv_5P_Bacteroidetes <- subset(p_alluv_5P_Bacteroidetes, select = c(stratum, height))
# add heights within strata 
E2_5P_bacteroidetes <-aggregate(
  p_alluv_5P_Bacteroidetes$height,
  by = subset(p_alluv_5P_Bacteroidetes, select = stratum),
  FUN = sum
)

# filter to high protein and Bacteroidetes
p_alluv_10P_Bacteroidetes <-
  p_alluv[p_alluv$stratum == "10P" & p_alluv$fill == "#f37c37", ]
# remove (redundant) stratum column (to avoid confusion in merge)
p_alluv_10P_Bacteroidetes <- subset(p_alluv_10P_Bacteroidetes, select = -stratum)

# filter to pathway data for phylum
p_alluv_pathway_bacteroidetes <-
  p_alluv[p_alluv$x == 3 & p_alluv$fill == "#f37c37", ]
# select only alluvia (by which to merge) and class
p_alluv_pathway_bacteroidetes <- p_alluv_pathway_bacteroidetes[, c("alluvium", "stratum")]
# merge path data into 10P Bacteroidetes data
p_alluv_10P_Bacteroidetes <-
  merge(p_alluv_10P_Bacteroidetes, p_alluv_pathway_bacteroidetes, by = "alluvium")

# calculate ribbon heights
p_alluv_10P_Bacteroidetes$height <- p_alluv_10P_Bacteroidetes$ymax - p_alluv_10P_Bacteroidetes$ymin
# restrict to class strata and ribbon heights
p_alluv_10P_Bacteroidetes <- subset(p_alluv_10P_Bacteroidetes, select = c(stratum, height))
# add heights within strata (combine adult and child counts)
E2_10P_bacteroidetes <-aggregate(
  p_alluv_10P_Bacteroidetes$height,
  by = subset(p_alluv_10P_Bacteroidetes, select = stratum),
  FUN = sum
)

####firmicutes##############
# filter to low protein and firmicutes
p_alluv_2.5P_firmicutes <-
  p_alluv[p_alluv$stratum == "2.5P" & p_alluv$fill == "#028cfb", ]
# remove (redundant) stratum column (to avoid confusion in merge)
p_alluv_2.5P_firmicutes <- subset(p_alluv_2.5P_firmicutes, select = -stratum)

# filter to pathway data for phylum
p_alluv_pathway_firmicutes <-
  p_alluv[p_alluv$x == 3 & p_alluv$fill == "#028cfb", ]
# select only alluvia (by which to merge) and class
p_alluv_pathway_firmicutes <- p_alluv_pathway_firmicutes[, c("alluvium", "stratum")]
# merge path data into 2.5P firmicutes data
p_alluv_2.5P_firmicutes <-
  merge(p_alluv_2.5P_firmicutes, p_alluv_pathway_firmicutes, by = "alluvium")

# calculate ribbon heights
p_alluv_2.5P_firmicutes$height <- p_alluv_2.5P_firmicutes$ymax - p_alluv_2.5P_firmicutes$ymin
# restrict to class strata and ribbon heights
p_alluv_2.5P_firmicutes <- subset(p_alluv_2.5P_firmicutes, select = c(stratum, height))
# add heights within strata 
E2_2.5P_firmicutes <- aggregate(
  p_alluv_2.5P_firmicutes$height,
  by = subset(p_alluv_2.5P_firmicutes, select = stratum),
  FUN = sum
)


# filter to medium protein and firmicutes
p_alluv_5P_firmicutes <-
  p_alluv[p_alluv$stratum == "5P" & p_alluv$fill == "#028cfb", ]
# remove (redundant) stratum column (to avoid confusion in merge)
p_alluv_5P_firmicutes <- subset(p_alluv_5P_firmicutes, select = -stratum)

# filter to pathway data for phylum
p_alluv_pathway_firmicutes <-
  p_alluv[p_alluv$x == 3 & p_alluv$fill == "#028cfb", ]
# select only alluvia (by which to merge) and class
p_alluv_pathway_firmicutes <- p_alluv_pathway_firmicutes[, c("alluvium", "stratum")]
# merge path data into 5P firmicutes data
p_alluv_5P_firmicutes <-
  merge(p_alluv_5P_firmicutes, p_alluv_pathway_firmicutes, by = "alluvium")

# calculate ribbon heights
p_alluv_5P_firmicutes$height <- p_alluv_5P_firmicutes$ymax - p_alluv_5P_firmicutes$ymin
# restrict to class strata and ribbon heights
p_alluv_5P_firmicutes <- subset(p_alluv_5P_firmicutes, select = c(stratum, height))
# add heights within strata 
E2_5P_firmicutes <-aggregate(
  p_alluv_5P_firmicutes$height,
  by = subset(p_alluv_5P_firmicutes, select = stratum),
  FUN = sum
)

# filter to high protein and firmicutes
p_alluv_10P_firmicutes <-
  p_alluv[p_alluv$stratum == "10P" & p_alluv$fill == "#028cfb", ]
# remove (redundant) stratum column (to avoid confusion in merge)
p_alluv_10P_firmicutes <- subset(p_alluv_10P_firmicutes, select = -stratum)

# filter to pathway data for phylum
p_alluv_pathway_firmicutes <-
  p_alluv[p_alluv$x == 3 & p_alluv$fill == "#028cfb", ]
# select only alluvia (by which to merge) and class
p_alluv_pathway_firmicutes <- p_alluv_pathway_firmicutes[, c("alluvium", "stratum")]
# merge path data into 10P firmicutes data
p_alluv_10P_firmicutes <-
  merge(p_alluv_10P_firmicutes, p_alluv_pathway_firmicutes, by = "alluvium")

# calculate ribbon heights
p_alluv_10P_firmicutes$height <- p_alluv_10P_firmicutes$ymax - p_alluv_10P_firmicutes$ymin
# restrict to class strata and ribbon heights
p_alluv_10P_firmicutes <- subset(p_alluv_10P_firmicutes, select = c(stratum, height))
# add heights within strata (combine adult and child counts)
E2_10P_firmicutes <-aggregate(
  p_alluv_10P_firmicutes$height,
  by = subset(p_alluv_10P_firmicutes, select = stratum),
  FUN = sum
)



####proteobacteria##############
# filter to low protein and proteobacteria
p_alluv_2.5P_proteobacteria <-
  p_alluv[p_alluv$stratum == "2.5P" & p_alluv$fill == "#bf329b", ]
# remove (redundant) stratum column (to avoid confusion in merge)
p_alluv_2.5P_proteobacteria <- subset(p_alluv_2.5P_proteobacteria, select = -stratum)

# filter to pathway data for phylum
p_alluv_pathway_proteobacteria <-
  p_alluv[p_alluv$x == 3 & p_alluv$fill == "#bf329b", ]
# select only alluvia (by which to merge) and class
p_alluv_pathway_proteobacteria <- p_alluv_pathway_proteobacteria[, c("alluvium", "stratum")]
# merge path data into 2.5P proteobacteria data
p_alluv_2.5P_proteobacteria <-
  merge(p_alluv_2.5P_proteobacteria, p_alluv_pathway_proteobacteria, by = "alluvium")

# calculate ribbon heights
p_alluv_2.5P_proteobacteria$height <- p_alluv_2.5P_proteobacteria$ymax - p_alluv_2.5P_proteobacteria$ymin
# restrict to class strata and ribbon heights
p_alluv_2.5P_proteobacteria <- subset(p_alluv_2.5P_proteobacteria, select = c(stratum, height))
# add heights within strata 
E2_2.5P_proteobacteria <- aggregate(
  p_alluv_2.5P_proteobacteria$height,
  by = subset(p_alluv_2.5P_proteobacteria, select = stratum),
  FUN = sum
)


# filter to medium protein and proteobacteria
p_alluv_5P_proteobacteria <-
  p_alluv[p_alluv$stratum == "5P" & p_alluv$fill == "#bf329b", ]
# remove (redundant) stratum column (to avoid confusion in merge)
p_alluv_5P_proteobacteria <- subset(p_alluv_5P_proteobacteria, select = -stratum)

# filter to pathway data for phylum
p_alluv_pathway_proteobacteria <-
  p_alluv[p_alluv$x == 3 & p_alluv$fill == "#bf329b", ]
# select only alluvia (by which to merge) and class
p_alluv_pathway_proteobacteria <- p_alluv_pathway_proteobacteria[, c("alluvium", "stratum")]
# merge path data into 5P proteobacteria data
p_alluv_5P_proteobacteria <-
  merge(p_alluv_5P_proteobacteria, p_alluv_pathway_proteobacteria, by = "alluvium")

# calculate ribbon heights
p_alluv_5P_proteobacteria$height <- p_alluv_5P_proteobacteria$ymax - p_alluv_5P_proteobacteria$ymin
# restrict to class strata and ribbon heights
p_alluv_5P_proteobacteria <- subset(p_alluv_5P_proteobacteria, select = c(stratum, height))
# add heights within strata 
E2_5P_proteobacteria <- aggregate(
  p_alluv_5P_proteobacteria$height,
  by = subset(p_alluv_5P_proteobacteria, select = stratum),
  FUN = sum
)

# filter to high protein and proteobacteria
p_alluv_10P_proteobacteria <-
  p_alluv[p_alluv$stratum == "10P" & p_alluv$fill == "#bf329b", ]
# remove (redundant) stratum column (to avoid confusion in merge)
p_alluv_10P_proteobacteria <- subset(p_alluv_10P_proteobacteria, select = -stratum)

# filter to pathway data for phylum
p_alluv_pathway_proteobacteria <-
  p_alluv[p_alluv$x == 3 & p_alluv$fill == "#bf329b", ]
# select only alluvia (by which to merge) and class
p_alluv_pathway_proteobacteria <- p_alluv_pathway_proteobacteria[, c("alluvium", "stratum")]
# merge path data into 10P proteobacteria data
p_alluv_10P_proteobacteria <-
  merge(p_alluv_10P_proteobacteria, p_alluv_pathway_proteobacteria, by = "alluvium")

# calculate ribbon heights
p_alluv_10P_proteobacteria$height <- p_alluv_10P_proteobacteria$ymax - p_alluv_10P_proteobacteria$ymin
# restrict to class strata and ribbon heights
p_alluv_10P_proteobacteria <- subset(p_alluv_10P_proteobacteria, select = c(stratum, height))
# add heights within strata (combine adult and child counts)
E2_10P_proteobacteria <- aggregate(
  p_alluv_10P_proteobacteria$height,
  by = subset(p_alluv_10P_proteobacteria, select = stratum),
  FUN = sum
)




#export bacteroidetes data
E2_2.5P_bacteroidetes
E2_5P_bacteroidetes
E2_10P_bacteroidetes

#export firmicutes data
E2_2.5P_firmicutes
E2_5P_firmicutes
E2_10P_firmicutes

#export proteobacteria data
E2_2.5P_proteobacteria
E2_5P_proteobacteria
E2_10P_proteobacteria
```









Now lets look at each phylum in more depth
```{r}
#filter out phylum of interest in E1
E1_sankey_bacteroidetes <- E1_sankey %>% filter(phylum== "Bacteroidetes") #keep only bacteroidetes
E1_sankey_bacteroidetes <- E1_sankey_bacteroidetes %>% filter(family!= "no_support") #remove family with no support
  E1_sankey_bacteroidetes_2.5P <- E1_sankey_bacteroidetes %>% filter(Percent_Protein== "2.5P") #filter        percent_Protein
  E1_sankey_bacteroidetes_5P <- E1_sankey_bacteroidetes %>% filter(Percent_Protein== "5P") #filter percent_Protein
  E1_sankey_bacteroidetes_2.5P <- E1_sankey_bacteroidetes %>% filter(Percent_Protein== "2.5P") #filter percent_Protein
  E1_sankey_bacteroidetes_10P <- E1_sankey_bacteroidetes %>% filter(Percent_Protein== "10P") #filter percent_Protein

#filter out phylum of interest in E1
E1_sankey_firmicutes <- E1_sankey %>% filter(phylum== "Firmicutes") #keep only bacteroidetes
E1_sankey_firmicutes <- E1_sankey_firmicutes %>% filter(family!= "no_support") #remove family with no support
  E1_sankey_firmicutes_2.5P <- E1_sankey_firmicutes %>% filter(Percent_Protein== "2.5P") #filter percent_Protein
  E1_sankey_firmicutes_5P <- E1_sankey_firmicutes %>% filter(Percent_Protein== "5P") #filter percent_Protein
  E1_sankey_firmicutes_10P <- E1_sankey_firmicutes %>% filter(Percent_Protein== "10P") #filter percent_Protein

#filter out phylum of interest in E1
E1_sankey_proteobacteria <- E1_sankey %>% filter(phylum== "Proteobacteria") #keep only bacteroidetes
E1_sankey_proteobacteria <- E1_sankey_proteobacteria %>% filter(family!= "no_support") #remove family with no support
  E1_sankey_proteobacteria_2.5P <- E1_sankey_proteobacteria %>% filter(Percent_Protein== "2.5P") #filter percent_Protein
  E1_sankey_proteobacteria_5P <- E1_sankey_proteobacteria %>% filter(Percent_Protein== "5P") #filter percent_Protein
  E1_sankey_proteobacteria_10P <- E1_sankey_proteobacteria %>% filter(Percent_Protein== "10P") #filter percent_Protein


```

########E1#############
Bacteroidetes

E1_Bacteroidetes overall for paper by pathway
```{r}
#Plot em
#E1 bacteroidetes overall for paper
E1_bacteroidetes <- ggplot(as.data.frame(E1_sankey_bacteroidetes),
       aes(y = Abundance, axis1 = family, axis2 = Percent_Protein, axis3 = pathway)) +
  geom_alluvium(aes(fill = pathway), width = 1/12)+
    geom_stratum(width = 1/12, fill = "black", color = "white") +
  geom_label(stat = "stratum", aes(label = after_stat(stratum))) +
  scale_x_discrete(limits = c("family", "Percent_Protein", "pathway"), expand = c(.05, .05)) +
scale_fill_manual(values = ESS_pathwayColor) +
  ggtitle("Synthetic Treatment: Phylum Bacteroidetes \n only med-high gapmind confidence scores") +
theme_bw() +
  theme(
    title =element_text(size=22, face='bold'),
    axis.text.x = element_text(color="black", size=14),
    axis.text.y = element_text(color="black", size=16),
    strip.text.y = element_text(color="black", size=16),
    legend.title = element_text(color="black", size=22),
    legend.text = element_text(color="black", size=16),
    legend.position = "right",
    strip.background = element_blank(), #to remove facet wrap title
    strip.text = element_text(size = 20),
    axis.title.x = element_text(color="black", size=22),
    axis.title.y = element_text(color="black", size=22, angle=90),
    panel.grid.major = element_blank(), # switch off major grid lines
   panel.grid.minor = element_blank(), # switch off minor grid lines
    panel.border = element_rect(colour = "black", fill=NA, size=.75)
  )
#CREATE A PDF AND SAVES IT TO THE RIGHT DIRECTORY/FOLDER. 
pdf("/Users/connermertz/Dropbox (vlab)/Conner Mertz/UNM biology/Chapter 1 E1 vs E2/Methods/Metagenomics/methods_DataAnalysis/Metagenomic Pipeline/Plots/SANKEY/Bacteroidetes/E1_Bacteroidetes/E1_bacteroidetes_alldiets.pdf", height = 12, width = 16)
E1_bacteroidetes
dev.off()
```

E1_Bacteroidetes overall for paper by family
```{r}
#Plot em
#E1 bacteroidetes overall for paper
E1_bacteroidetes <- ggplot(as.data.frame(E1_sankey_bacteroidetes),
       aes(y = Abundance, axis1 = family, axis2 = Percent_Protein, axis3 = pathway)) +
  geom_alluvium(aes(fill = family), width = 1/12)+
    geom_stratum(width = 1/12, fill = "black", color = "white") +
  geom_label(stat = "stratum", aes(label = after_stat(stratum))) +
  scale_x_discrete(limits = c("family", "Percent_Protein", "pathway"), expand = c(.05, .05)) +
scale_fill_manual(values = familyColor) +
  ggtitle("Synthetic Treatment: Phylum Bacteroidetes \n only med-high gapmind confidence scores") +
theme_bw() +
  theme(
    title =element_text(size=22, face='bold'),
    axis.text.x = element_text(color="black", size=14),
    axis.text.y = element_text(color="black", size=16),
    strip.text.y = element_text(color="black", size=16),
    legend.title = element_text(color="black", size=22),
    legend.text = element_text(color="black", size=16),
    legend.position = "right",
    strip.background = element_blank(), #to remove facet wrap title
    strip.text = element_text(size = 20),
    axis.title.x = element_text(color="black", size=22),
    axis.title.y = element_text(color="black", size=22, angle=90),
    panel.grid.major = element_blank(), # switch off major grid lines
   panel.grid.minor = element_blank(), # switch off minor grid lines
    panel.border = element_rect(colour = "black", fill=NA, size=.75)
  )
#CREATE A PDF AND SAVES IT TO THE RIGHT DIRECTORY/FOLDER. 
#pdf("/Users/connermertz/Dropbox (vlab)/Conner Mertz/UNM biology/Chapter 1 E1 vs E2/Methods/Metagenomics/methods_DataAnalysis/Metagenomic Pipeline/Plots/SANKEY/Bacteroidetes/E1_Bacteroidetes/E1_bacteroidetes_alldiets_family_steps.pdf", height = 12, width = 16)
E1_bacteroidetes
#dev.off()
```

Lets export the curve heights for each family belonging to phylum Bacteroidetes by diet in E1
```{r}
# recover the built plot
p_build <- ggplot_build(E1_bacteroidetes)
# extract the data for the alluvium graphical objects
p_alluv <- p_build$data[[1L]]
# what are the fill colors
unique(p_alluv$fill)
#"#00226b" "#85003d" "#01b1f4" "#b35a58" "#54b543"
    #familyColor <- c(Bacteroidaceae= "#00226b",
                      #Muribaculaceae= "#85003d",
                      #Porphyromonadaceae= "#01b1f4",
                      #Rikenellaceae= "#b35a58",
                      #Tannerellaceae= "#54b543")


# filter to low protein and Bacteroidaceae
p_alluv_2.5P_Bacteroidaceae <-
  p_alluv[p_alluv$stratum == "2.5P" & p_alluv$fill == "#00226b", ]
# remove (redundant) stratum column (to avoid confusion in merge)
p_alluv_2.5P_Bacteroidaceae <- subset(p_alluv_2.5P_Bacteroidaceae, select = -stratum)

# filter to pathway data for phylum
p_alluv_pathway_Bacteroidaceae <-
  p_alluv[p_alluv$x == 3 & p_alluv$fill == "#00226b", ]
# select only alluvia (by which to merge) and class
p_alluv_pathway_Bacteroidaceae <- p_alluv_pathway_Bacteroidaceae[, c("alluvium", "stratum")]
# merge path data into 2.5P Bacteroidaceae data
p_alluv_2.5P_Bacteroidaceae <-
  merge(p_alluv_2.5P_Bacteroidaceae, p_alluv_pathway_Bacteroidaceae, by = "alluvium")

# calculate ribbon heights
p_alluv_2.5P_Bacteroidaceae$height <- p_alluv_2.5P_Bacteroidaceae$ymax - p_alluv_2.5P_Bacteroidaceae$ymin
# restrict to class strata and ribbon heights
p_alluv_2.5P_Bacteroidaceae <- subset(p_alluv_2.5P_Bacteroidaceae, select = c(stratum, height))
# add heights within strata 
E1_2.5P_Bacteroidaceae <- aggregate(
  p_alluv_2.5P_Bacteroidaceae$height,
  by = subset(p_alluv_2.5P_Bacteroidaceae, select = stratum),
  FUN = sum
)


# filter to medium protein and Bacteroidaceae
p_alluv_5P_Bacteroidaceae <-
  p_alluv[p_alluv$stratum == "5P" & p_alluv$fill == "#00226b", ]
# remove (redundant) stratum column (to avoid confusion in merge)
p_alluv_5P_Bacteroidaceae <- subset(p_alluv_5P_Bacteroidaceae, select = -stratum)

# filter to pathway data for phylum
p_alluv_pathway_Bacteroidaceae <-
  p_alluv[p_alluv$x == 3 & p_alluv$fill == "#00226b", ]
# select only alluvia (by which to merge) and class
p_alluv_pathway_Bacteroidaceae <- p_alluv_pathway_Bacteroidaceae[, c("alluvium", "stratum")]
# merge path data into 5P Bacteroidaceae data
p_alluv_5P_Bacteroidaceae <-
  merge(p_alluv_5P_Bacteroidaceae, p_alluv_pathway_Bacteroidaceae, by = "alluvium")

# calculate ribbon heights
p_alluv_5P_Bacteroidaceae$height <- p_alluv_5P_Bacteroidaceae$ymax - p_alluv_5P_Bacteroidaceae$ymin
# restrict to class strata and ribbon heights
p_alluv_5P_Bacteroidaceae <- subset(p_alluv_5P_Bacteroidaceae, select = c(stratum, height))
# add heights within strata 
E1_5P_Bacteroidaceae <-aggregate(
  p_alluv_5P_Bacteroidaceae$height,
  by = subset(p_alluv_5P_Bacteroidaceae, select = stratum),
  FUN = sum
)

# filter to high protein and Bacteroidaceae
p_alluv_10P_Bacteroidaceae <-
  p_alluv[p_alluv$stratum == "10P" & p_alluv$fill == "#00226b", ]
# remove (redundant) stratum column (to avoid confusion in merge)
p_alluv_10P_Bacteroidaceae <- subset(p_alluv_10P_Bacteroidaceae, select = -stratum)

# filter to pathway data for phylum
p_alluv_pathway_Bacteroidaceae <-
  p_alluv[p_alluv$x == 3 & p_alluv$fill == "#00226b", ]
# select only alluvia (by which to merge) and class
p_alluv_pathway_Bacteroidaceae <- p_alluv_pathway_Bacteroidaceae[, c("alluvium", "stratum")]
# merge path data into 10P Bacteroidaceae data
p_alluv_10P_Bacteroidaceae <-
  merge(p_alluv_10P_Bacteroidaceae, p_alluv_pathway_Bacteroidaceae, by = "alluvium")

# calculate ribbon heights
p_alluv_10P_Bacteroidaceae$height <- p_alluv_10P_Bacteroidaceae$ymax - p_alluv_10P_Bacteroidaceae$ymin
# restrict to class strata and ribbon heights
p_alluv_10P_Bacteroidaceae <- subset(p_alluv_10P_Bacteroidaceae, select = c(stratum, height))
# add heights within strata (combine adult and child counts)
E1_10P_Bacteroidaceae <-aggregate(
  p_alluv_10P_Bacteroidaceae$height,
  by = subset(p_alluv_10P_Bacteroidaceae, select = stratum),
  FUN = sum
)

#Export_Bacteroidacea
E1_2.5P_Bacteroidaceae
E1_5P_Bacteroidaceae
E1_10P_Bacteroidaceae


####Family##############
# filter to low protein and Muribaculaceae
p_alluv_2.5P_Muribaculaceae <-
  p_alluv[p_alluv$stratum == "2.5P" & p_alluv$fill == "#85003d", ]
# remove (redundant) stratum column (to avoid confusion in merge)
p_alluv_2.5P_Muribaculaceae <- subset(p_alluv_2.5P_Muribaculaceae, select = -stratum)

# filter to pathway data for phylum
p_alluv_pathway_Muribaculaceae <-
  p_alluv[p_alluv$x == 3 & p_alluv$fill == "#85003d", ]
# select only alluvia (by which to merge) and class
p_alluv_pathway_Muribaculaceae <- p_alluv_pathway_Muribaculaceae[, c("alluvium", "stratum")]
# merge path data into 2.5P Muribaculaceae data
p_alluv_2.5P_Muribaculaceae <-
  merge(p_alluv_2.5P_Muribaculaceae, p_alluv_pathway_Muribaculaceae, by = "alluvium")

# calculate ribbon heights
p_alluv_2.5P_Muribaculaceae$height <- p_alluv_2.5P_Muribaculaceae$ymax - p_alluv_2.5P_Muribaculaceae$ymin
# restrict to class strata and ribbon heights
p_alluv_2.5P_Muribaculaceae <- subset(p_alluv_2.5P_Muribaculaceae, select = c(stratum, height))
# add heights within strata 
E1_2.5P_Muribaculaceae <- aggregate(
  p_alluv_2.5P_Muribaculaceae$height,
  by = subset(p_alluv_2.5P_Muribaculaceae, select = stratum),
  FUN = sum
)


# filter to medium protein and Muribaculaceae
p_alluv_5P_Muribaculaceae <-
  p_alluv[p_alluv$stratum == "5P" & p_alluv$fill == "#85003d", ]
# remove (redundant) stratum column (to avoid confusion in merge)
p_alluv_5P_Muribaculaceae <- subset(p_alluv_5P_Muribaculaceae, select = -stratum)

# filter to pathway data for phylum
p_alluv_pathway_Muribaculaceae <-
  p_alluv[p_alluv$x == 3 & p_alluv$fill == "#85003d", ]
# select only alluvia (by which to merge) and class
p_alluv_pathway_Muribaculaceae <- p_alluv_pathway_Muribaculaceae[, c("alluvium", "stratum")]
# merge path data into 5P Muribaculaceae data
p_alluv_5P_Muribaculaceae <-
  merge(p_alluv_5P_Muribaculaceae, p_alluv_pathway_Muribaculaceae, by = "alluvium")

# calculate ribbon heights
p_alluv_5P_Muribaculaceae$height <- p_alluv_5P_Muribaculaceae$ymax - p_alluv_5P_Muribaculaceae$ymin
# restrict to class strata and ribbon heights
p_alluv_5P_Muribaculaceae <- subset(p_alluv_5P_Muribaculaceae, select = c(stratum, height))
# add heights within strata 
E1_5P_Muribaculaceae <-aggregate(
  p_alluv_5P_Muribaculaceae$height,
  by = subset(p_alluv_5P_Muribaculaceae, select = stratum),
  FUN = sum
)

# filter to high protein and Muribaculaceae
p_alluv_10P_Muribaculaceae <-
  p_alluv[p_alluv$stratum == "10P" & p_alluv$fill == "#85003d", ]
# remove (redundant) stratum column (to avoid confusion in merge)
p_alluv_10P_Muribaculaceae <- subset(p_alluv_10P_Muribaculaceae, select = -stratum)

# filter to pathway data for phylum
p_alluv_pathway_Muribaculaceae <-
  p_alluv[p_alluv$x == 3 & p_alluv$fill == "#85003d", ]
# select only alluvia (by which to merge) and class
p_alluv_pathway_Muribaculaceae <- p_alluv_pathway_Muribaculaceae[, c("alluvium", "stratum")]
# merge path data into 10P Muribaculaceae data
p_alluv_10P_Muribaculaceae <-
  merge(p_alluv_10P_Muribaculaceae, p_alluv_pathway_Muribaculaceae, by = "alluvium")

# calculate ribbon heights
p_alluv_10P_Muribaculaceae$height <- p_alluv_10P_Muribaculaceae$ymax - p_alluv_10P_Muribaculaceae$ymin
# restrict to class strata and ribbon heights
p_alluv_10P_Muribaculaceae <- subset(p_alluv_10P_Muribaculaceae, select = c(stratum, height))
# add heights within strata (combine adult and child counts)
E1_10P_Muribaculaceae <-aggregate(
  p_alluv_10P_Muribaculaceae$height,
  by = subset(p_alluv_10P_Muribaculaceae, select = stratum),
  FUN = sum
)

#Export_Muribaculaceae
E1_2.5P_Muribaculaceae
E1_5P_Muribaculaceae
E1_10P_Muribaculaceae

####Family##############
# filter to low protein and Porphyromonadaceae
p_alluv_2.5P_Porphyromonadaceae <-
  p_alluv[p_alluv$stratum == "2.5P" & p_alluv$fill == "#01b1f4", ]
# remove (redundant) stratum column (to avoid confusion in merge)
p_alluv_2.5P_Porphyromonadaceae <- subset(p_alluv_2.5P_Porphyromonadaceae, select = -stratum)

# filter to pathway data for phylum
p_alluv_pathway_Porphyromonadaceae <-
  p_alluv[p_alluv$x == 3 & p_alluv$fill == "#01b1f4", ]
# select only alluvia (by which to merge) and class
p_alluv_pathway_Porphyromonadaceae <- p_alluv_pathway_Porphyromonadaceae[, c("alluvium", "stratum")]
# merge path data into 2.5P Porphyromonadaceae data
p_alluv_2.5P_Porphyromonadaceae <-
  merge(p_alluv_2.5P_Porphyromonadaceae, p_alluv_pathway_Porphyromonadaceae, by = "alluvium")

# calculate ribbon heights
p_alluv_2.5P_Porphyromonadaceae$height <- p_alluv_2.5P_Porphyromonadaceae$ymax - p_alluv_2.5P_Porphyromonadaceae$ymin
# restrict to class strata and ribbon heights
p_alluv_2.5P_Porphyromonadaceae <- subset(p_alluv_2.5P_Porphyromonadaceae, select = c(stratum, height))
# add heights within strata 
E1_2.5P_Porphyromonadaceae <- aggregate(
  p_alluv_2.5P_Porphyromonadaceae$height,
  by = subset(p_alluv_2.5P_Porphyromonadaceae, select = stratum),
  FUN = sum
)


# filter to medium protein and Porphyromonadaceae
p_alluv_5P_Porphyromonadaceae <-
  p_alluv[p_alluv$stratum == "5P" & p_alluv$fill == "#01b1f4", ]
# remove (redundant) stratum column (to avoid confusion in merge)
p_alluv_5P_Porphyromonadaceae <- subset(p_alluv_5P_Porphyromonadaceae, select = -stratum)

# filter to pathway data for phylum
p_alluv_pathway_Porphyromonadaceae <-
  p_alluv[p_alluv$x == 3 & p_alluv$fill == "#01b1f4", ]
# select only alluvia (by which to merge) and class
p_alluv_pathway_Porphyromonadaceae <- p_alluv_pathway_Porphyromonadaceae[, c("alluvium", "stratum")]
# merge path data into 5P Porphyromonadaceae data
p_alluv_5P_Porphyromonadaceae <-
  merge(p_alluv_5P_Porphyromonadaceae, p_alluv_pathway_Porphyromonadaceae, by = "alluvium")

# calculate ribbon heights
p_alluv_5P_Porphyromonadaceae$height <- p_alluv_5P_Porphyromonadaceae$ymax - p_alluv_5P_Porphyromonadaceae$ymin
# restrict to class strata and ribbon heights
p_alluv_5P_Porphyromonadaceae <- subset(p_alluv_5P_Porphyromonadaceae, select = c(stratum, height))
# add heights within strata 
E1_5P_Porphyromonadaceae <-aggregate(
  p_alluv_5P_Porphyromonadaceae$height,
  by = subset(p_alluv_5P_Porphyromonadaceae, select = stratum),
  FUN = sum
)

# filter to high protein and Porphyromonadaceae
p_alluv_10P_Porphyromonadaceae <-
  p_alluv[p_alluv$stratum == "10P" & p_alluv$fill == "#01b1f4", ]
# remove (redundant) stratum column (to avoid confusion in merge)
p_alluv_10P_Porphyromonadaceae <- subset(p_alluv_10P_Porphyromonadaceae, select = -stratum)

# filter to pathway data for phylum
p_alluv_pathway_Porphyromonadaceae <-
  p_alluv[p_alluv$x == 3 & p_alluv$fill == "#01b1f4", ]
# select only alluvia (by which to merge) and class
p_alluv_pathway_Porphyromonadaceae <- p_alluv_pathway_Porphyromonadaceae[, c("alluvium", "stratum")]
# merge path data into 10P Porphyromonadaceae data
p_alluv_10P_Porphyromonadaceae <-
  merge(p_alluv_10P_Porphyromonadaceae, p_alluv_pathway_Porphyromonadaceae, by = "alluvium")

# calculate ribbon heights
p_alluv_10P_Porphyromonadaceae$height <- p_alluv_10P_Porphyromonadaceae$ymax - p_alluv_10P_Porphyromonadaceae$ymin
# restrict to class strata and ribbon heights
p_alluv_10P_Porphyromonadaceae <- subset(p_alluv_10P_Porphyromonadaceae, select = c(stratum, height))
# add heights within strata (combine adult and child counts)
E1_10P_Porphyromonadaceae <-aggregate(
  p_alluv_10P_Porphyromonadaceae$height,
  by = subset(p_alluv_10P_Porphyromonadaceae, select = stratum),
  FUN = sum
)

#Export_Porphyromonadaceae
E1_2.5P_Porphyromonadaceae
E1_5P_Porphyromonadaceae
E1_10P_Porphyromonadaceae


####Family##############
# filter to low protein and Rikenellaceae
p_alluv_2.5P_Rikenellaceae <-
  p_alluv[p_alluv$stratum == "2.5P" & p_alluv$fill == "#b35a58", ]
# remove (redundant) stratum column (to avoid confusion in merge)
p_alluv_2.5P_Rikenellaceae <- subset(p_alluv_2.5P_Rikenellaceae, select = -stratum)

# filter to pathway data for phylum
p_alluv_pathway_Rikenellaceae <-
  p_alluv[p_alluv$x == 3 & p_alluv$fill == "#b35a58", ]
# select only alluvia (by which to merge) and class
p_alluv_pathway_Rikenellaceae <- p_alluv_pathway_Rikenellaceae[, c("alluvium", "stratum")]
# merge path data into 2.5P Rikenellaceae data
p_alluv_2.5P_Rikenellaceae <-
  merge(p_alluv_2.5P_Rikenellaceae, p_alluv_pathway_Rikenellaceae, by = "alluvium")

# calculate ribbon heights
p_alluv_2.5P_Rikenellaceae$height <- p_alluv_2.5P_Rikenellaceae$ymax - p_alluv_2.5P_Rikenellaceae$ymin
# restrict to class strata and ribbon heights
p_alluv_2.5P_Rikenellaceae <- subset(p_alluv_2.5P_Rikenellaceae, select = c(stratum, height))
# add heights within strata 
E1_2.5P_Rikenellaceae <- aggregate(
  p_alluv_2.5P_Rikenellaceae$height,
  by = subset(p_alluv_2.5P_Rikenellaceae, select = stratum),
  FUN = sum
)


# filter to medium protein and Rikenellaceae
p_alluv_5P_Rikenellaceae <-
  p_alluv[p_alluv$stratum == "5P" & p_alluv$fill == "#b35a58", ]
# remove (redundant) stratum column (to avoid confusion in merge)
p_alluv_5P_Rikenellaceae <- subset(p_alluv_5P_Rikenellaceae, select = -stratum)

# filter to pathway data for phylum
p_alluv_pathway_Rikenellaceae <-
  p_alluv[p_alluv$x == 3 & p_alluv$fill == "#b35a58", ]
# select only alluvia (by which to merge) and class
p_alluv_pathway_Rikenellaceae <- p_alluv_pathway_Rikenellaceae[, c("alluvium", "stratum")]
# merge path data into 5P Rikenellaceae data
p_alluv_5P_Rikenellaceae <-
  merge(p_alluv_5P_Rikenellaceae, p_alluv_pathway_Rikenellaceae, by = "alluvium")

# calculate ribbon heights
p_alluv_5P_Rikenellaceae$height <- p_alluv_5P_Rikenellaceae$ymax - p_alluv_5P_Rikenellaceae$ymin
# restrict to class strata and ribbon heights
p_alluv_5P_Rikenellaceae <- subset(p_alluv_5P_Rikenellaceae, select = c(stratum, height))
# add heights within strata 
E1_5P_Rikenellaceae <-aggregate(
  p_alluv_5P_Rikenellaceae$height,
  by = subset(p_alluv_5P_Rikenellaceae, select = stratum),
  FUN = sum
)

# filter to high protein and Rikenellaceae
p_alluv_10P_Rikenellaceae <-
  p_alluv[p_alluv$stratum == "10P" & p_alluv$fill == "#b35a58", ]
# remove (redundant) stratum column (to avoid confusion in merge)
p_alluv_10P_Rikenellaceae <- subset(p_alluv_10P_Rikenellaceae, select = -stratum)

# filter to pathway data for phylum
p_alluv_pathway_Rikenellaceae <-
  p_alluv[p_alluv$x == 3 & p_alluv$fill == "#b35a58", ]
# select only alluvia (by which to merge) and class
p_alluv_pathway_Rikenellaceae <- p_alluv_pathway_Rikenellaceae[, c("alluvium", "stratum")]
# merge path data into 10P Rikenellaceae data
p_alluv_10P_Rikenellaceae <-
  merge(p_alluv_10P_Rikenellaceae, p_alluv_pathway_Rikenellaceae, by = "alluvium")

# calculate ribbon heights
p_alluv_10P_Rikenellaceae$height <- p_alluv_10P_Rikenellaceae$ymax - p_alluv_10P_Rikenellaceae$ymin
# restrict to class strata and ribbon heights
p_alluv_10P_Rikenellaceae <- subset(p_alluv_10P_Rikenellaceae, select = c(stratum, height))
# add heights within strata (combine adult and child counts)
E1_10P_Rikenellaceae <-aggregate(
  p_alluv_10P_Rikenellaceae$height,
  by = subset(p_alluv_10P_Rikenellaceae, select = stratum),
  FUN = sum
)

#Export_Rikenellaceae
E1_2.5P_Rikenellaceae
E1_5P_Rikenellaceae
E1_10P_Rikenellaceae


# filter to low protein and Tannerellaceae
p_alluv_2.5P_Tannerellaceae <-
  p_alluv[p_alluv$stratum == "2.5P" & p_alluv$fill == "#54b543", ]
# remove (redundant) stratum column (to avoid confusion in merge)
p_alluv_2.5P_Tannerellaceae <- subset(p_alluv_2.5P_Tannerellaceae, select = -stratum)

# filter to pathway data for phylum
p_alluv_pathway_Tannerellaceae <-
  p_alluv[p_alluv$x == 3 & p_alluv$fill == "#54b543", ]
# select only alluvia (by which to merge) and class
p_alluv_pathway_Tannerellaceae <- p_alluv_pathway_Tannerellaceae[, c("alluvium", "stratum")]
# merge path data into 2.5P Tannerellaceae data
p_alluv_2.5P_Tannerellaceae <-
  merge(p_alluv_2.5P_Tannerellaceae, p_alluv_pathway_Tannerellaceae, by = "alluvium")

# calculate ribbon heights
p_alluv_2.5P_Tannerellaceae$height <- p_alluv_2.5P_Tannerellaceae$ymax - p_alluv_2.5P_Tannerellaceae$ymin
# restrict to class strata and ribbon heights
p_alluv_2.5P_Tannerellaceae <- subset(p_alluv_2.5P_Tannerellaceae, select = c(stratum, height))
# add heights within strata 
E1_2.5P_Tannerellaceae <- aggregate(
  p_alluv_2.5P_Tannerellaceae$height,
  by = subset(p_alluv_2.5P_Tannerellaceae, select = stratum),
  FUN = sum
)


# filter to medium protein and Tannerellaceae
p_alluv_5P_Tannerellaceae <-
  p_alluv[p_alluv$stratum == "5P" & p_alluv$fill == "#54b543", ]
# remove (redundant) stratum column (to avoid confusion in merge)
p_alluv_5P_Tannerellaceae <- subset(p_alluv_5P_Tannerellaceae, select = -stratum)

# filter to pathway data for phylum
p_alluv_pathway_Tannerellaceae <-
  p_alluv[p_alluv$x == 3 & p_alluv$fill == "#54b543", ]
# select only alluvia (by which to merge) and class
p_alluv_pathway_Tannerellaceae <- p_alluv_pathway_Tannerellaceae[, c("alluvium", "stratum")]
# merge path data into 5P Tannerellaceae data
p_alluv_5P_Tannerellaceae <-
  merge(p_alluv_5P_Tannerellaceae, p_alluv_pathway_Tannerellaceae, by = "alluvium")

# calculate ribbon heights
p_alluv_5P_Tannerellaceae$height <- p_alluv_5P_Tannerellaceae$ymax - p_alluv_5P_Tannerellaceae$ymin
# restrict to class strata and ribbon heights
p_alluv_5P_Tannerellaceae <- subset(p_alluv_5P_Tannerellaceae, select = c(stratum, height))
# add heights within strata 
E1_5P_Tannerellaceae <-aggregate(
  p_alluv_5P_Tannerellaceae$height,
  by = subset(p_alluv_5P_Tannerellaceae, select = stratum),
  FUN = sum
)

# filter to high protein and Tannerellaceae
p_alluv_10P_Tannerellaceae <-
  p_alluv[p_alluv$stratum == "10P" & p_alluv$fill == "#54b543", ]
# remove (redundant) stratum column (to avoid confusion in merge)
p_alluv_10P_Tannerellaceae <- subset(p_alluv_10P_Tannerellaceae, select = -stratum)

# filter to pathway data for phylum
p_alluv_pathway_Tannerellaceae <-
  p_alluv[p_alluv$x == 3 & p_alluv$fill == "#54b543", ]
# select only alluvia (by which to merge) and class
p_alluv_pathway_Tannerellaceae <- p_alluv_pathway_Tannerellaceae[, c("alluvium", "stratum")]
# merge path data into 10P Tannerellaceae data
p_alluv_10P_Tannerellaceae <-
  merge(p_alluv_10P_Tannerellaceae, p_alluv_pathway_Tannerellaceae, by = "alluvium")

# calculate ribbon heights
p_alluv_10P_Tannerellaceae$height <- p_alluv_10P_Tannerellaceae$ymax - p_alluv_10P_Tannerellaceae$ymin
# restrict to class strata and ribbon heights
p_alluv_10P_Tannerellaceae <- subset(p_alluv_10P_Tannerellaceae, select = c(stratum, height))
# add heights within strata (combine adult and child counts)
E1_10P_Tannerellaceae <-aggregate(
  p_alluv_10P_Tannerellaceae$height,
  by = subset(p_alluv_10P_Tannerellaceae, select = stratum),
  FUN = sum
)

#Export_Tannerellaceae
E1_2.5P_Tannerellaceae
E1_5P_Tannerellaceae
E1_10P_Tannerellaceae

```














Now lets look deeper at the steps being used in each pathway
```{r}
#Plot em
#E1 bacteroidetes overall
E1_bacteroidetes <- ggplot(as.data.frame(E1_sankey_bacteroidetes),
       aes(y = Abundance, axis1 = family, axis2 = Percent_Protein, axis3 = pathway, axis4 = MostLikelySeriesofStepsinPathway)) +
  geom_alluvium(aes(fill = pathway), width = 1/12)+
    geom_stratum(width = 1/12, fill = "black", color = "white") +
  geom_label(stat = "stratum", aes(label = after_stat(stratum))) +
  scale_x_discrete(limits = c("family", "Percent_Protein", "pathway","MostLikelySeriesofStepsinPathway" ), expand = c(.05, .05)) +
scale_fill_manual(values = ESS_pathwayColor) +
  ggtitle("Synthetic Treatment: Phylum Bacteroidetes \n only med-high gapmind confidence scores") +
theme_bw() +
  theme(
    title =element_text(size=22, face='bold'),
    axis.text.x = element_text(color="black", size=14),
    axis.text.y = element_text(color="black", size=16),
    strip.text.y = element_text(color="black", size=16),
    legend.title = element_text(color="black", size=22),
    legend.text = element_text(color="black", size=16),
    legend.position = "right",
    strip.background = element_blank(), #to remove facet wrap title
    strip.text = element_text(size = 20),
    axis.title.x = element_text(color="black", size=22),
    axis.title.y = element_text(color="black", size=22, angle=90),
    panel.grid.major = element_blank(), # switch off major grid lines
   panel.grid.minor = element_blank(), # switch off minor grid lines
    panel.border = element_rect(colour = "black", fill=NA, size=.75)
  )
#CREATE A PDF AND SAVES IT TO THE RIGHT DIRECTORY/FOLDER. 
pdf("/Users/connermertz/Dropbox (vlab)/Conner Mertz/UNM biology/Chapter 1 E1 vs E2/Methods/Metagenomics/methods_DataAnalysis/Metagenomic Pipeline/Plots/SANKEY/Bacteroidetes/E1_Bacteroidetes/E1_bacteroidetes_alldiets_steps.pdf", height = 20, width = 30)
E1_bacteroidetes
dev.off()
```


Now lets look deeper at the steps being used in each pathway
```{r}
#Plot em
#E1 bacteroidetes overall
E1_bacteroidetes <- ggplot(as.data.frame(E1_sankey_bacteroidetes),
       aes(y = Abundance, axis1 = family, axis2 = Percent_Protein, axis3 = pathway, axis4 = MostLikelySeriesofStepsinPathway)) +
  geom_alluvium(aes(fill = family), width = 1/12)+
    geom_stratum(width = 1/12, fill = "black", color = "white") +
  geom_label(stat = "stratum", aes(label = after_stat(stratum))) +
  scale_x_discrete(limits = c("family", "Percent_Protein", "pathway","MostLikelySeriesofStepsinPathway" ), expand = c(.05, .05)) +
scale_fill_manual(values = familyColor) +
  ggtitle("Synthetic Treatment: Phylum Bacteroidetes \n only med-high gapmind confidence scores") +
theme_bw() +
  theme(
    title =element_text(size=22, face='bold'),
    axis.text.x = element_text(color="black", size=14),
    axis.text.y = element_text(color="black", size=16),
    strip.text.y = element_text(color="black", size=16),
    legend.title = element_text(color="black", size=22),
    legend.text = element_text(color="black", size=16),
    legend.position = "right",
    strip.background = element_blank(), #to remove facet wrap title
    strip.text = element_text(size = 20),
    axis.title.x = element_text(color="black", size=22),
    axis.title.y = element_text(color="black", size=22, angle=90),
    panel.grid.major = element_blank(), # switch off major grid lines
   panel.grid.minor = element_blank(), # switch off minor grid lines
    panel.border = element_rect(colour = "black", fill=NA, size=.75)
  )
#CREATE A PDF AND SAVES IT TO THE RIGHT DIRECTORY/FOLDER. 
pdf("/Users/connermertz/Dropbox (vlab)/Conner Mertz/UNM biology/Chapter 1 E1 vs E2/Methods/Metagenomics/methods_DataAnalysis/Metagenomic Pipeline/Plots/SANKEY/Bacteroidetes/E1_Bacteroidetes/E1_bacteroidetes_alldiets_family_steps.pdf", height = 20, width = 30)
E1_bacteroidetes
dev.off()
```

Now lets look deeper at the steps being used in each pathway but split up by diet
E1 Bacteroidetes by Percent Protein!
```{r}
#E1_Bacteroidetes_fill pathway
#2.5P
E1_2.5P_bacteroidetes <- ggplot(as.data.frame(E1_sankey_bacteroidetes_2.5P),
       aes(y = Abundance, axis1 = family, axis2 = pathway, axis3 = MostLikelySeriesofStepsinPathway)) +
  geom_alluvium(aes(fill = pathway), width = 1/12)+
    geom_stratum(width = 1/12, fill = "black", color = "white") +
  geom_label(stat = "stratum", aes(label = after_stat(stratum))) +
  scale_x_discrete(limits = c("family", "pathway","MostLikelySeriesofStepsinPathway" ), expand = c(.05, .05)) +
  #facet_wrap(~Percent_Protein, scale = "free_x") +
  scale_fill_manual(values = ESS_pathwayColor) +
  ggtitle("Synthetic Treatment: Phylum Bacteroidetes from 2.5P Diet \nonly med-high gapmind confidence scores") +
theme_bw() +
  theme(
    title =element_text(size=22, face='bold'),
    axis.text.x = element_text(color="black", size=14),
    axis.text.y = element_text(color="black", size=16),
    strip.text.y = element_text(color="black", size=16),
    legend.title = element_text(color="black", size=22),
    legend.text = element_text(color="black", size=16),
    legend.position = "right",
    strip.background = element_blank(), #to remove facet wrap title
    strip.text = element_text(size = 20),
    axis.title.x = element_text(color="black", size=22),
    axis.title.y = element_text(color="black", size=22, angle=90),
    panel.grid.major = element_blank(), # switch off major grid lines
   panel.grid.minor = element_blank(), # switch off minor grid lines
    panel.border = element_rect(colour = "black", fill=NA, size=.75)
  )
#CREATE A PDF AND SAVES IT TO THE RIGHT DIRECTORY/FOLDER. 
pdf("/Users/connermertz/Dropbox (vlab)/Conner Mertz/UNM biology/Chapter 1 E1 vs E2/Methods/Metagenomics/methods_DataAnalysis/Metagenomic Pipeline/Plots/SANKEY/Bacteroidetes/E1_Bacteroidetes/E1_bacteroidetes_2.5_path_steps.pdf", height = 12, width = 25)
E1_2.5P_bacteroidetes
dev.off()

#E1_Bacteroidetes_fill family
E1_2.5P_bacteroidetes <- ggplot(as.data.frame(E1_sankey_bacteroidetes_2.5P),
       aes(y = Abundance, axis1 = family, axis2 = pathway, axis3 = MostLikelySeriesofStepsinPathway)) +
  geom_alluvium(aes(fill = family), width = 1/12)+
    geom_stratum(width = 1/12, fill = "black", color = "white") +
  geom_label(stat = "stratum", aes(label = after_stat(stratum))) +
  scale_x_discrete(limits = c("family", "pathway","MostLikelySeriesofStepsinPathway" ), expand = c(.05, .05)) +
  scale_fill_manual(values = familyColor) +
  ggtitle("Synthetic Treatment: Phylum Bacteroidetes from 2.5P Diet \nonly med-high gapmind confidence scores") +
theme_bw() +
  theme(
    title =element_text(size=22, face='bold'),
    axis.text.x = element_text(color="black", size=14),
    axis.text.y = element_text(color="black", size=16),
    strip.text.y = element_text(color="black", size=16),
    legend.title = element_text(color="black", size=22),
    legend.text = element_text(color="black", size=16),
    legend.position = "right",
    strip.background = element_blank(), #to remove facet wrap title
    strip.text = element_text(size = 20),
    axis.title.x = element_text(color="black", size=22),
    axis.title.y = element_text(color="black", size=22, angle=90),
    panel.grid.major = element_blank(), # switch off major grid lines
   panel.grid.minor = element_blank(), # switch off minor grid lines
    panel.border = element_rect(colour = "black", fill=NA, size=.75)
  )
#CREATE A PDF AND SAVES IT TO THE RIGHT DIRECTORY/FOLDER. 
pdf("/Users/connermertz/Dropbox (vlab)/Conner Mertz/UNM biology/Chapter 1 E1 vs E2/Methods/Metagenomics/methods_DataAnalysis/Metagenomic Pipeline/Plots/SANKEY/Bacteroidetes/E1_Bacteroidetes/E1_bacteroidetes_2.5P_family_steps.pdf", height = 12, width = 25)
E1_2.5P_bacteroidetes
dev.off()
```

```{r}
#E1_Bacteroidetes_fill pathway
#5P
E1_5P_bacteroidetes <- ggplot(as.data.frame(E1_sankey_bacteroidetes_5P),
       aes(y = Abundance, axis1 = family, axis2 = pathway, axis3 = MostLikelySeriesofStepsinPathway)) +
  geom_alluvium(aes(fill = pathway), width = 1/12)+
    geom_stratum(width = 1/12, fill = "black", color = "white") +
  geom_label(stat = "stratum", aes(label = after_stat(stratum))) +
  scale_x_discrete(limits = c("family", "pathway","MostLikelySeriesofStepsinPathway" ), expand = c(.05, .05)) +
  #facet_wrap(~Percent_Protein, scale = "free_x") +
  scale_fill_manual(values = ESS_pathwayColor) +
  ggtitle("Synthetic Treatment: Phylum Bacteroidetes from 5P Diet \nonly med-high gapmind confidence scores") +
theme_bw() +
  theme(
    title =element_text(size=22, face='bold'),
    axis.text.x = element_text(color="black", size=14),
    axis.text.y = element_text(color="black", size=16),
    strip.text.y = element_text(color="black", size=16),
    legend.title = element_text(color="black", size=22),
    legend.text = element_text(color="black", size=16),
    legend.position = "right",
    strip.background = element_blank(), #to remove facet wrap title
    strip.text = element_text(size = 20),
    axis.title.x = element_text(color="black", size=22),
    axis.title.y = element_text(color="black", size=22, angle=90),
    panel.grid.major = element_blank(), # switch off major grid lines
   panel.grid.minor = element_blank(), # switch off minor grid lines
    panel.border = element_rect(colour = "black", fill=NA, size=.75)
  )
#CREATE A PDF AND SAVES IT TO THE RIGHT DIRECTORY/FOLDER. 
pdf("/Users/connermertz/Dropbox (vlab)/Conner Mertz/UNM biology/Chapter 1 E1 vs E2/Methods/Metagenomics/methods_DataAnalysis/Metagenomic Pipeline/Plots/SANKEY/Bacteroidetes/E1_Bacteroidetes/E1_bacteroidetes_5_path_steps.pdf", height = 12, width = 25)
E1_5P_bacteroidetes
dev.off()

#E1_Bacteroidetes_fill family
E1_5P_bacteroidetes <- ggplot(as.data.frame(E1_sankey_bacteroidetes_5P),
       aes(y = Abundance, axis1 = family, axis2 = pathway, axis3 = MostLikelySeriesofStepsinPathway)) +
  geom_alluvium(aes(fill = family), width = 1/12)+
    geom_stratum(width = 1/12, fill = "black", color = "white") +
  geom_label(stat = "stratum", aes(label = after_stat(stratum))) +
  scale_x_discrete(limits = c("family", "pathway","MostLikelySeriesofStepsinPathway" ), expand = c(.05, .05)) +
  scale_fill_manual(values = familyColor) +
  ggtitle("Synthetic Treatment: Phylum Bacteroidetes from 5P Diet \nonly med-high gapmind confidence scores") +
theme_bw() +
  theme(
    title =element_text(size=22, face='bold'),
    axis.text.x = element_text(color="black", size=14),
    axis.text.y = element_text(color="black", size=16),
    strip.text.y = element_text(color="black", size=16),
    legend.title = element_text(color="black", size=22),
    legend.text = element_text(color="black", size=16),
    legend.position = "right",
    strip.background = element_blank(), #to remove facet wrap title
    strip.text = element_text(size = 20),
    axis.title.x = element_text(color="black", size=22),
    axis.title.y = element_text(color="black", size=22, angle=90),
    panel.grid.major = element_blank(), # switch off major grid lines
   panel.grid.minor = element_blank(), # switch off minor grid lines
    panel.border = element_rect(colour = "black", fill=NA, size=.75)
  )
#CREATE A PDF AND SAVES IT TO THE RIGHT DIRECTORY/FOLDER. 
pdf("/Users/connermertz/Dropbox (vlab)/Conner Mertz/UNM biology/Chapter 1 E1 vs E2/Methods/Metagenomics/methods_DataAnalysis/Metagenomic Pipeline/Plots/SANKEY/Bacteroidetes/E1_Bacteroidetes/E1_bacteroidetes_5P_family_steps.pdf", height = 12, width = 25)
E1_5P_bacteroidetes
dev.off()
```

```{r}
#E1_Bacteroidetes_fill pathway
#10P
E1_10P_bacteroidetes <- ggplot(as.data.frame(E1_sankey_bacteroidetes_10P),
       aes(y = Abundance, axis1 = family, axis2 = pathway, axis3 = MostLikelySeriesofStepsinPathway)) +
  geom_alluvium(aes(fill = pathway), width = 1/12)+
    geom_stratum(width = 1/12, fill = "black", color = "white") +
  geom_label(stat = "stratum", aes(label = after_stat(stratum))) +
  scale_x_discrete(limits = c("family", "pathway","MostLikelySeriesofStepsinPathway" ), expand = c(.05, .05)) +
  #facet_wrap(~Percent_Protein, scale = "free_x") +
  scale_fill_manual(values = ESS_pathwayColor) +
  ggtitle("Synthetic Treatment: Phylum Bacteroidetes from 10P Diet \nonly med-high gapmind confidence scores") +
theme_bw() +
  theme(
    title =element_text(size=22, face='bold'),
    axis.text.x = element_text(color="black", size=14),
    axis.text.y = element_text(color="black", size=16),
    strip.text.y = element_text(color="black", size=16),
    legend.title = element_text(color="black", size=22),
    legend.text = element_text(color="black", size=16),
    legend.position = "right",
    strip.background = element_blank(), #to remove facet wrap title
    strip.text = element_text(size = 20),
    axis.title.x = element_text(color="black", size=22),
    axis.title.y = element_text(color="black", size=22, angle=90),
    panel.grid.major = element_blank(), # switch off major grid lines
   panel.grid.minor = element_blank(), # switch off minor grid lines
    panel.border = element_rect(colour = "black", fill=NA, size=.75)
  )
#CREATE A PDF AND SAVES IT TO THE RIGHT DIRECTORY/FOLDER. 
pdf("/Users/connermertz/Dropbox (vlab)/Conner Mertz/UNM biology/Chapter 1 E1 vs E2/Methods/Metagenomics/methods_DataAnalysis/Metagenomic Pipeline/Plots/SANKEY/Bacteroidetes/E1_Bacteroidetes/E1_bacteroidetes_10_path_steps.pdf", height = 12, width = 25)
E1_10P_bacteroidetes
dev.off()

#E1_Bacteroidetes_fill family
E1_10P_bacteroidetes <- ggplot(as.data.frame(E1_sankey_bacteroidetes_10P),
       aes(y = Abundance, axis1 = family, axis2 = pathway, axis3 = MostLikelySeriesofStepsinPathway)) +
  geom_alluvium(aes(fill = family), width = 1/12)+
    geom_stratum(width = 1/12, fill = "black", color = "white") +
  geom_label(stat = "stratum", aes(label = after_stat(stratum))) +
  scale_x_discrete(limits = c("family", "pathway","MostLikelySeriesofStepsinPathway" ), expand = c(.05, .05)) +
  scale_fill_manual(values = familyColor) +
  ggtitle("Synthetic Treatment: Phylum Bacteroidetes from 10P Diet \nonly med-high gapmind confidence scores") +
theme_bw() +
  theme(
    title =element_text(size=22, face='bold'),
    axis.text.x = element_text(color="black", size=14),
    axis.text.y = element_text(color="black", size=16),
    strip.text.y = element_text(color="black", size=16),
    legend.title = element_text(color="black", size=22),
    legend.text = element_text(color="black", size=16),
    legend.position = "right",
    strip.background = element_blank(), #to remove facet wrap title
    strip.text = element_text(size = 20),
    axis.title.x = element_text(color="black", size=22),
    axis.title.y = element_text(color="black", size=22, angle=90),
    panel.grid.major = element_blank(), # switch off major grid lines
   panel.grid.minor = element_blank(), # switch off minor grid lines
    panel.border = element_rect(colour = "black", fill=NA, size=.75)
  )
#CREATE A PDF AND SAVES IT TO THE RIGHT DIRECTORY/FOLDER. 
pdf("/Users/connermertz/Dropbox (vlab)/Conner Mertz/UNM biology/Chapter 1 E1 vs E2/Methods/Metagenomics/methods_DataAnalysis/Metagenomic Pipeline/Plots/SANKEY/Bacteroidetes/E1_Bacteroidetes/E1_bacteroidetes_10P_family_steps.pdf", height = 12, width = 25)
E1_10P_bacteroidetes
dev.off()
```









########E1#############
firmicutes

E1_firmicutes overall for paper by pathway
```{r}
#Plot em
#E1 firmicutes overall for paper
E1_firmicutes <- ggplot(as.data.frame(E1_sankey_firmicutes),
       aes(y = Abundance, axis1 = family, axis2 = Percent_Protein, axis3 = pathway)) +
  geom_alluvium(aes(fill = pathway), width = 1/12)+
    geom_stratum(width = 1/12, fill = "black", color = "white") +
  geom_label(stat = "stratum", aes(label = after_stat(stratum))) +
  scale_x_discrete(limits = c("family", "Percent_Protein", "pathway"), expand = c(.05, .05)) +
scale_fill_manual(values = ESS_pathwayColor) +
  ggtitle("Synthetic Treatment: Phylum firmicutes \n only med-high gapmind confidence scores") +
theme_bw() +
  theme(
    title =element_text(size=22, face='bold'),
    axis.text.x = element_text(color="black", size=14),
    axis.text.y = element_text(color="black", size=16),
    strip.text.y = element_text(color="black", size=16),
    legend.title = element_text(color="black", size=22),
    legend.text = element_text(color="black", size=16),
    legend.position = "right",
    strip.background = element_blank(), #to remove facet wrap title
    strip.text = element_text(size = 20),
    axis.title.x = element_text(color="black", size=22),
    axis.title.y = element_text(color="black", size=22, angle=90),
    panel.grid.major = element_blank(), # switch off major grid lines
   panel.grid.minor = element_blank(), # switch off minor grid lines
    panel.border = element_rect(colour = "black", fill=NA, size=.75)
  )
#CREATE A PDF AND SAVES IT TO THE RIGHT DIRECTORY/FOLDER. 
pdf("/Users/connermertz/Dropbox (vlab)/Conner Mertz/UNM biology/Chapter 1 E1 vs E2/Methods/Metagenomics/methods_DataAnalysis/Metagenomic Pipeline/Plots/SANKEY/firmicutes/E1_firmicutes/E1_firmicutes_alldiets.pdf", height = 12, width = 16)
E1_firmicutes
dev.off()
```
E1_firmicutes overall for paper by family
```{r}
#Plot em
#E1 firmicutes overall for paper
E1_firmicutes <- ggplot(as.data.frame(E1_sankey_firmicutes),
       aes(y = Abundance, axis1 = family, axis2 = Percent_Protein, axis3 = pathway)) +
  geom_alluvium(aes(fill = family), width = 1/12)+
    geom_stratum(width = 1/12, fill = "black", color = "white") +
  geom_label(stat = "stratum", aes(label = after_stat(stratum))) +
  scale_x_discrete(limits = c("family", "Percent_Protein", "pathway"), expand = c(.05, .05)) +
scale_fill_manual(values = familyColor) +
  ggtitle("Synthetic Treatment: Phylum firmicutes \n only med-high gapmind confidence scores") +
theme_bw() +
  theme(
    title =element_text(size=22, face='bold'),
    axis.text.x = element_text(color="black", size=14),
    axis.text.y = element_text(color="black", size=16),
    strip.text.y = element_text(color="black", size=16),
    legend.title = element_text(color="black", size=22),
    legend.text = element_text(color="black", size=16),
    legend.position = "right",
    strip.background = element_blank(), #to remove facet wrap title
    strip.text = element_text(size = 20),
    axis.title.x = element_text(color="black", size=22),
    axis.title.y = element_text(color="black", size=22, angle=90),
    panel.grid.major = element_blank(), # switch off major grid lines
   panel.grid.minor = element_blank(), # switch off minor grid lines
    panel.border = element_rect(colour = "black", fill=NA, size=.75)
  )
#CREATE A PDF AND SAVES IT TO THE RIGHT DIRECTORY/FOLDER. 
#pdf("/Users/connermertz/Dropbox (vlab)/Conner Mertz/UNM biology/Chapter 1 E1 vs E2/Methods/Metagenomics/methods_DataAnalysis/Metagenomic Pipeline/Plots/SANKEY/firmicutes/E1_firmicutes/E1_firmicutes_alldiets_family_steps.pdf", height = 12, width = 16)
E1_firmicutes
#dev.off()
```

Lets export the curve heights for each family belonging to phylum firmicutes by diet in E1
```{r}
# recover the built plot
p_build <- ggplot_build(E1_firmicutes)
# extract the data for the alluvium graphical objects
p_alluv <- p_build$data[[1L]]
# what are the fill colors
unique(p_alluv$fill)
#   "#c6b0ff" "#f6477f" "#623d00"   
      #Enterococcaceae= "#c6b0ff"
      #Lachnospiraceae= "#f6477f",
      #Lactobacillaceae= "#623d00",

# filter to low protein and Enterococcaceae
p_alluv_2.5P_Enterococcaceae <-
  p_alluv[p_alluv$stratum == "2.5P" & p_alluv$fill == "#c6b0ff", ]
# remove (redundant) stratum column (to avoid confusion in merge)
p_alluv_2.5P_Enterococcaceae <- subset(p_alluv_2.5P_Enterococcaceae, select = -stratum)

# filter to pathway data for phylum
p_alluv_pathway_Enterococcaceae <-
  p_alluv[p_alluv$x == 3 & p_alluv$fill == "#c6b0ff", ]
# select only alluvia (by which to merge) and class
p_alluv_pathway_Enterococcaceae <- p_alluv_pathway_Enterococcaceae[, c("alluvium", "stratum")]
# merge path data into 2.5P Enterococcaceae data
p_alluv_2.5P_Enterococcaceae <-
  merge(p_alluv_2.5P_Enterococcaceae, p_alluv_pathway_Enterococcaceae, by = "alluvium")

# calculate ribbon heights
p_alluv_2.5P_Enterococcaceae$height <- p_alluv_2.5P_Enterococcaceae$ymax - p_alluv_2.5P_Enterococcaceae$ymin
# restrict to class strata and ribbon heights
p_alluv_2.5P_Enterococcaceae <- subset(p_alluv_2.5P_Enterococcaceae, select = c(stratum, height))
# add heights within strata 
E1_2.5P_Enterococcaceae <- aggregate(
  p_alluv_2.5P_Enterococcaceae$height,
  by = subset(p_alluv_2.5P_Enterococcaceae, select = stratum),
  FUN = sum
)


# filter to medium protein and Enterococcaceae
p_alluv_5P_Enterococcaceae <-
  p_alluv[p_alluv$stratum == "5P" & p_alluv$fill == "#c6b0ff", ]
# remove (redundant) stratum column (to avoid confusion in merge)
p_alluv_5P_Enterococcaceae <- subset(p_alluv_5P_Enterococcaceae, select = -stratum)

# filter to pathway data for phylum
p_alluv_pathway_Enterococcaceae <-
  p_alluv[p_alluv$x == 3 & p_alluv$fill == "#c6b0ff", ]
# select only alluvia (by which to merge) and class
p_alluv_pathway_Enterococcaceae <- p_alluv_pathway_Enterococcaceae[, c("alluvium", "stratum")]
# merge path data into 5P Enterococcaceae data
p_alluv_5P_Enterococcaceae <-
  merge(p_alluv_5P_Enterococcaceae, p_alluv_pathway_Enterococcaceae, by = "alluvium")

# calculate ribbon heights
p_alluv_5P_Enterococcaceae$height <- p_alluv_5P_Enterococcaceae$ymax - p_alluv_5P_Enterococcaceae$ymin
# restrict to class strata and ribbon heights
p_alluv_5P_Enterococcaceae <- subset(p_alluv_5P_Enterococcaceae, select = c(stratum, height))
# add heights within strata 
E1_5P_Enterococcaceae <-aggregate(
  p_alluv_5P_Enterococcaceae$height,
  by = subset(p_alluv_5P_Enterococcaceae, select = stratum),
  FUN = sum
)

# filter to high protein and Enterococcaceae
p_alluv_10P_Enterococcaceae <-
  p_alluv[p_alluv$stratum == "10P" & p_alluv$fill == "#c6b0ff", ]
# remove (redundant) stratum column (to avoid confusion in merge)
p_alluv_10P_Enterococcaceae <- subset(p_alluv_10P_Enterococcaceae, select = -stratum)

# filter to pathway data for phylum
p_alluv_pathway_Enterococcaceae <-
  p_alluv[p_alluv$x == 3 & p_alluv$fill == "#c6b0ff", ]
# select only alluvia (by which to merge) and class
p_alluv_pathway_Enterococcaceae <- p_alluv_pathway_Enterococcaceae[, c("alluvium", "stratum")]
# merge path data into 10P Enterococcaceae data
p_alluv_10P_Enterococcaceae <-
  merge(p_alluv_10P_Enterococcaceae, p_alluv_pathway_Enterococcaceae, by = "alluvium")

# calculate ribbon heights
p_alluv_10P_Enterococcaceae$height <- p_alluv_10P_Enterococcaceae$ymax - p_alluv_10P_Enterococcaceae$ymin
# restrict to class strata and ribbon heights
p_alluv_10P_Enterococcaceae <- subset(p_alluv_10P_Enterococcaceae, select = c(stratum, height))
# add heights within strata (combine adult and child counts)
E1_10P_Enterococcaceae <-aggregate(
  p_alluv_10P_Enterococcaceae$height,
  by = subset(p_alluv_10P_Enterococcaceae, select = stratum),
  FUN = sum
)

#Export_Enterococcaceae
E1_2.5P_Enterococcaceae
E1_5P_Enterococcaceae
E1_10P_Enterococcaceae


# filter to low protein and Lachnospiraceae
p_alluv_2.5P_Lachnospiraceae <-
  p_alluv[p_alluv$stratum == "2.5P" & p_alluv$fill == "#f6477f", ]
# remove (redundant) stratum column (to avoid confusion in merge)
p_alluv_2.5P_Lachnospiraceae <- subset(p_alluv_2.5P_Lachnospiraceae, select = -stratum)

# filter to pathway data for phylum
p_alluv_pathway_Lachnospiraceae <-
  p_alluv[p_alluv$x == 3 & p_alluv$fill == "#f6477f", ]
# select only alluvia (by which to merge) and class
p_alluv_pathway_Lachnospiraceae <- p_alluv_pathway_Lachnospiraceae[, c("alluvium", "stratum")]
# merge path data into 2.5P Lachnospiraceae data
p_alluv_2.5P_Lachnospiraceae <-
  merge(p_alluv_2.5P_Lachnospiraceae, p_alluv_pathway_Lachnospiraceae, by = "alluvium")

# calculate ribbon heights
p_alluv_2.5P_Lachnospiraceae$height <- p_alluv_2.5P_Lachnospiraceae$ymax - p_alluv_2.5P_Lachnospiraceae$ymin
# restrict to class strata and ribbon heights
p_alluv_2.5P_Lachnospiraceae <- subset(p_alluv_2.5P_Lachnospiraceae, select = c(stratum, height))
# add heights within strata 
E1_2.5P_Lachnospiraceae <- aggregate(
  p_alluv_2.5P_Lachnospiraceae$height,
  by = subset(p_alluv_2.5P_Lachnospiraceae, select = stratum),
  FUN = sum
)


# filter to medium protein and Lachnospiraceae
p_alluv_5P_Lachnospiraceae <-
  p_alluv[p_alluv$stratum == "5P" & p_alluv$fill == "#f6477f", ]
# remove (redundant) stratum column (to avoid confusion in merge)
p_alluv_5P_Lachnospiraceae <- subset(p_alluv_5P_Lachnospiraceae, select = -stratum)

# filter to pathway data for phylum
p_alluv_pathway_Lachnospiraceae <-
  p_alluv[p_alluv$x == 3 & p_alluv$fill == "#f6477f", ]
# select only alluvia (by which to merge) and class
p_alluv_pathway_Lachnospiraceae <- p_alluv_pathway_Lachnospiraceae[, c("alluvium", "stratum")]
# merge path data into 5P Lachnospiraceae data
p_alluv_5P_Lachnospiraceae <-
  merge(p_alluv_5P_Lachnospiraceae, p_alluv_pathway_Lachnospiraceae, by = "alluvium")

# calculate ribbon heights
p_alluv_5P_Lachnospiraceae$height <- p_alluv_5P_Lachnospiraceae$ymax - p_alluv_5P_Lachnospiraceae$ymin
# restrict to class strata and ribbon heights
p_alluv_5P_Lachnospiraceae <- subset(p_alluv_5P_Lachnospiraceae, select = c(stratum, height))
# add heights within strata 
E1_5P_Lachnospiraceae <-aggregate(
  p_alluv_5P_Lachnospiraceae$height,
  by = subset(p_alluv_5P_Lachnospiraceae, select = stratum),
  FUN = sum
)

# filter to high protein and Lachnospiraceae
p_alluv_10P_Lachnospiraceae <-
  p_alluv[p_alluv$stratum == "10P" & p_alluv$fill == "#f6477f", ]
# remove (redundant) stratum column (to avoid confusion in merge)
p_alluv_10P_Lachnospiraceae <- subset(p_alluv_10P_Lachnospiraceae, select = -stratum)

# filter to pathway data for phylum
p_alluv_pathway_Lachnospiraceae <-
  p_alluv[p_alluv$x == 3 & p_alluv$fill == "#f6477f", ]
# select only alluvia (by which to merge) and class
p_alluv_pathway_Lachnospiraceae <- p_alluv_pathway_Lachnospiraceae[, c("alluvium", "stratum")]
# merge path data into 10P Lachnospiraceae data
p_alluv_10P_Lachnospiraceae <-
  merge(p_alluv_10P_Lachnospiraceae, p_alluv_pathway_Lachnospiraceae, by = "alluvium")

# calculate ribbon heights
p_alluv_10P_Lachnospiraceae$height <- p_alluv_10P_Lachnospiraceae$ymax - p_alluv_10P_Lachnospiraceae$ymin
# restrict to class strata and ribbon heights
p_alluv_10P_Lachnospiraceae <- subset(p_alluv_10P_Lachnospiraceae, select = c(stratum, height))
# add heights within strata (combine adult and child counts)
E1_10P_Lachnospiraceae <-aggregate(
  p_alluv_10P_Lachnospiraceae$height,
  by = subset(p_alluv_10P_Lachnospiraceae, select = stratum),
  FUN = sum
)

#Export_Lachnospiraceae
E1_2.5P_Lachnospiraceae
E1_5P_Lachnospiraceae
E1_10P_Lachnospiraceae

# filter to low protein and Lactobacillaceae
p_alluv_2.5P_Lactobacillaceae <-
  p_alluv[p_alluv$stratum == "2.5P" & p_alluv$fill == "#623d00", ]
# remove (redundant) stratum column (to avoid confusion in merge)
p_alluv_2.5P_Lactobacillaceae <- subset(p_alluv_2.5P_Lactobacillaceae, select = -stratum)

# filter to pathway data for phylum
p_alluv_pathway_Lactobacillaceae <-
  p_alluv[p_alluv$x == 3 & p_alluv$fill == "#623d00", ]
# select only alluvia (by which to merge) and class
p_alluv_pathway_Lactobacillaceae <- p_alluv_pathway_Lactobacillaceae[, c("alluvium", "stratum")]
# merge path data into 2.5P Lactobacillaceae data
p_alluv_2.5P_Lactobacillaceae <-
  merge(p_alluv_2.5P_Lactobacillaceae, p_alluv_pathway_Lactobacillaceae, by = "alluvium")

# calculate ribbon heights
p_alluv_2.5P_Lactobacillaceae$height <- p_alluv_2.5P_Lactobacillaceae$ymax - p_alluv_2.5P_Lactobacillaceae$ymin
# restrict to class strata and ribbon heights
p_alluv_2.5P_Lactobacillaceae <- subset(p_alluv_2.5P_Lactobacillaceae, select = c(stratum, height))
# add heights within strata 
E1_2.5P_Lactobacillaceae <- aggregate(
  p_alluv_2.5P_Lactobacillaceae$height,
  by = subset(p_alluv_2.5P_Lactobacillaceae, select = stratum),
  FUN = sum
)


# filter to medium protein and Lactobacillaceae
p_alluv_5P_Lactobacillaceae <-
  p_alluv[p_alluv$stratum == "5P" & p_alluv$fill == "#623d00", ]
# remove (redundant) stratum column (to avoid confusion in merge)
p_alluv_5P_Lactobacillaceae <- subset(p_alluv_5P_Lactobacillaceae, select = -stratum)

# filter to pathway data for phylum
p_alluv_pathway_Lactobacillaceae <-
  p_alluv[p_alluv$x == 3 & p_alluv$fill == "#623d00", ]
# select only alluvia (by which to merge) and class
p_alluv_pathway_Lactobacillaceae <- p_alluv_pathway_Lactobacillaceae[, c("alluvium", "stratum")]
# merge path data into 5P Lactobacillaceae data
p_alluv_5P_Lactobacillaceae <-
  merge(p_alluv_5P_Lactobacillaceae, p_alluv_pathway_Lactobacillaceae, by = "alluvium")

# calculate ribbon heights
p_alluv_5P_Lactobacillaceae$height <- p_alluv_5P_Lactobacillaceae$ymax - p_alluv_5P_Lactobacillaceae$ymin
# restrict to class strata and ribbon heights
p_alluv_5P_Lactobacillaceae <- subset(p_alluv_5P_Lactobacillaceae, select = c(stratum, height))
# add heights within strata 
E1_5P_Lactobacillaceae <-aggregate(
  p_alluv_5P_Lactobacillaceae$height,
  by = subset(p_alluv_5P_Lactobacillaceae, select = stratum),
  FUN = sum
)

# filter to high protein and Lactobacillaceae
p_alluv_10P_Lactobacillaceae <-
  p_alluv[p_alluv$stratum == "10P" & p_alluv$fill == "#623d00", ]
# remove (redundant) stratum column (to avoid confusion in merge)
p_alluv_10P_Lactobacillaceae <- subset(p_alluv_10P_Lactobacillaceae, select = -stratum)

# filter to pathway data for phylum
p_alluv_pathway_Lactobacillaceae <-
  p_alluv[p_alluv$x == 3 & p_alluv$fill == "#623d00", ]
# select only alluvia (by which to merge) and class
p_alluv_pathway_Lactobacillaceae <- p_alluv_pathway_Lactobacillaceae[, c("alluvium", "stratum")]
# merge path data into 10P Lactobacillaceae data
p_alluv_10P_Lactobacillaceae <-
  merge(p_alluv_10P_Lactobacillaceae, p_alluv_pathway_Lactobacillaceae, by = "alluvium")

# calculate ribbon heights
p_alluv_10P_Lactobacillaceae$height <- p_alluv_10P_Lactobacillaceae$ymax - p_alluv_10P_Lactobacillaceae$ymin
# restrict to class strata and ribbon heights
p_alluv_10P_Lactobacillaceae <- subset(p_alluv_10P_Lactobacillaceae, select = c(stratum, height))
# add heights within strata (combine adult and child counts)
E1_10P_Lactobacillaceae <-aggregate(
  p_alluv_10P_Lactobacillaceae$height,
  by = subset(p_alluv_10P_Lactobacillaceae, select = stratum),
  FUN = sum
)

#Export_Lactobacillaceae
E1_2.5P_Lactobacillaceae
E1_5P_Lactobacillaceae
E1_10P_Lactobacillaceae

```









Now lets look deeper at the steps being used in each pathway
```{r}
#Plot em
#E1 firmicutes overall
E1_firmicutes <- ggplot(as.data.frame(E1_sankey_firmicutes),
       aes(y = Abundance, axis1 = family, axis2 = Percent_Protein, axis3 = pathway, axis4 = MostLikelySeriesofStepsinPathway)) +
  geom_alluvium(aes(fill = pathway), width = 1/12)+
    geom_stratum(width = 1/12, fill = "black", color = "white") +
  geom_label(stat = "stratum", aes(label = after_stat(stratum))) +
  scale_x_discrete(limits = c("family", "Percent_Protein", "pathway","MostLikelySeriesofStepsinPathway" ), expand = c(.05, .05)) +
scale_fill_manual(values = ESS_pathwayColor) +
  ggtitle("Synthetic Treatment: Phylum firmicutes \n only med-high gapmind confidence scores") +
theme_bw() +
  theme(
    title =element_text(size=22, face='bold'),
    axis.text.x = element_text(color="black", size=14),
    axis.text.y = element_text(color="black", size=16),
    strip.text.y = element_text(color="black", size=16),
    legend.title = element_text(color="black", size=22),
    legend.text = element_text(color="black", size=16),
    legend.position = "right",
    strip.background = element_blank(), #to remove facet wrap title
    strip.text = element_text(size = 20),
    axis.title.x = element_text(color="black", size=22),
    axis.title.y = element_text(color="black", size=22, angle=90),
    panel.grid.major = element_blank(), # switch off major grid lines
   panel.grid.minor = element_blank(), # switch off minor grid lines
    panel.border = element_rect(colour = "black", fill=NA, size=.75)
  )
#CREATE A PDF AND SAVES IT TO THE RIGHT DIRECTORY/FOLDER. 
pdf("/Users/connermertz/Dropbox (vlab)/Conner Mertz/UNM biology/Chapter 1 E1 vs E2/Methods/Metagenomics/methods_DataAnalysis/Metagenomic Pipeline/Plots/SANKEY/firmicutes/E1_firmicutes/E1_firmicutes_alldiets_steps.pdf", height = 20, width = 30)
E1_firmicutes
dev.off()
```


Now lets look deeper at the steps being used in each pathway but split up by diet
E1 firmicutes by Percent Protein!
```{r}
#E1_firmicutes_fill pathway
#2.5P
E1_2.5P_firmicutes <- ggplot(as.data.frame(E1_sankey_firmicutes_2.5P),
       aes(y = Abundance, axis1 = family, axis2 = pathway, axis3 = MostLikelySeriesofStepsinPathway)) +
  geom_alluvium(aes(fill = pathway), width = 1/12)+
    geom_stratum(width = 1/12, fill = "black", color = "white") +
  geom_label(stat = "stratum", aes(label = after_stat(stratum))) +
  scale_x_discrete(limits = c("family", "pathway","MostLikelySeriesofStepsinPathway" ), expand = c(.05, .05)) +
  #facet_wrap(~Percent_Protein, scale = "free_x") +
  scale_fill_manual(values = ESS_pathwayColor) +
  ggtitle("Synthetic Treatment: Phylum firmicutes from 2.5P Diet \nonly med-high gapmind confidence scores") +
theme_bw() +
  theme(
    title =element_text(size=22, face='bold'),
    axis.text.x = element_text(color="black", size=14),
    axis.text.y = element_text(color="black", size=16),
    strip.text.y = element_text(color="black", size=16),
    legend.title = element_text(color="black", size=22),
    legend.text = element_text(color="black", size=16),
    legend.position = "right",
    strip.background = element_blank(), #to remove facet wrap title
    strip.text = element_text(size = 20),
    axis.title.x = element_text(color="black", size=22),
    axis.title.y = element_text(color="black", size=22, angle=90),
    panel.grid.major = element_blank(), # switch off major grid lines
   panel.grid.minor = element_blank(), # switch off minor grid lines
    panel.border = element_rect(colour = "black", fill=NA, size=.75)
  )
#CREATE A PDF AND SAVES IT TO THE RIGHT DIRECTORY/FOLDER. 
pdf("/Users/connermertz/Dropbox (vlab)/Conner Mertz/UNM biology/Chapter 1 E1 vs E2/Methods/Metagenomics/methods_DataAnalysis/Metagenomic Pipeline/Plots/SANKEY/firmicutes/E1_firmicutes/E1_firmicutes_2.5_path_steps.pdf", height = 12, width = 25)
E1_2.5P_firmicutes
dev.off()

#E1_firmicutes_fill family
E1_2.5P_firmicutes <- ggplot(as.data.frame(E1_sankey_firmicutes_2.5P),
       aes(y = Abundance, axis1 = family, axis2 = pathway, axis3 = MostLikelySeriesofStepsinPathway)) +
  geom_alluvium(aes(fill = family), width = 1/12)+
    geom_stratum(width = 1/12, fill = "black", color = "white") +
  geom_label(stat = "stratum", aes(label = after_stat(stratum))) +
  scale_x_discrete(limits = c("family", "pathway","MostLikelySeriesofStepsinPathway" ), expand = c(.05, .05)) +
scale_fill_manual(values = familyColor) +
  ggtitle("Synthetic Treatment: Phylum firmicutes from 2.5P Diet \nonly med-high gapmind confidence scores") +
theme_bw() +
  theme(
    title =element_text(size=22, face='bold'),
    axis.text.x = element_text(color="black", size=14),
    axis.text.y = element_text(color="black", size=16),
    strip.text.y = element_text(color="black", size=16),
    legend.title = element_text(color="black", size=22),
    legend.text = element_text(color="black", size=16),
    legend.position = "right",
    strip.background = element_blank(), #to remove facet wrap title
    strip.text = element_text(size = 20),
    axis.title.x = element_text(color="black", size=22),
    axis.title.y = element_text(color="black", size=22, angle=90),
    panel.grid.major = element_blank(), # switch off major grid lines
   panel.grid.minor = element_blank(), # switch off minor grid lines
    panel.border = element_rect(colour = "black", fill=NA, size=.75)
  )
#CREATE A PDF AND SAVES IT TO THE RIGHT DIRECTORY/FOLDER. 
pdf("/Users/connermertz/Dropbox (vlab)/Conner Mertz/UNM biology/Chapter 1 E1 vs E2/Methods/Metagenomics/methods_DataAnalysis/Metagenomic Pipeline/Plots/SANKEY/firmicutes/E1_firmicutes/E1_firmicutes_2.5P_family_steps.pdf", height = 12, width = 25)
E1_2.5P_firmicutes
dev.off()
```

```{r}
#E1_firmicutes_fill pathway
#5P
E1_5P_firmicutes <- ggplot(as.data.frame(E1_sankey_firmicutes_5P),
       aes(y = Abundance, axis1 = family, axis2 = pathway, axis3 = MostLikelySeriesofStepsinPathway)) +
  geom_alluvium(aes(fill = pathway), width = 1/12)+
    geom_stratum(width = 1/12, fill = "black", color = "white") +
  geom_label(stat = "stratum", aes(label = after_stat(stratum))) +
  scale_x_discrete(limits = c("family", "pathway","MostLikelySeriesofStepsinPathway" ), expand = c(.05, .05)) +
  #facet_wrap(~Percent_Protein, scale = "free_x") +
  scale_fill_manual(values = ESS_pathwayColor) +
  ggtitle("Synthetic Treatment: Phylum firmicutes from 5P Diet \nonly med-high gapmind confidence scores") +
theme_bw() +
  theme(
    title =element_text(size=22, face='bold'),
    axis.text.x = element_text(color="black", size=14),
    axis.text.y = element_text(color="black", size=16),
    strip.text.y = element_text(color="black", size=16),
    legend.title = element_text(color="black", size=22),
    legend.text = element_text(color="black", size=16),
    legend.position = "right",
    strip.background = element_blank(), #to remove facet wrap title
    strip.text = element_text(size = 20),
    axis.title.x = element_text(color="black", size=22),
    axis.title.y = element_text(color="black", size=22, angle=90),
    panel.grid.major = element_blank(), # switch off major grid lines
   panel.grid.minor = element_blank(), # switch off minor grid lines
    panel.border = element_rect(colour = "black", fill=NA, size=.75)
  )
#CREATE A PDF AND SAVES IT TO THE RIGHT DIRECTORY/FOLDER. 
pdf("/Users/connermertz/Dropbox (vlab)/Conner Mertz/UNM biology/Chapter 1 E1 vs E2/Methods/Metagenomics/methods_DataAnalysis/Metagenomic Pipeline/Plots/SANKEY/firmicutes/E1_firmicutes/E1_firmicutes_5_path_steps.pdf", height = 12, width = 25)
E1_5P_firmicutes
dev.off()

#E1_firmicutes_fill family
E1_5P_firmicutes <- ggplot(as.data.frame(E1_sankey_firmicutes_5P),
       aes(y = Abundance, axis1 = family, axis2 = pathway, axis3 = MostLikelySeriesofStepsinPathway)) +
  geom_alluvium(aes(fill = family), width = 1/12)+
    geom_stratum(width = 1/12, fill = "black", color = "white") +
  geom_label(stat = "stratum", aes(label = after_stat(stratum))) +
  scale_x_discrete(limits = c("family", "pathway","MostLikelySeriesofStepsinPathway" ), expand = c(.05, .05)) +
 scale_fill_manual(values = familyColor) +
  ggtitle("Synthetic Treatment: Phylum firmicutes from 5P Diet \nonly med-high gapmind confidence scores") +
theme_bw() +
  theme(
    title =element_text(size=22, face='bold'),
    axis.text.x = element_text(color="black", size=14),
    axis.text.y = element_text(color="black", size=16),
    strip.text.y = element_text(color="black", size=16),
    legend.title = element_text(color="black", size=22),
    legend.text = element_text(color="black", size=16),
    legend.position = "right",
    strip.background = element_blank(), #to remove facet wrap title
    strip.text = element_text(size = 20),
    axis.title.x = element_text(color="black", size=22),
    axis.title.y = element_text(color="black", size=22, angle=90),
    panel.grid.major = element_blank(), # switch off major grid lines
   panel.grid.minor = element_blank(), # switch off minor grid lines
    panel.border = element_rect(colour = "black", fill=NA, size=.75)
  )
#CREATE A PDF AND SAVES IT TO THE RIGHT DIRECTORY/FOLDER. 
pdf("/Users/connermertz/Dropbox (vlab)/Conner Mertz/UNM biology/Chapter 1 E1 vs E2/Methods/Metagenomics/methods_DataAnalysis/Metagenomic Pipeline/Plots/SANKEY/firmicutes/E1_firmicutes/E1_firmicutes_5P_family_steps.pdf", height = 12, width = 25)
E1_5P_firmicutes
dev.off()
```

```{r}
#E1_firmicutes_fill pathway
#10P
E1_10P_firmicutes <- ggplot(as.data.frame(E1_sankey_firmicutes_10P),
       aes(y = Abundance, axis1 = family, axis2 = pathway, axis3 = MostLikelySeriesofStepsinPathway)) +
  geom_alluvium(aes(fill = pathway), width = 1/12)+
    geom_stratum(width = 1/12, fill = "black", color = "white") +
  geom_label(stat = "stratum", aes(label = after_stat(stratum))) +
  scale_x_discrete(limits = c("family", "pathway","MostLikelySeriesofStepsinPathway" ), expand = c(.05, .05)) +
  #facet_wrap(~Percent_Protein, scale = "free_x") +
  scale_fill_manual(values = ESS_pathwayColor) +
  ggtitle("Synthetic Treatment: Phylum firmicutes from 10P Diet \nonly med-high gapmind confidence scores") +
theme_bw() +
  theme(
    title =element_text(size=22, face='bold'),
    axis.text.x = element_text(color="black", size=14),
    axis.text.y = element_text(color="black", size=16),
    strip.text.y = element_text(color="black", size=16),
    legend.title = element_text(color="black", size=22),
    legend.text = element_text(color="black", size=16),
    legend.position = "right",
    strip.background = element_blank(), #to remove facet wrap title
    strip.text = element_text(size = 20),
    axis.title.x = element_text(color="black", size=22),
    axis.title.y = element_text(color="black", size=22, angle=90),
    panel.grid.major = element_blank(), # switch off major grid lines
   panel.grid.minor = element_blank(), # switch off minor grid lines
    panel.border = element_rect(colour = "black", fill=NA, size=.75)
  )
#CREATE A PDF AND SAVES IT TO THE RIGHT DIRECTORY/FOLDER. 
pdf("/Users/connermertz/Dropbox (vlab)/Conner Mertz/UNM biology/Chapter 1 E1 vs E2/Methods/Metagenomics/methods_DataAnalysis/Metagenomic Pipeline/Plots/SANKEY/firmicutes/E1_firmicutes/E1_firmicutes_10_path_steps.pdf", height = 12, width = 25)
E1_10P_firmicutes
dev.off()

#E1_firmicutes_fill family
E1_10P_firmicutes <- ggplot(as.data.frame(E1_sankey_firmicutes_10P),
       aes(y = Abundance, axis1 = family, axis2 = pathway, axis3 = MostLikelySeriesofStepsinPathway)) +
  geom_alluvium(aes(fill = family), width = 1/12)+
    geom_stratum(width = 1/12, fill = "black", color = "white") +
  geom_label(stat = "stratum", aes(label = after_stat(stratum))) +
  scale_x_discrete(limits = c("family", "pathway","MostLikelySeriesofStepsinPathway" ), expand = c(.05, .05)) +
scale_fill_manual(values = familyColor) +
  ggtitle("Synthetic Treatment: Phylum firmicutes from 10P Diet \nonly med-high gapmind confidence scores") +
theme_bw() +
  theme(
    title =element_text(size=22, face='bold'),
    axis.text.x = element_text(color="black", size=14),
    axis.text.y = element_text(color="black", size=16),
    strip.text.y = element_text(color="black", size=16),
    legend.title = element_text(color="black", size=22),
    legend.text = element_text(color="black", size=16),
    legend.position = "right",
    strip.background = element_blank(), #to remove facet wrap title
    strip.text = element_text(size = 20),
    axis.title.x = element_text(color="black", size=22),
    axis.title.y = element_text(color="black", size=22, angle=90),
    panel.grid.major = element_blank(), # switch off major grid lines
   panel.grid.minor = element_blank(), # switch off minor grid lines
    panel.border = element_rect(colour = "black", fill=NA, size=.75)
  )
#CREATE A PDF AND SAVES IT TO THE RIGHT DIRECTORY/FOLDER. 
pdf("/Users/connermertz/Dropbox (vlab)/Conner Mertz/UNM biology/Chapter 1 E1 vs E2/Methods/Metagenomics/methods_DataAnalysis/Metagenomic Pipeline/Plots/SANKEY/firmicutes/E1_firmicutes/E1_firmicutes_10P_family_steps.pdf", height = 12, width = 25)
E1_10P_firmicutes
dev.off()
```














########E1#############
proteobacteria

E1_proteobacteria overall for paper pathway
```{r}
#Plot em
#E1 proteobacteria overall for paper
E1_proteobacteria <- ggplot(as.data.frame(E1_sankey_proteobacteria),
       aes(y = Abundance, axis1 = family, axis2 = Percent_Protein, axis3 = pathway)) +
  geom_alluvium(aes(fill = pathway), width = 1/12)+
    geom_stratum(width = 1/12, fill = "black", color = "white") +
  geom_label(stat = "stratum", aes(label = after_stat(stratum))) +
  scale_x_discrete(limits = c("family", "Percent_Protein", "pathway"), expand = c(.05, .05)) +
scale_fill_manual(values = ESS_pathwayColor) +
  ggtitle("Synthetic Treatment: Phylum proteobacteria \n only med-high gapmind confidence scores") +
theme_bw() +
  theme(
    title =element_text(size=22, face='bold'),
    axis.text.x = element_text(color="black", size=14),
    axis.text.y = element_text(color="black", size=16),
    strip.text.y = element_text(color="black", size=16),
    legend.title = element_text(color="black", size=22),
    legend.text = element_text(color="black", size=16),
    legend.position = "right",
    strip.background = element_blank(), #to remove facet wrap title
    strip.text = element_text(size = 20),
    axis.title.x = element_text(color="black", size=22),
    axis.title.y = element_text(color="black", size=22, angle=90),
    panel.grid.major = element_blank(), # switch off major grid lines
   panel.grid.minor = element_blank(), # switch off minor grid lines
    panel.border = element_rect(colour = "black", fill=NA, size=.75)
  )
#CREATE A PDF AND SAVES IT TO THE RIGHT DIRECTORY/FOLDER. 
pdf("/Users/connermertz/Dropbox (vlab)/Conner Mertz/UNM biology/Chapter 1 E1 vs E2/Methods/Metagenomics/methods_DataAnalysis/Metagenomic Pipeline/Plots/SANKEY/proteobacteria/E1_proteobacteria/E1_proteobacteria_alldiets.pdf", height = 12, width = 16)
E1_proteobacteria
dev.off()
```

E1_proteobacteria overall for paper family
```{r}
#Plot em
#E1 proteobacteria overall for paper
E1_proteobacteria <- ggplot(as.data.frame(E1_sankey_proteobacteria),
       aes(y = Abundance, axis1 = family, axis2 = Percent_Protein, axis3 = pathway)) +
  geom_alluvium(aes(fill = family), width = 1/12)+
    geom_stratum(width = 1/12, fill = "black", color = "white") +
  geom_label(stat = "stratum", aes(label = after_stat(stratum))) +
  scale_x_discrete(limits = c("family", "Percent_Protein", "pathway"), expand = c(.05, .05)) +
scale_fill_manual(values = familyColor) +
  ggtitle("Synthetic Treatment: Phylum proteobacteria \n only med-high gapmind confidence scores") +
theme_bw() +
  theme(
    title =element_text(size=22, face='bold'),
    axis.text.x = element_text(color="black", size=14),
    axis.text.y = element_text(color="black", size=16),
    strip.text.y = element_text(color="black", size=16),
    legend.title = element_text(color="black", size=22),
    legend.text = element_text(color="black", size=16),
    legend.position = "right",
    strip.background = element_blank(), #to remove facet wrap title
    strip.text = element_text(size = 20),
    axis.title.x = element_text(color="black", size=22),
    axis.title.y = element_text(color="black", size=22, angle=90),
    panel.grid.major = element_blank(), # switch off major grid lines
   panel.grid.minor = element_blank(), # switch off minor grid lines
    panel.border = element_rect(colour = "black", fill=NA, size=.75)
  )
#CREATE A PDF AND SAVES IT TO THE RIGHT DIRECTORY/FOLDER. 
#pdf("/Users/connermertz/Dropbox (vlab)/Conner Mertz/UNM biology/Chapter 1 E1 vs E2/Methods/Metagenomics/methods_DataAnalysis/Metagenomic Pipeline/Plots/SANKEY/proteobacteria/E1_proteobacteria/E1_proteobacteria_alldiets_family_steps.pdf", height = 12, width = 16)
E1_proteobacteria
#dev.off()
```


Lets export the curve heights for each family belonging to phylum proteobacteria by diet in E1
```{r}
# recover the built plot
p_build <- ggplot_build(E1_proteobacteria)
# extract the data for the alluvium graphical objects
p_alluv <- p_build$data[[1L]]
# what are the fill colors
unique(p_alluv$fill)
#    "#edb331" "#ff875e"
      #Desulfovibrionaceae= "#edb331",
      #Helicobacteraceae= "#ff875e",

# filter to low protein and Desulfovibrionaceae
p_alluv_2.5P_Desulfovibrionaceae <-
  p_alluv[p_alluv$stratum == "2.5P" & p_alluv$fill == "#edb331", ]
# remove (redundant) stratum column (to avoid confusion in merge)
p_alluv_2.5P_Desulfovibrionaceae <- subset(p_alluv_2.5P_Desulfovibrionaceae, select = -stratum)

# filter to pathway data for phylum
p_alluv_pathway_Desulfovibrionaceae <-
  p_alluv[p_alluv$x == 3 & p_alluv$fill == "#edb331", ]
# select only alluvia (by which to merge) and class
p_alluv_pathway_Desulfovibrionaceae <- p_alluv_pathway_Desulfovibrionaceae[, c("alluvium", "stratum")]
# merge path data into 2.5P Desulfovibrionaceae data
p_alluv_2.5P_Desulfovibrionaceae <-
  merge(p_alluv_2.5P_Desulfovibrionaceae, p_alluv_pathway_Desulfovibrionaceae, by = "alluvium")

# calculate ribbon heights
p_alluv_2.5P_Desulfovibrionaceae$height <- p_alluv_2.5P_Desulfovibrionaceae$ymax - p_alluv_2.5P_Desulfovibrionaceae$ymin
# restrict to class strata and ribbon heights
p_alluv_2.5P_Desulfovibrionaceae <- subset(p_alluv_2.5P_Desulfovibrionaceae, select = c(stratum, height))
# add heights within strata 
E1_2.5P_Desulfovibrionaceae <- aggregate(
  p_alluv_2.5P_Desulfovibrionaceae$height,
  by = subset(p_alluv_2.5P_Desulfovibrionaceae, select = stratum),
  FUN = sum
)


# filter to medium protein and Desulfovibrionaceae
p_alluv_5P_Desulfovibrionaceae <-
  p_alluv[p_alluv$stratum == "5P" & p_alluv$fill == "#edb331", ]
# remove (redundant) stratum column (to avoid confusion in merge)
p_alluv_5P_Desulfovibrionaceae <- subset(p_alluv_5P_Desulfovibrionaceae, select = -stratum)

# filter to pathway data for phylum
p_alluv_pathway_Desulfovibrionaceae <-
  p_alluv[p_alluv$x == 3 & p_alluv$fill == "#edb331", ]
# select only alluvia (by which to merge) and class
p_alluv_pathway_Desulfovibrionaceae <- p_alluv_pathway_Desulfovibrionaceae[, c("alluvium", "stratum")]
# merge path data into 5P Desulfovibrionaceae data
p_alluv_5P_Desulfovibrionaceae <-
  merge(p_alluv_5P_Desulfovibrionaceae, p_alluv_pathway_Desulfovibrionaceae, by = "alluvium")

# calculate ribbon heights
p_alluv_5P_Desulfovibrionaceae$height <- p_alluv_5P_Desulfovibrionaceae$ymax - p_alluv_5P_Desulfovibrionaceae$ymin
# restrict to class strata and ribbon heights
p_alluv_5P_Desulfovibrionaceae <- subset(p_alluv_5P_Desulfovibrionaceae, select = c(stratum, height))
# add heights within strata 
E1_5P_Desulfovibrionaceae <-aggregate(
  p_alluv_5P_Desulfovibrionaceae$height,
  by = subset(p_alluv_5P_Desulfovibrionaceae, select = stratum),
  FUN = sum
)

# filter to high protein and Desulfovibrionaceae
p_alluv_10P_Desulfovibrionaceae <-
  p_alluv[p_alluv$stratum == "10P" & p_alluv$fill == "#edb331", ]
# remove (redundant) stratum column (to avoid confusion in merge)
p_alluv_10P_Desulfovibrionaceae <- subset(p_alluv_10P_Desulfovibrionaceae, select = -stratum)

# filter to pathway data for phylum
p_alluv_pathway_Desulfovibrionaceae <-
  p_alluv[p_alluv$x == 3 & p_alluv$fill == "#edb331", ]
# select only alluvia (by which to merge) and class
p_alluv_pathway_Desulfovibrionaceae <- p_alluv_pathway_Desulfovibrionaceae[, c("alluvium", "stratum")]
# merge path data into 10P Desulfovibrionaceae data
p_alluv_10P_Desulfovibrionaceae <-
  merge(p_alluv_10P_Desulfovibrionaceae, p_alluv_pathway_Desulfovibrionaceae, by = "alluvium")

# calculate ribbon heights
p_alluv_10P_Desulfovibrionaceae$height <- p_alluv_10P_Desulfovibrionaceae$ymax - p_alluv_10P_Desulfovibrionaceae$ymin
# restrict to class strata and ribbon heights
p_alluv_10P_Desulfovibrionaceae <- subset(p_alluv_10P_Desulfovibrionaceae, select = c(stratum, height))
# add heights within strata (combine adult and child counts)
E1_10P_Desulfovibrionaceae <-aggregate(
  p_alluv_10P_Desulfovibrionaceae$height,
  by = subset(p_alluv_10P_Desulfovibrionaceae, select = stratum),
  FUN = sum
)

#Export_Desulfovibrionaceae
E1_2.5P_Desulfovibrionaceae
E1_5P_Desulfovibrionaceae
E1_10P_Desulfovibrionaceae

# filter to low protein and Helicobacteraceae
p_alluv_2.5P_Helicobacteraceae <-
  p_alluv[p_alluv$stratum == "2.5P" & p_alluv$fill == "#ff875e", ]
# remove (redundant) stratum column (to avoid confusion in merge)
p_alluv_2.5P_Helicobacteraceae <- subset(p_alluv_2.5P_Helicobacteraceae, select = -stratum)

# filter to pathway data for phylum
p_alluv_pathway_Helicobacteraceae <-
  p_alluv[p_alluv$x == 3 & p_alluv$fill == "#ff875e", ]
# select only alluvia (by which to merge) and class
p_alluv_pathway_Helicobacteraceae <- p_alluv_pathway_Helicobacteraceae[, c("alluvium", "stratum")]
# merge path data into 2.5P Helicobacteraceae data
p_alluv_2.5P_Helicobacteraceae <-
  merge(p_alluv_2.5P_Helicobacteraceae, p_alluv_pathway_Helicobacteraceae, by = "alluvium")

# calculate ribbon heights
p_alluv_2.5P_Helicobacteraceae$height <- p_alluv_2.5P_Helicobacteraceae$ymax - p_alluv_2.5P_Helicobacteraceae$ymin
# restrict to class strata and ribbon heights
p_alluv_2.5P_Helicobacteraceae <- subset(p_alluv_2.5P_Helicobacteraceae, select = c(stratum, height))
# add heights within strata 
E1_2.5P_Helicobacteraceae <- aggregate(
  p_alluv_2.5P_Helicobacteraceae$height,
  by = subset(p_alluv_2.5P_Helicobacteraceae, select = stratum),
  FUN = sum
)


# filter to medium protein and Helicobacteraceae
p_alluv_5P_Helicobacteraceae <-
  p_alluv[p_alluv$stratum == "5P" & p_alluv$fill == "#ff875e", ]
# remove (redundant) stratum column (to avoid confusion in merge)
p_alluv_5P_Helicobacteraceae <- subset(p_alluv_5P_Helicobacteraceae, select = -stratum)

# filter to pathway data for phylum
p_alluv_pathway_Helicobacteraceae <-
  p_alluv[p_alluv$x == 3 & p_alluv$fill == "#ff875e", ]
# select only alluvia (by which to merge) and class
p_alluv_pathway_Helicobacteraceae <- p_alluv_pathway_Helicobacteraceae[, c("alluvium", "stratum")]
# merge path data into 5P Helicobacteraceae data
p_alluv_5P_Helicobacteraceae <-
  merge(p_alluv_5P_Helicobacteraceae, p_alluv_pathway_Helicobacteraceae, by = "alluvium")

# calculate ribbon heights
p_alluv_5P_Helicobacteraceae$height <- p_alluv_5P_Helicobacteraceae$ymax - p_alluv_5P_Helicobacteraceae$ymin
# restrict to class strata and ribbon heights
p_alluv_5P_Helicobacteraceae <- subset(p_alluv_5P_Helicobacteraceae, select = c(stratum, height))
# add heights within strata 
E1_5P_Helicobacteraceae <-aggregate(
  p_alluv_5P_Helicobacteraceae$height,
  by = subset(p_alluv_5P_Helicobacteraceae, select = stratum),
  FUN = sum
)

# filter to high protein and Helicobacteraceae
p_alluv_10P_Helicobacteraceae <-
  p_alluv[p_alluv$stratum == "10P" & p_alluv$fill == "#ff875e", ]
# remove (redundant) stratum column (to avoid confusion in merge)
p_alluv_10P_Helicobacteraceae <- subset(p_alluv_10P_Helicobacteraceae, select = -stratum)

# filter to pathway data for phylum
p_alluv_pathway_Helicobacteraceae <-
  p_alluv[p_alluv$x == 3 & p_alluv$fill == "#ff875e", ]
# select only alluvia (by which to merge) and class
p_alluv_pathway_Helicobacteraceae <- p_alluv_pathway_Helicobacteraceae[, c("alluvium", "stratum")]
# merge path data into 10P Helicobacteraceae data
p_alluv_10P_Helicobacteraceae <-
  merge(p_alluv_10P_Helicobacteraceae, p_alluv_pathway_Helicobacteraceae, by = "alluvium")

# calculate ribbon heights
p_alluv_10P_Helicobacteraceae$height <- p_alluv_10P_Helicobacteraceae$ymax - p_alluv_10P_Helicobacteraceae$ymin
# restrict to class strata and ribbon heights
p_alluv_10P_Helicobacteraceae <- subset(p_alluv_10P_Helicobacteraceae, select = c(stratum, height))
# add heights within strata (combine adult and child counts)
E1_10P_Helicobacteraceae <-aggregate(
  p_alluv_10P_Helicobacteraceae$height,
  by = subset(p_alluv_10P_Helicobacteraceae, select = stratum),
  FUN = sum
)

#Export_Helicobacteraceae
E1_2.5P_Helicobacteraceae
E1_5P_Helicobacteraceae
E1_10P_Helicobacteraceae



```








Now lets look deeper at the steps being used in each pathway
```{r}
#Plot em
#E1 proteobacteria overall
E1_proteobacteria <- ggplot(as.data.frame(E1_sankey_proteobacteria),
       aes(y = Abundance, axis1 = family, axis2 = Percent_Protein, axis3 = pathway, axis4 = MostLikelySeriesofStepsinPathway)) +
  geom_alluvium(aes(fill = pathway), width = 1/12)+
    geom_stratum(width = 1/12, fill = "black", color = "white") +
  geom_label(stat = "stratum", aes(label = after_stat(stratum))) +
  scale_x_discrete(limits = c("family", "Percent_Protein", "pathway","MostLikelySeriesofStepsinPathway" ), expand = c(.05, .05)) +
scale_fill_manual(values = ESS_pathwayColor) +
  ggtitle("Synthetic Treatment: Phylum proteobacteria \n only med-high gapmind confidence scores") +
theme_bw() +
  theme(
    title =element_text(size=22, face='bold'),
    axis.text.x = element_text(color="black", size=14),
    axis.text.y = element_text(color="black", size=16),
    strip.text.y = element_text(color="black", size=16),
    legend.title = element_text(color="black", size=22),
    legend.text = element_text(color="black", size=16),
    legend.position = "right",
    strip.background = element_blank(), #to remove facet wrap title
    strip.text = element_text(size = 20),
    axis.title.x = element_text(color="black", size=22),
    axis.title.y = element_text(color="black", size=22, angle=90),
    panel.grid.major = element_blank(), # switch off major grid lines
   panel.grid.minor = element_blank(), # switch off minor grid lines
    panel.border = element_rect(colour = "black", fill=NA, size=.75)
  )
#CREATE A PDF AND SAVES IT TO THE RIGHT DIRECTORY/FOLDER. 
pdf("/Users/connermertz/Dropbox (vlab)/Conner Mertz/UNM biology/Chapter 1 E1 vs E2/Methods/Metagenomics/methods_DataAnalysis/Metagenomic Pipeline/Plots/SANKEY/proteobacteria/E1_proteobacteria/E1_proteobacteria_alldiets_steps.pdf", height = 20, width = 30)
E1_proteobacteria
dev.off()
```


Now lets look deeper at the steps being used in each pathway but split up by diet
E1 proteobacteria by Percent Protein!
```{r}
#E1_proteobacteria_fill pathway
#2.5P
E1_2.5P_proteobacteria <- ggplot(as.data.frame(E1_sankey_proteobacteria_2.5P),
       aes(y = Abundance, axis1 = family, axis2 = pathway, axis3 = MostLikelySeriesofStepsinPathway)) +
  geom_alluvium(aes(fill = pathway), width = 1/12)+
    geom_stratum(width = 1/12, fill = "black", color = "white") +
  geom_label(stat = "stratum", aes(label = after_stat(stratum))) +
  scale_x_discrete(limits = c("family", "pathway","MostLikelySeriesofStepsinPathway" ), expand = c(.05, .05)) +
  #facet_wrap(~Percent_Protein, scale = "free_x") +
  scale_fill_manual(values = ESS_pathwayColor) +
  ggtitle("Synthetic Treatment: Phylum proteobacteria from 2.5P Diet \nonly med-high gapmind confidence scores") +
theme_bw() +
  theme(
    title =element_text(size=22, face='bold'),
    axis.text.x = element_text(color="black", size=14),
    axis.text.y = element_text(color="black", size=16),
    strip.text.y = element_text(color="black", size=16),
    legend.title = element_text(color="black", size=22),
    legend.text = element_text(color="black", size=16),
    legend.position = "right",
    strip.background = element_blank(), #to remove facet wrap title
    strip.text = element_text(size = 20),
    axis.title.x = element_text(color="black", size=22),
    axis.title.y = element_text(color="black", size=22, angle=90),
    panel.grid.major = element_blank(), # switch off major grid lines
   panel.grid.minor = element_blank(), # switch off minor grid lines
    panel.border = element_rect(colour = "black", fill=NA, size=.75)
  )
#CREATE A PDF AND SAVES IT TO THE RIGHT DIRECTORY/FOLDER. 
pdf("/Users/connermertz/Dropbox (vlab)/Conner Mertz/UNM biology/Chapter 1 E1 vs E2/Methods/Metagenomics/methods_DataAnalysis/Metagenomic Pipeline/Plots/SANKEY/proteobacteria/E1_proteobacteria/E1_proteobacteria_2.5_path_steps.pdf", height = 12, width = 25)
E1_2.5P_proteobacteria
dev.off()

#E1_proteobacteria_fill family
E1_2.5P_proteobacteria <- ggplot(as.data.frame(E1_sankey_proteobacteria_2.5P),
       aes(y = Abundance, axis1 = family, axis2 = pathway, axis3 = MostLikelySeriesofStepsinPathway)) +
  geom_alluvium(aes(fill = family), width = 1/12)+
    geom_stratum(width = 1/12, fill = "black", color = "white") +
  geom_label(stat = "stratum", aes(label = after_stat(stratum))) +
  scale_x_discrete(limits = c("family", "pathway","MostLikelySeriesofStepsinPathway" ), expand = c(.05, .05)) +
scale_fill_manual(values = familyColor) +
  ggtitle("Synthetic Treatment: Phylum proteobacteria from 2.5P Diet \nonly med-high gapmind confidence scores") +
theme_bw() +
  theme(
    title =element_text(size=22, face='bold'),
    axis.text.x = element_text(color="black", size=14),
    axis.text.y = element_text(color="black", size=16),
    strip.text.y = element_text(color="black", size=16),
    legend.title = element_text(color="black", size=22),
    legend.text = element_text(color="black", size=16),
    legend.position = "right",
    strip.background = element_blank(), #to remove facet wrap title
    strip.text = element_text(size = 20),
    axis.title.x = element_text(color="black", size=22),
    axis.title.y = element_text(color="black", size=22, angle=90),
    panel.grid.major = element_blank(), # switch off major grid lines
   panel.grid.minor = element_blank(), # switch off minor grid lines
    panel.border = element_rect(colour = "black", fill=NA, size=.75)
  )
#CREATE A PDF AND SAVES IT TO THE RIGHT DIRECTORY/FOLDER. 
pdf("/Users/connermertz/Dropbox (vlab)/Conner Mertz/UNM biology/Chapter 1 E1 vs E2/Methods/Metagenomics/methods_DataAnalysis/Metagenomic Pipeline/Plots/SANKEY/proteobacteria/E1_proteobacteria/E1_proteobacteria_2.5P_family_steps.pdf", height = 12, width = 25)
E1_2.5P_proteobacteria
dev.off()
```

```{r}
#E1_proteobacteria_fill pathway
#5P
E1_5P_proteobacteria <- ggplot(as.data.frame(E1_sankey_proteobacteria_5P),
       aes(y = Abundance, axis1 = family, axis2 = pathway, axis3 = MostLikelySeriesofStepsinPathway)) +
  geom_alluvium(aes(fill = pathway), width = 1/12)+
    geom_stratum(width = 1/12, fill = "black", color = "white") +
  geom_label(stat = "stratum", aes(label = after_stat(stratum))) +
  scale_x_discrete(limits = c("family", "pathway","MostLikelySeriesofStepsinPathway" ), expand = c(.05, .05)) +
  #facet_wrap(~Percent_Protein, scale = "free_x") +
  scale_fill_manual(values = ESS_pathwayColor) +
  ggtitle("Synthetic Treatment: Phylum proteobacteria from 5P Diet \nonly med-high gapmind confidence scores") +
theme_bw() +
  theme(
    title =element_text(size=22, face='bold'),
    axis.text.x = element_text(color="black", size=14),
    axis.text.y = element_text(color="black", size=16),
    strip.text.y = element_text(color="black", size=16),
    legend.title = element_text(color="black", size=22),
    legend.text = element_text(color="black", size=16),
    legend.position = "right",
    strip.background = element_blank(), #to remove facet wrap title
    strip.text = element_text(size = 20),
    axis.title.x = element_text(color="black", size=22),
    axis.title.y = element_text(color="black", size=22, angle=90),
    panel.grid.major = element_blank(), # switch off major grid lines
   panel.grid.minor = element_blank(), # switch off minor grid lines
    panel.border = element_rect(colour = "black", fill=NA, size=.75)
  )
#CREATE A PDF AND SAVES IT TO THE RIGHT DIRECTORY/FOLDER. 
pdf("/Users/connermertz/Dropbox (vlab)/Conner Mertz/UNM biology/Chapter 1 E1 vs E2/Methods/Metagenomics/methods_DataAnalysis/Metagenomic Pipeline/Plots/SANKEY/proteobacteria/E1_proteobacteria/E1_proteobacteria_5_path_steps.pdf", height = 12, width = 25)
E1_5P_proteobacteria
dev.off()

#E1_proteobacteria_fill family
E1_5P_proteobacteria <- ggplot(as.data.frame(E1_sankey_proteobacteria_5P),
       aes(y = Abundance, axis1 = family, axis2 = pathway, axis3 = MostLikelySeriesofStepsinPathway)) +
  geom_alluvium(aes(fill = family), width = 1/12)+
    geom_stratum(width = 1/12, fill = "black", color = "white") +
  geom_label(stat = "stratum", aes(label = after_stat(stratum))) +
  scale_x_discrete(limits = c("family", "pathway","MostLikelySeriesofStepsinPathway" ), expand = c(.05, .05)) +
scale_fill_manual(values = familyColor) +
  ggtitle("Synthetic Treatment: Phylum proteobacteria from 5P Diet \nonly med-high gapmind confidence scores") +
theme_bw() +
  theme(
    title =element_text(size=22, face='bold'),
    axis.text.x = element_text(color="black", size=14),
    axis.text.y = element_text(color="black", size=16),
    strip.text.y = element_text(color="black", size=16),
    legend.title = element_text(color="black", size=22),
    legend.text = element_text(color="black", size=16),
    legend.position = "right",
    strip.background = element_blank(), #to remove facet wrap title
    strip.text = element_text(size = 20),
    axis.title.x = element_text(color="black", size=22),
    axis.title.y = element_text(color="black", size=22, angle=90),
    panel.grid.major = element_blank(), # switch off major grid lines
   panel.grid.minor = element_blank(), # switch off minor grid lines
    panel.border = element_rect(colour = "black", fill=NA, size=.75)
  )
#CREATE A PDF AND SAVES IT TO THE RIGHT DIRECTORY/FOLDER. 
pdf("/Users/connermertz/Dropbox (vlab)/Conner Mertz/UNM biology/Chapter 1 E1 vs E2/Methods/Metagenomics/methods_DataAnalysis/Metagenomic Pipeline/Plots/SANKEY/proteobacteria/E1_proteobacteria/E1_proteobacteria_5P_family_steps.pdf", height = 12, width = 25)
E1_5P_proteobacteria
dev.off()
```

```{r}
#E1_proteobacteria_fill pathway
#10P
E1_10P_proteobacteria <- ggplot(as.data.frame(E1_sankey_proteobacteria_10P),
       aes(y = Abundance, axis1 = family, axis2 = pathway, axis3 = MostLikelySeriesofStepsinPathway)) +
  geom_alluvium(aes(fill = pathway), width = 1/12)+
    geom_stratum(width = 1/12, fill = "black", color = "white") +
  geom_label(stat = "stratum", aes(label = after_stat(stratum))) +
  scale_x_discrete(limits = c("family", "pathway","MostLikelySeriesofStepsinPathway" ), expand = c(.05, .05)) +
  #facet_wrap(~Percent_Protein, scale = "free_x") +
  scale_fill_manual(values = ESS_pathwayColor) +
  ggtitle("Synthetic Treatment: Phylum proteobacteria from 10P Diet \nonly med-high gapmind confidence scores") +
theme_bw() +
  theme(
    title =element_text(size=22, face='bold'),
    axis.text.x = element_text(color="black", size=14),
    axis.text.y = element_text(color="black", size=16),
    strip.text.y = element_text(color="black", size=16),
    legend.title = element_text(color="black", size=22),
    legend.text = element_text(color="black", size=16),
    legend.position = "right",
    strip.background = element_blank(), #to remove facet wrap title
    strip.text = element_text(size = 20),
    axis.title.x = element_text(color="black", size=22),
    axis.title.y = element_text(color="black", size=22, angle=90),
    panel.grid.major = element_blank(), # switch off major grid lines
   panel.grid.minor = element_blank(), # switch off minor grid lines
    panel.border = element_rect(colour = "black", fill=NA, size=.75)
  )
#CREATE A PDF AND SAVES IT TO THE RIGHT DIRECTORY/FOLDER. 
pdf("/Users/connermertz/Dropbox (vlab)/Conner Mertz/UNM biology/Chapter 1 E1 vs E2/Methods/Metagenomics/methods_DataAnalysis/Metagenomic Pipeline/Plots/SANKEY/proteobacteria/E1_proteobacteria/E1_proteobacteria_10_path_steps.pdf", height = 12, width = 25)
E1_10P_proteobacteria
dev.off()

#E1_proteobacteria_fill family
E1_10P_proteobacteria <- ggplot(as.data.frame(E1_sankey_proteobacteria_10P),
       aes(y = Abundance, axis1 = family, axis2 = pathway, axis3 = MostLikelySeriesofStepsinPathway)) +
  geom_alluvium(aes(fill = family), width = 1/12)+
    geom_stratum(width = 1/12, fill = "black", color = "white") +
  geom_label(stat = "stratum", aes(label = after_stat(stratum))) +
  scale_x_discrete(limits = c("family", "pathway","MostLikelySeriesofStepsinPathway" ), expand = c(.05, .05)) +
scale_fill_manual(values = familyColor) +
  ggtitle("Synthetic Treatment: Phylum proteobacteria from 10P Diet \nonly med-high gapmind confidence scores") +
theme_bw() +
  theme(
    title =element_text(size=22, face='bold'),
    axis.text.x = element_text(color="black", size=14),
    axis.text.y = element_text(color="black", size=16),
    strip.text.y = element_text(color="black", size=16),
    legend.title = element_text(color="black", size=22),
    legend.text = element_text(color="black", size=16),
    legend.position = "right",
    strip.background = element_blank(), #to remove facet wrap title
    strip.text = element_text(size = 20),
    axis.title.x = element_text(color="black", size=22),
    axis.title.y = element_text(color="black", size=22, angle=90),
    panel.grid.major = element_blank(), # switch off major grid lines
   panel.grid.minor = element_blank(), # switch off minor grid lines
    panel.border = element_rect(colour = "black", fill=NA, size=.75)
  )
#CREATE A PDF AND SAVES IT TO THE RIGHT DIRECTORY/FOLDER. 
pdf("/Users/connermertz/Dropbox (vlab)/Conner Mertz/UNM biology/Chapter 1 E1 vs E2/Methods/Metagenomics/methods_DataAnalysis/Metagenomic Pipeline/Plots/SANKEY/proteobacteria/E1_proteobacteria/E1_proteobacteria_10P_family_steps.pdf", height = 12, width = 25)
E1_10P_proteobacteria
dev.off()
```













###########E2#################
Phylum of interest
```{r}
#filter out phylum of interest in E2
E2_sankey_bacteroidetes <- E2_sankey %>% filter(phylum== "Bacteroidetes") #keep only bacteroidetes
E2_sankey_bacteroidetes <- E2_sankey_bacteroidetes %>% filter(family!= "no_support") #remove family with no support
  E2_sankey_bacteroidetes_2.5P <- E2_sankey_bacteroidetes %>% filter(Percent_Protein== "2.5P") #filter        percent_Protein
  E2_sankey_bacteroidetes_5P <- E2_sankey_bacteroidetes %>% filter(Percent_Protein== "5P") #filter percent_Protein
  E2_sankey_bacteroidetes_2.5P <- E2_sankey_bacteroidetes %>% filter(Percent_Protein== "2.5P") #filter percent_Protein
  E2_sankey_bacteroidetes_10P <- E2_sankey_bacteroidetes %>% filter(Percent_Protein== "10P") #filter percent_Protein

#filter out phylum of interest in E1
E2_sankey_firmicutes <- E2_sankey %>% filter(phylum== "Firmicutes") #keep only bacteroidetes
E2_sankey_firmicutes <- E2_sankey_firmicutes %>% filter(family!= "no_support") #remove family with no support
  E2_sankey_firmicutes_2.5P <- E2_sankey_firmicutes %>% filter(Percent_Protein== "2.5P") #filter percent_Protein
  E2_sankey_firmicutes_5P <- E2_sankey_firmicutes %>% filter(Percent_Protein== "5P") #filter percent_Protein
  E2_sankey_firmicutes_10P <- E2_sankey_firmicutes %>% filter(Percent_Protein== "10P") #filter percent_Protein

#filter out phylum of interest in E1
E2_sankey_proteobacteria <- E2_sankey %>% filter(phylum== "Proteobacteria") #keep only bacteroidetes
E2_sankey_proteobacteria <- E2_sankey_proteobacteria %>% filter(family!= "no_support") #remove family with no support
  E2_sankey_proteobacteria_2.5P <- E2_sankey_proteobacteria %>% filter(Percent_Protein== "2.5P") #filter percent_Protein
  E2_sankey_proteobacteria_5P <- E2_sankey_proteobacteria %>% filter(Percent_Protein== "5P") #filter percent_Protein
  E2_sankey_proteobacteria_10P <- E2_sankey_proteobacteria %>% filter(Percent_Protein== "10P") #filter percent_Protein
```

##########
#############E2#############
Bacteroidetes

E2_Bacteroidetes overall for paper pathway
```{r}
#Plot em
#E2 bacteroidetes overall for paper
E2_bacteroidetes <- ggplot(as.data.frame(E2_sankey_bacteroidetes),
       aes(y = Abundance, axis1 = family, axis2 = Percent_Protein, axis3 = pathway)) +
  geom_alluvium(aes(fill = pathway), width = 1/12)+
    geom_stratum(width = 1/12, fill = "black", color = "white") +
  geom_label(stat = "stratum", aes(label = after_stat(stratum))) +
  scale_x_discrete(limits = c("family", "Percent_Protein", "pathway"), expand = c(.05, .05)) +
scale_fill_manual(values = ESS_pathwayColor) +
  ggtitle("Semi-Natural Treatment: Phylum Bacteroidetes \n only med-high gapmind confidence scores") +
theme_bw() +
  theme(
    title =element_text(size=22, face='bold'),
    axis.text.x = element_text(color="black", size=14),
    axis.text.y = element_text(color="black", size=16),
    strip.text.y = element_text(color="black", size=16),
    legend.title = element_text(color="black", size=22),
    legend.text = element_text(color="black", size=16),
    legend.position = "right",
    strip.background = element_blank(), #to remove facet wrap title
    strip.text = element_text(size = 20),
    axis.title.x = element_text(color="black", size=22),
    axis.title.y = element_text(color="black", size=22, angle=90),
    panel.grid.major = element_blank(), # switch off major grid lines
   panel.grid.minor = element_blank(), # switch off minor grid lines
    panel.border = element_rect(colour = "black", fill=NA, size=.75)
  )
#CREATE A PDF AND SAVES IT TO THE RIGHT DIRECTORY/FOLDER. 
pdf("/Users/connermertz/Dropbox (vlab)/Conner Mertz/UNM biology/Chapter 1 E1 vs E2/Methods/Metagenomics/methods_DataAnalysis/Metagenomic Pipeline/Plots/SANKEY/Bacteroidetes/E2_Bacteroidetes/E2_bacteroidetes_alldiets.pdf", height = 12, width = 16)
E2_bacteroidetes
dev.off()
```

E2_Bacteroidetes overall for paper family
```{r}
#Plot em
#E2 bacteroidetes overall for paper
E2_bacteroidetes <- ggplot(as.data.frame(E2_sankey_bacteroidetes),
       aes(y = Abundance, axis1 = family, axis2 = Percent_Protein, axis3 = pathway)) +
  geom_alluvium(aes(fill = family), width = 1/12)+
    geom_stratum(width = 1/12, fill = "black", color = "white") +
  geom_label(stat = "stratum", aes(label = after_stat(stratum))) +
  scale_x_discrete(limits = c("family", "Percent_Protein", "pathway"), expand = c(.05, .05)) +
scale_fill_manual(values = familyColor) +
  ggtitle("Semi-Natural Treatment: Phylum Bacteroidetes \n only med-high gapmind confidence scores") +
theme_bw() +
  theme(
    title =element_text(size=22, face='bold'),
    axis.text.x = element_text(color="black", size=14),
    axis.text.y = element_text(color="black", size=16),
    strip.text.y = element_text(color="black", size=16),
    legend.title = element_text(color="black", size=22),
    legend.text = element_text(color="black", size=16),
    legend.position = "right",
    strip.background = element_blank(), #to remove facet wrap title
    strip.text = element_text(size = 20),
    axis.title.x = element_text(color="black", size=22),
    axis.title.y = element_text(color="black", size=22, angle=90),
    panel.grid.major = element_blank(), # switch off major grid lines
   panel.grid.minor = element_blank(), # switch off minor grid lines
    panel.border = element_rect(colour = "black", fill=NA, size=.75)
  )
#CREATE A PDF AND SAVES IT TO THE RIGHT DIRECTORY/FOLDER. 
pdf("/Users/connermertz/Dropbox (vlab)/Conner Mertz/UNM biology/Chapter 1 E1 vs E2/Methods/Metagenomics/methods_DataAnalysis/Metagenomic Pipeline/Plots/SANKEY/Bacteroidetes/E2_Bacteroidetes/E2_bacteroidetes_alldiets_family_steps_steps.pdf", height = 12, width = 16)
E2_bacteroidetes
#dev.off()
```


Lets export the curve heights for each family belonging to phylum Bacteroidetes by diet in E2
```{r}
# recover the built plot
p_build <- ggplot_build(E2_bacteroidetes)
# extract the data for the alluvium graphical objects
p_alluv <- p_build$data[[1L]]
# what are the fill colors
unique(p_alluv$fill)
#"#00226b" "#85003d" "#01b1f4" "#b35a58" "#54b543"
    #familyColor <- c(Bacteroidaceae= "#00226b",
                      #Muribaculaceae= "#85003d",
                      #Porphyromonadaceae= "#01b1f4",
                      #Rikenellaceae= "#b35a58",
                      #Tannerellaceae= "#54b543")

```




Now lets look deeper at the steps being used in each pathway
```{r}
#Plot em
#E2 bacteroidetes overall
E2_bacteroidetes <- ggplot(as.data.frame(E2_sankey_bacteroidetes),
       aes(y = Abundance, axis1 = family, axis2 = Percent_Protein, axis3 = pathway, axis4 = MostLikelySeriesofStepsinPathway)) +
  geom_alluvium(aes(fill = pathway), width = 1/12)+
    geom_stratum(width = 1/12, fill = "black", color = "white") +
  geom_label(stat = "stratum", aes(label = after_stat(stratum))) +
  scale_x_discrete(limits = c("family", "Percent_Protein", "pathway","MostLikelySeriesofStepsinPathway" ), expand = c(.05, .05)) +
scale_fill_manual(values = ESS_pathwayColor) +
  ggtitle("Semi-Natural Treatment: Phylum Bacteroidetes \n only med-high gapmind confidence scores") +
theme_bw() +
  theme(
    title =element_text(size=22, face='bold'),
    axis.text.x = element_text(color="black", size=14),
    axis.text.y = element_text(color="black", size=16),
    strip.text.y = element_text(color="black", size=16),
    legend.title = element_text(color="black", size=22),
    legend.text = element_text(color="black", size=16),
    legend.position = "right",
    strip.background = element_blank(), #to remove facet wrap title
    strip.text = element_text(size = 20),
    axis.title.x = element_text(color="black", size=22),
    axis.title.y = element_text(color="black", size=22, angle=90),
    panel.grid.major = element_blank(), # switch off major grid lines
   panel.grid.minor = element_blank(), # switch off minor grid lines
    panel.border = element_rect(colour = "black", fill=NA, size=.75)
  )
#CREATE A PDF AND SAVES IT TO THE RIGHT DIRECTORY/FOLDER. 
pdf("/Users/connermertz/Dropbox (vlab)/Conner Mertz/UNM biology/Chapter 1 E1 vs E2/Methods/Metagenomics/methods_DataAnalysis/Metagenomic Pipeline/Plots/SANKEY/Bacteroidetes/E2_Bacteroidetes/E2_bacteroidetes_alldiets_steps.pdf", height = 20, width = 30)
E2_bacteroidetes
dev.off()
```


Now lets look deeper at the steps being used in each pathway but split up by diet
E2 Bacteroidetes by Percent Protein!
```{r}
#E2_Bacteroidetes_fill pathway
#2.5P
E2_2.5P_bacteroidetes <- ggplot(as.data.frame(E2_sankey_bacteroidetes_2.5P),
       aes(y = Abundance, axis1 = family, axis2 = pathway, axis3 = MostLikelySeriesofStepsinPathway)) +
  geom_alluvium(aes(fill = pathway), width = 1/12)+
    geom_stratum(width = 1/12, fill = "black", color = "white") +
  geom_label(stat = "stratum", aes(label = after_stat(stratum))) +
  scale_x_discrete(limits = c("family", "pathway","MostLikelySeriesofStepsinPathway" ), expand = c(.05, .05)) +
  #facet_wrap(~Percent_Protein, scale = "free_x") +
  scale_fill_manual(values = ESS_pathwayColor) +
  ggtitle("Semi-Natural Treatment: Phylum Bacteroidetes from 2.5P Diet \nonly med-high gapmind confidence scores") +
theme_bw() +
  theme(
    title =element_text(size=22, face='bold'),
    axis.text.x = element_text(color="black", size=14),
    axis.text.y = element_text(color="black", size=16),
    strip.text.y = element_text(color="black", size=16),
    legend.title = element_text(color="black", size=22),
    legend.text = element_text(color="black", size=16),
    legend.position = "right",
    strip.background = element_blank(), #to remove facet wrap title
    strip.text = element_text(size = 20),
    axis.title.x = element_text(color="black", size=22),
    axis.title.y = element_text(color="black", size=22, angle=90),
    panel.grid.major = element_blank(), # switch off major grid lines
   panel.grid.minor = element_blank(), # switch off minor grid lines
    panel.border = element_rect(colour = "black", fill=NA, size=.75)
  )
#CREATE A PDF AND SAVES IT TO THE RIGHT DIRECTORY/FOLDER. 
pdf("/Users/connermertz/Dropbox (vlab)/Conner Mertz/UNM biology/Chapter 1 E1 vs E2/Methods/Metagenomics/methods_DataAnalysis/Metagenomic Pipeline/Plots/SANKEY/Bacteroidetes/E2_Bacteroidetes/E2_bacteroidetes_2.5_path_steps.pdf", height = 12, width = 25)
E2_2.5P_bacteroidetes
dev.off()

#E2_Bacteroidetes_fill family
E2_2.5P_bacteroidetes <- ggplot(as.data.frame(E2_sankey_bacteroidetes_2.5P),
       aes(y = Abundance, axis1 = family, axis2 = pathway, axis3 = MostLikelySeriesofStepsinPathway)) +
  geom_alluvium(aes(fill = family), width = 1/12)+
    geom_stratum(width = 1/12, fill = "black", color = "white") +
  geom_label(stat = "stratum", aes(label = after_stat(stratum))) +
  scale_x_discrete(limits = c("family", "pathway","MostLikelySeriesofStepsinPathway" ), expand = c(.05, .05)) +
scale_fill_manual(values = familyColor) +
  ggtitle("Semi-Natural Treatment: Phylum Bacteroidetes from 2.5P Diet \nonly med-high gapmind confidence scores") +
theme_bw() +
  theme(
    title =element_text(size=22, face='bold'),
    axis.text.x = element_text(color="black", size=14),
    axis.text.y = element_text(color="black", size=16),
    strip.text.y = element_text(color="black", size=16),
    legend.title = element_text(color="black", size=22),
    legend.text = element_text(color="black", size=16),
    legend.position = "right",
    strip.background = element_blank(), #to remove facet wrap title
    strip.text = element_text(size = 20),
    axis.title.x = element_text(color="black", size=22),
    axis.title.y = element_text(color="black", size=22, angle=90),
    panel.grid.major = element_blank(), # switch off major grid lines
   panel.grid.minor = element_blank(), # switch off minor grid lines
    panel.border = element_rect(colour = "black", fill=NA, size=.75)
  )
#CREATE A PDF AND SAVES IT TO THE RIGHT DIRECTORY/FOLDER. 
pdf("/Users/connermertz/Dropbox (vlab)/Conner Mertz/UNM biology/Chapter 1 E1 vs E2/Methods/Metagenomics/methods_DataAnalysis/Metagenomic Pipeline/Plots/SANKEY/Bacteroidetes/E2_Bacteroidetes/E2_bacteroidetes_2.5P_family_steps.pdf", height = 12, width = 25)
E2_2.5P_bacteroidetes
dev.off()
```

```{r}
#E2_Bacteroidetes_fill pathway
#5P
E2_5P_bacteroidetes <- ggplot(as.data.frame(E2_sankey_bacteroidetes_5P),
       aes(y = Abundance, axis1 = family, axis2 = pathway, axis3 = MostLikelySeriesofStepsinPathway)) +
  geom_alluvium(aes(fill = pathway), width = 1/12)+
    geom_stratum(width = 1/12, fill = "black", color = "white") +
  geom_label(stat = "stratum", aes(label = after_stat(stratum))) +
  scale_x_discrete(limits = c("family", "pathway","MostLikelySeriesofStepsinPathway" ), expand = c(.05, .05)) +
  #facet_wrap(~Percent_Protein, scale = "free_x") +
  scale_fill_manual(values = ESS_pathwayColor) +
  ggtitle("Semi-Natural Treatment: Phylum Bacteroidetes from 5P Diet \nonly med-high gapmind confidence scores") +
theme_bw() +
  theme(
    title =element_text(size=22, face='bold'),
    axis.text.x = element_text(color="black", size=14),
    axis.text.y = element_text(color="black", size=16),
    strip.text.y = element_text(color="black", size=16),
    legend.title = element_text(color="black", size=22),
    legend.text = element_text(color="black", size=16),
    legend.position = "right",
    strip.background = element_blank(), #to remove facet wrap title
    strip.text = element_text(size = 20),
    axis.title.x = element_text(color="black", size=22),
    axis.title.y = element_text(color="black", size=22, angle=90),
    panel.grid.major = element_blank(), # switch off major grid lines
   panel.grid.minor = element_blank(), # switch off minor grid lines
    panel.border = element_rect(colour = "black", fill=NA, size=.75)
  )
#CREATE A PDF AND SAVES IT TO THE RIGHT DIRECTORY/FOLDER. 
pdf("/Users/connermertz/Dropbox (vlab)/Conner Mertz/UNM biology/Chapter 1 E1 vs E2/Methods/Metagenomics/methods_DataAnalysis/Metagenomic Pipeline/Plots/SANKEY/Bacteroidetes/E2_Bacteroidetes/E2_bacteroidetes_5_path_steps.pdf", height = 12, width = 25)
E2_5P_bacteroidetes
dev.off()

#E2_Bacteroidetes_fill family
E2_5P_bacteroidetes <- ggplot(as.data.frame(E2_sankey_bacteroidetes_5P),
       aes(y = Abundance, axis1 = family, axis2 = pathway, axis3 = MostLikelySeriesofStepsinPathway)) +
  geom_alluvium(aes(fill = family), width = 1/12)+
    geom_stratum(width = 1/12, fill = "black", color = "white") +
  geom_label(stat = "stratum", aes(label = after_stat(stratum))) +
  scale_x_discrete(limits = c("family", "pathway","MostLikelySeriesofStepsinPathway" ), expand = c(.05, .05)) +
scale_fill_manual(values = familyColor) +
  ggtitle("Semi-Natural Treatment: Phylum Bacteroidetes from 5P Diet \nonly med-high gapmind confidence scores") +
theme_bw() +
  theme(
    title =element_text(size=22, face='bold'),
    axis.text.x = element_text(color="black", size=14),
    axis.text.y = element_text(color="black", size=16),
    strip.text.y = element_text(color="black", size=16),
    legend.title = element_text(color="black", size=22),
    legend.text = element_text(color="black", size=16),
    legend.position = "right",
    strip.background = element_blank(), #to remove facet wrap title
    strip.text = element_text(size = 20),
    axis.title.x = element_text(color="black", size=22),
    axis.title.y = element_text(color="black", size=22, angle=90),
    panel.grid.major = element_blank(), # switch off major grid lines
   panel.grid.minor = element_blank(), # switch off minor grid lines
    panel.border = element_rect(colour = "black", fill=NA, size=.75)
  )
#CREATE A PDF AND SAVES IT TO THE RIGHT DIRECTORY/FOLDER. 
pdf("/Users/connermertz/Dropbox (vlab)/Conner Mertz/UNM biology/Chapter 1 E1 vs E2/Methods/Metagenomics/methods_DataAnalysis/Metagenomic Pipeline/Plots/SANKEY/Bacteroidetes/E2_Bacteroidetes/E2_bacteroidetes_5P_family_steps.pdf", height = 12, width = 25)
E2_5P_bacteroidetes
dev.off()
```

```{r}
#E2_Bacteroidetes_fill pathway
#10P
E2_10P_bacteroidetes <- ggplot(as.data.frame(E2_sankey_bacteroidetes_10P),
       aes(y = Abundance, axis1 = family, axis2 = pathway, axis3 = MostLikelySeriesofStepsinPathway)) +
  geom_alluvium(aes(fill = pathway), width = 1/12)+
    geom_stratum(width = 1/12, fill = "black", color = "white") +
  geom_label(stat = "stratum", aes(label = after_stat(stratum))) +
  scale_x_discrete(limits = c("family", "pathway","MostLikelySeriesofStepsinPathway" ), expand = c(.05, .05)) +
  #facet_wrap(~Percent_Protein, scale = "free_x") +
  scale_fill_manual(values = ESS_pathwayColor) +
  ggtitle("Semi-Natural Treatment: Phylum Bacteroidetes from 10P Diet \nonly med-high gapmind confidence scores") +
theme_bw() +
  theme(
    title =element_text(size=22, face='bold'),
    axis.text.x = element_text(color="black", size=14),
    axis.text.y = element_text(color="black", size=16),
    strip.text.y = element_text(color="black", size=16),
    legend.title = element_text(color="black", size=22),
    legend.text = element_text(color="black", size=16),
    legend.position = "right",
    strip.background = element_blank(), #to remove facet wrap title
    strip.text = element_text(size = 20),
    axis.title.x = element_text(color="black", size=22),
    axis.title.y = element_text(color="black", size=22, angle=90),
    panel.grid.major = element_blank(), # switch off major grid lines
   panel.grid.minor = element_blank(), # switch off minor grid lines
    panel.border = element_rect(colour = "black", fill=NA, size=.75)
  )
#CREATE A PDF AND SAVES IT TO THE RIGHT DIRECTORY/FOLDER. 
pdf("/Users/connermertz/Dropbox (vlab)/Conner Mertz/UNM biology/Chapter 1 E1 vs E2/Methods/Metagenomics/methods_DataAnalysis/Metagenomic Pipeline/Plots/SANKEY/Bacteroidetes/E2_Bacteroidetes/E2_bacteroidetes_10_path_steps.pdf", height = 12, width = 25)
E2_10P_bacteroidetes
dev.off()

#E2_Bacteroidetes_fill family
E2_10P_bacteroidetes <- ggplot(as.data.frame(E2_sankey_bacteroidetes_10P),
       aes(y = Abundance, axis1 = family, axis2 = pathway, axis3 = MostLikelySeriesofStepsinPathway)) +
  geom_alluvium(aes(fill = family), width = 1/12)+
    geom_stratum(width = 1/12, fill = "black", color = "white") +
  geom_label(stat = "stratum", aes(label = after_stat(stratum))) +
  scale_x_discrete(limits = c("family", "pathway","MostLikelySeriesofStepsinPathway" ), expand = c(.05, .05)) +
scale_fill_manual(values = familyColor) +
  ggtitle("Semi-Natural Treatment: Phylum Bacteroidetes from 10P Diet \nonly med-high gapmind confidence scores") +
theme_bw() +
  theme(
    title =element_text(size=22, face='bold'),
    axis.text.x = element_text(color="black", size=14),
    axis.text.y = element_text(color="black", size=16),
    strip.text.y = element_text(color="black", size=16),
    legend.title = element_text(color="black", size=22),
    legend.text = element_text(color="black", size=16),
    legend.position = "right",
    strip.background = element_blank(), #to remove facet wrap title
    strip.text = element_text(size = 20),
    axis.title.x = element_text(color="black", size=22),
    axis.title.y = element_text(color="black", size=22, angle=90),
    panel.grid.major = element_blank(), # switch off major grid lines
   panel.grid.minor = element_blank(), # switch off minor grid lines
    panel.border = element_rect(colour = "black", fill=NA, size=.75)
  )
#CREATE A PDF AND SAVES IT TO THE RIGHT DIRECTORY/FOLDER. 
pdf("/Users/connermertz/Dropbox (vlab)/Conner Mertz/UNM biology/Chapter 1 E1 vs E2/Methods/Metagenomics/methods_DataAnalysis/Metagenomic Pipeline/Plots/SANKEY/Bacteroidetes/E2_Bacteroidetes/E2_bacteroidetes_10P_family_steps.pdf", height = 12, width = 25)
E2_10P_bacteroidetes
dev.off()
```









########E2#############
firmicutes

E2_firmicutes overall for paper pathway
```{r}
#Plot em
#E2 firmicutes overall for paper
E2_firmicutes <- ggplot(as.data.frame(E2_sankey_firmicutes),
       aes(y = Abundance, axis1 = family, axis2 = Percent_Protein, axis3 = pathway)) +
  geom_alluvium(aes(fill = pathway), width = 1/12)+
    geom_stratum(width = 1/12, fill = "black", color = "white") +
  geom_label(stat = "stratum", aes(label = after_stat(stratum))) +
  scale_x_discrete(limits = c("family", "Percent_Protein", "pathway"), expand = c(.05, .05)) +
scale_fill_manual(values = ESS_pathwayColor) +
  ggtitle("Semi-Natural Treatment: Phylum firmicutes \n only med-high gapmind confidence scores") +
theme_bw() +
  theme(
    title =element_text(size=22, face='bold'),
    axis.text.x = element_text(color="black", size=14),
    axis.text.y = element_text(color="black", size=16),
    strip.text.y = element_text(color="black", size=16),
    legend.title = element_text(color="black", size=22),
    legend.text = element_text(color="black", size=16),
    legend.position = "right",
    strip.background = element_blank(), #to remove facet wrap title
    strip.text = element_text(size = 20),
    axis.title.x = element_text(color="black", size=22),
    axis.title.y = element_text(color="black", size=22, angle=90),
    panel.grid.major = element_blank(), # switch off major grid lines
   panel.grid.minor = element_blank(), # switch off minor grid lines
    panel.border = element_rect(colour = "black", fill=NA, size=.75)
  )
#CREATE A PDF AND SAVES IT TO THE RIGHT DIRECTORY/FOLDER. 
pdf("/Users/connermertz/Dropbox (vlab)/Conner Mertz/UNM biology/Chapter 1 E1 vs E2/Methods/Metagenomics/methods_DataAnalysis/Metagenomic Pipeline/Plots/SANKEY/firmicutes/E2_firmicutes/E2_firmicutes_alldiets.pdf", height = 12, width = 16)
E2_firmicutes
dev.off()
```

E2_firmicutes overall for paper pathway
```{r}
#Plot em
#E2 firmicutes overall for paper
E2_firmicutes <- ggplot(as.data.frame(E2_sankey_firmicutes),
       aes(y = Abundance, axis1 = family, axis2 = Percent_Protein, axis3 = pathway)) +
  geom_alluvium(aes(fill = family), width = 1/12)+
    geom_stratum(width = 1/12, fill = "black", color = "white") +
  geom_label(stat = "stratum", aes(label = after_stat(stratum))) +
  scale_x_discrete(limits = c("family", "Percent_Protein", "pathway"), expand = c(.05, .05)) +
scale_fill_manual(values = familyColor) +
  ggtitle("Semi-Natural Treatment: Phylum firmicutes \n only med-high gapmind confidence scores") +
theme_bw() +
  theme(
    title =element_text(size=22, face='bold'),
    axis.text.x = element_text(color="black", size=14),
    axis.text.y = element_text(color="black", size=16),
    strip.text.y = element_text(color="black", size=16),
    legend.title = element_text(color="black", size=22),
    legend.text = element_text(color="black", size=16),
    legend.position = "right",
    strip.background = element_blank(), #to remove facet wrap title
    strip.text = element_text(size = 20),
    axis.title.x = element_text(color="black", size=22),
    axis.title.y = element_text(color="black", size=22, angle=90),
    panel.grid.major = element_blank(), # switch off major grid lines
   panel.grid.minor = element_blank(), # switch off minor grid lines
    panel.border = element_rect(colour = "black", fill=NA, size=.75)
  )
#CREATE A PDF AND SAVES IT TO THE RIGHT DIRECTORY/FOLDER. 
#pdf("/Users/connermertz/Dropbox (vlab)/Conner Mertz/UNM biology/Chapter 1 E1 vs E2/Methods/Metagenomics/methods_DataAnalysis/Metagenomic Pipeline/Plots/SANKEY/firmicutes/E2_firmicutes/E2_firmicutes_alldiets_family_steps.pdf", height = 12, width = 16)
E2_firmicutes
#dev.off()
```

Lets export the curve heights for each family belonging to phylum firmicutes by diet in E2

```{r}
# recover the built plot
p_build <- ggplot_build(E2_firmicutes)
# extract the data for the alluvium graphical objects
p_alluv <- p_build$data[[1L]]
# what are the fill colors
unique(p_alluv$fill)
#   "#c6b0ff" "#f6477f" "#623d00"   
      #Enterococcaceae= "#c6b0ff"
      #Lachnospiraceae= "#f6477f",
      #Lactobacillaceae= "#623d00",


# filter to low protein and Enterococcaceae
p_alluv_2.5P_Enterococcaceae <-
  p_alluv[p_alluv$stratum == "2.5P" & p_alluv$fill == "#c6b0ff", ]
# remove (redundant) stratum column (to avoid confusion in merge)
p_alluv_2.5P_Enterococcaceae <- subset(p_alluv_2.5P_Enterococcaceae, select = -stratum)

# filter to pathway data for phylum
p_alluv_pathway_Enterococcaceae <-
  p_alluv[p_alluv$x == 3 & p_alluv$fill == "#c6b0ff", ]
# select only alluvia (by which to merge) and class
p_alluv_pathway_Enterococcaceae <- p_alluv_pathway_Enterococcaceae[, c("alluvium", "stratum")]
# merge path data into 2.5P Enterococcaceae data
p_alluv_2.5P_Enterococcaceae <-
  merge(p_alluv_2.5P_Enterococcaceae, p_alluv_pathway_Enterococcaceae, by = "alluvium")

# calculate ribbon heights
p_alluv_2.5P_Enterococcaceae$height <- p_alluv_2.5P_Enterococcaceae$ymax - p_alluv_2.5P_Enterococcaceae$ymin
# restrict to class strata and ribbon heights
p_alluv_2.5P_Enterococcaceae <- subset(p_alluv_2.5P_Enterococcaceae, select = c(stratum, height))
# add heights within strata 
E2_2.5P_Enterococcaceae <- aggregate(
  p_alluv_2.5P_Enterococcaceae$height,
  by = subset(p_alluv_2.5P_Enterococcaceae, select = stratum),
  FUN = sum
)


# filter to medium protein and Enterococcaceae
p_alluv_5P_Enterococcaceae <-
  p_alluv[p_alluv$stratum == "5P" & p_alluv$fill == "#c6b0ff", ]
# remove (redundant) stratum column (to avoid confusion in merge)
p_alluv_5P_Enterococcaceae <- subset(p_alluv_5P_Enterococcaceae, select = -stratum)

# filter to pathway data for phylum
p_alluv_pathway_Enterococcaceae <-
  p_alluv[p_alluv$x == 3 & p_alluv$fill == "#c6b0ff", ]
# select only alluvia (by which to merge) and class
p_alluv_pathway_Enterococcaceae <- p_alluv_pathway_Enterococcaceae[, c("alluvium", "stratum")]
# merge path data into 5P Enterococcaceae data
p_alluv_5P_Enterococcaceae <-
  merge(p_alluv_5P_Enterococcaceae, p_alluv_pathway_Enterococcaceae, by = "alluvium")

# calculate ribbon heights
p_alluv_5P_Enterococcaceae$height <- p_alluv_5P_Enterococcaceae$ymax - p_alluv_5P_Enterococcaceae$ymin
# restrict to class strata and ribbon heights
p_alluv_5P_Enterococcaceae <- subset(p_alluv_5P_Enterococcaceae, select = c(stratum, height))
# add heights within strata 
E2_5P_Enterococcaceae <-aggregate(
  p_alluv_5P_Enterococcaceae$height,
  by = subset(p_alluv_5P_Enterococcaceae, select = stratum),
  FUN = sum
)

# filter to high protein and Enterococcaceae
p_alluv_10P_Enterococcaceae <-
  p_alluv[p_alluv$stratum == "10P" & p_alluv$fill == "#c6b0ff", ]
# remove (redundant) stratum column (to avoid confusion in merge)
p_alluv_10P_Enterococcaceae <- subset(p_alluv_10P_Enterococcaceae, select = -stratum)

# filter to pathway data for phylum
p_alluv_pathway_Enterococcaceae <-
  p_alluv[p_alluv$x == 3 & p_alluv$fill == "#c6b0ff", ]
# select only alluvia (by which to merge) and class
p_alluv_pathway_Enterococcaceae <- p_alluv_pathway_Enterococcaceae[, c("alluvium", "stratum")]
# merge path data into 10P Enterococcaceae data
p_alluv_10P_Enterococcaceae <-
  merge(p_alluv_10P_Enterococcaceae, p_alluv_pathway_Enterococcaceae, by = "alluvium")

# calculate ribbon heights
p_alluv_10P_Enterococcaceae$height <- p_alluv_10P_Enterococcaceae$ymax - p_alluv_10P_Enterococcaceae$ymin
# restrict to class strata and ribbon heights
p_alluv_10P_Enterococcaceae <- subset(p_alluv_10P_Enterococcaceae, select = c(stratum, height))
# add heights within strata (combine adult and child counts)
E2_10P_Enterococcaceae <-aggregate(
  p_alluv_10P_Enterococcaceae$height,
  by = subset(p_alluv_10P_Enterococcaceae, select = stratum),
  FUN = sum
)

#Export_Enterococcaceae
E2_2.5P_Enterococcaceae
E2_5P_Enterococcaceae
E2_10P_Enterococcaceae


# filter to low protein and Lachnospiraceae
p_alluv_2.5P_Lachnospiraceae <-
  p_alluv[p_alluv$stratum == "2.5P" & p_alluv$fill == "#f6477f", ]
# remove (redundant) stratum column (to avoid confusion in merge)
p_alluv_2.5P_Lachnospiraceae <- subset(p_alluv_2.5P_Lachnospiraceae, select = -stratum)

# filter to pathway data for phylum
p_alluv_pathway_Lachnospiraceae <-
  p_alluv[p_alluv$x == 3 & p_alluv$fill == "#f6477f", ]
# select only alluvia (by which to merge) and class
p_alluv_pathway_Lachnospiraceae <- p_alluv_pathway_Lachnospiraceae[, c("alluvium", "stratum")]
# merge path data into 2.5P Lachnospiraceae data
p_alluv_2.5P_Lachnospiraceae <-
  merge(p_alluv_2.5P_Lachnospiraceae, p_alluv_pathway_Lachnospiraceae, by = "alluvium")

# calculate ribbon heights
p_alluv_2.5P_Lachnospiraceae$height <- p_alluv_2.5P_Lachnospiraceae$ymax - p_alluv_2.5P_Lachnospiraceae$ymin
# restrict to class strata and ribbon heights
p_alluv_2.5P_Lachnospiraceae <- subset(p_alluv_2.5P_Lachnospiraceae, select = c(stratum, height))
# add heights within strata 
E2_2.5P_Lachnospiraceae <- aggregate(
  p_alluv_2.5P_Lachnospiraceae$height,
  by = subset(p_alluv_2.5P_Lachnospiraceae, select = stratum),
  FUN = sum
)


# filter to medium protein and Lachnospiraceae
p_alluv_5P_Lachnospiraceae <-
  p_alluv[p_alluv$stratum == "5P" & p_alluv$fill == "#f6477f", ]
# remove (redundant) stratum column (to avoid confusion in merge)
p_alluv_5P_Lachnospiraceae <- subset(p_alluv_5P_Lachnospiraceae, select = -stratum)

# filter to pathway data for phylum
p_alluv_pathway_Lachnospiraceae <-
  p_alluv[p_alluv$x == 3 & p_alluv$fill == "#f6477f", ]
# select only alluvia (by which to merge) and class
p_alluv_pathway_Lachnospiraceae <- p_alluv_pathway_Lachnospiraceae[, c("alluvium", "stratum")]
# merge path data into 5P Lachnospiraceae data
p_alluv_5P_Lachnospiraceae <-
  merge(p_alluv_5P_Lachnospiraceae, p_alluv_pathway_Lachnospiraceae, by = "alluvium")

# calculate ribbon heights
p_alluv_5P_Lachnospiraceae$height <- p_alluv_5P_Lachnospiraceae$ymax - p_alluv_5P_Lachnospiraceae$ymin
# restrict to class strata and ribbon heights
p_alluv_5P_Lachnospiraceae <- subset(p_alluv_5P_Lachnospiraceae, select = c(stratum, height))
# add heights within strata 
E2_5P_Lachnospiraceae <-aggregate(
  p_alluv_5P_Lachnospiraceae$height,
  by = subset(p_alluv_5P_Lachnospiraceae, select = stratum),
  FUN = sum
)

# filter to high protein and Lachnospiraceae
p_alluv_10P_Lachnospiraceae <-
  p_alluv[p_alluv$stratum == "10P" & p_alluv$fill == "#f6477f", ]
# remove (redundant) stratum column (to avoid confusion in merge)
p_alluv_10P_Lachnospiraceae <- subset(p_alluv_10P_Lachnospiraceae, select = -stratum)

# filter to pathway data for phylum
p_alluv_pathway_Lachnospiraceae <-
  p_alluv[p_alluv$x == 3 & p_alluv$fill == "#f6477f", ]
# select only alluvia (by which to merge) and class
p_alluv_pathway_Lachnospiraceae <- p_alluv_pathway_Lachnospiraceae[, c("alluvium", "stratum")]
# merge path data into 10P Lachnospiraceae data
p_alluv_10P_Lachnospiraceae <-
  merge(p_alluv_10P_Lachnospiraceae, p_alluv_pathway_Lachnospiraceae, by = "alluvium")

# calculate ribbon heights
p_alluv_10P_Lachnospiraceae$height <- p_alluv_10P_Lachnospiraceae$ymax - p_alluv_10P_Lachnospiraceae$ymin
# restrict to class strata and ribbon heights
p_alluv_10P_Lachnospiraceae <- subset(p_alluv_10P_Lachnospiraceae, select = c(stratum, height))
# add heights within strata (combine adult and child counts)
E2_10P_Lachnospiraceae <-aggregate(
  p_alluv_10P_Lachnospiraceae$height,
  by = subset(p_alluv_10P_Lachnospiraceae, select = stratum),
  FUN = sum
)

#Export_Lachnospiraceae
E2_2.5P_Lachnospiraceae
E2_5P_Lachnospiraceae
E2_10P_Lachnospiraceae

# filter to low protein and Lactobacillaceae
p_alluv_2.5P_Lactobacillaceae <-
  p_alluv[p_alluv$stratum == "2.5P" & p_alluv$fill == "#623d00", ]
# remove (redundant) stratum column (to avoid confusion in merge)
p_alluv_2.5P_Lactobacillaceae <- subset(p_alluv_2.5P_Lactobacillaceae, select = -stratum)

# filter to pathway data for phylum
p_alluv_pathway_Lactobacillaceae <-
  p_alluv[p_alluv$x == 3 & p_alluv$fill == "#623d00", ]
# select only alluvia (by which to merge) and class
p_alluv_pathway_Lactobacillaceae <- p_alluv_pathway_Lactobacillaceae[, c("alluvium", "stratum")]
# merge path data into 2.5P Lactobacillaceae data
p_alluv_2.5P_Lactobacillaceae <-
  merge(p_alluv_2.5P_Lactobacillaceae, p_alluv_pathway_Lactobacillaceae, by = "alluvium")

# calculate ribbon heights
p_alluv_2.5P_Lactobacillaceae$height <- p_alluv_2.5P_Lactobacillaceae$ymax - p_alluv_2.5P_Lactobacillaceae$ymin
# restrict to class strata and ribbon heights
p_alluv_2.5P_Lactobacillaceae <- subset(p_alluv_2.5P_Lactobacillaceae, select = c(stratum, height))
# add heights within strata 
E2_2.5P_Lactobacillaceae <- aggregate(
  p_alluv_2.5P_Lactobacillaceae$height,
  by = subset(p_alluv_2.5P_Lactobacillaceae, select = stratum),
  FUN = sum
)


# filter to medium protein and Lactobacillaceae
p_alluv_5P_Lactobacillaceae <-
  p_alluv[p_alluv$stratum == "5P" & p_alluv$fill == "#623d00", ]
# remove (redundant) stratum column (to avoid confusion in merge)
p_alluv_5P_Lactobacillaceae <- subset(p_alluv_5P_Lactobacillaceae, select = -stratum)

# filter to pathway data for phylum
p_alluv_pathway_Lactobacillaceae <-
  p_alluv[p_alluv$x == 3 & p_alluv$fill == "#623d00", ]
# select only alluvia (by which to merge) and class
p_alluv_pathway_Lactobacillaceae <- p_alluv_pathway_Lactobacillaceae[, c("alluvium", "stratum")]
# merge path data into 5P Lactobacillaceae data
p_alluv_5P_Lactobacillaceae <-
  merge(p_alluv_5P_Lactobacillaceae, p_alluv_pathway_Lactobacillaceae, by = "alluvium")

# calculate ribbon heights
p_alluv_5P_Lactobacillaceae$height <- p_alluv_5P_Lactobacillaceae$ymax - p_alluv_5P_Lactobacillaceae$ymin
# restrict to class strata and ribbon heights
p_alluv_5P_Lactobacillaceae <- subset(p_alluv_5P_Lactobacillaceae, select = c(stratum, height))
# add heights within strata 
E2_5P_Lactobacillaceae <-aggregate(
  p_alluv_5P_Lactobacillaceae$height,
  by = subset(p_alluv_5P_Lactobacillaceae, select = stratum),
  FUN = sum
)

# filter to high protein and Lactobacillaceae
p_alluv_10P_Lactobacillaceae <-
  p_alluv[p_alluv$stratum == "10P" & p_alluv$fill == "#623d00", ]
# remove (redundant) stratum column (to avoid confusion in merge)
p_alluv_10P_Lactobacillaceae <- subset(p_alluv_10P_Lactobacillaceae, select = -stratum)

# filter to pathway data for phylum
p_alluv_pathway_Lactobacillaceae <-
  p_alluv[p_alluv$x == 3 & p_alluv$fill == "#623d00", ]
# select only alluvia (by which to merge) and class
p_alluv_pathway_Lactobacillaceae <- p_alluv_pathway_Lactobacillaceae[, c("alluvium", "stratum")]
# merge path data into 10P Lactobacillaceae data
p_alluv_10P_Lactobacillaceae <-
  merge(p_alluv_10P_Lactobacillaceae, p_alluv_pathway_Lactobacillaceae, by = "alluvium")

# calculate ribbon heights
p_alluv_10P_Lactobacillaceae$height <- p_alluv_10P_Lactobacillaceae$ymax - p_alluv_10P_Lactobacillaceae$ymin
# restrict to class strata and ribbon heights
p_alluv_10P_Lactobacillaceae <- subset(p_alluv_10P_Lactobacillaceae, select = c(stratum, height))
# add heights within strata (combine adult and child counts)
E2_10P_Lactobacillaceae <-aggregate(
  p_alluv_10P_Lactobacillaceae$height,
  by = subset(p_alluv_10P_Lactobacillaceae, select = stratum),
  FUN = sum
)

#Export_Lactobacillaceae
E2_2.5P_Lactobacillaceae
E2_5P_Lactobacillaceae
E2_10P_Lactobacillaceae





```



E2_firmicutes overall for paper pathway
```{r}
#Plot em
#E2 firmicutes overall for paper
E2_firmicutes <- ggplot(as.data.frame(E2_sankey_firmicutes),
       aes(y = Abundance, axis1 = class, axis2 = Percent_Protein, axis3 = pathway)) +
  geom_alluvium(aes(fill = class), width = 1/12)+
    geom_stratum(width = 1/12, fill = "black", color = "white") +
  geom_label(stat = "stratum", aes(label = after_stat(stratum))) +
  scale_x_discrete(limits = c("family", "Percent_Protein", "pathway"), expand = c(.05, .05)) +
#scale_fill_manual(values = familyColor) +
  ggtitle("Semi-Natural Treatment: Phylum firmicutes \n only med-high gapmind confidence scores") +
theme_bw() +
  theme(
    title =element_text(size=22, face='bold'),
    axis.text.x = element_text(color="black", size=14),
    axis.text.y = element_text(color="black", size=16),
    strip.text.y = element_text(color="black", size=16),
    legend.title = element_text(color="black", size=22),
    legend.text = element_text(color="black", size=16),
    legend.position = "right",
    strip.background = element_blank(), #to remove facet wrap title
    strip.text = element_text(size = 20),
    axis.title.x = element_text(color="black", size=22),
    axis.title.y = element_text(color="black", size=22, angle=90),
    panel.grid.major = element_blank(), # switch off major grid lines
   panel.grid.minor = element_blank(), # switch off minor grid lines
    panel.border = element_rect(colour = "black", fill=NA, size=.75)
  )
#CREATE A PDF AND SAVES IT TO THE RIGHT DIRECTORY/FOLDER. 
#pdf("/Users/connermertz/Dropbox (vlab)/Conner Mertz/UNM biology/Chapter 1 E1 vs E2/Methods/Metagenomics/methods_DataAnalysis/Metagenomic Pipeline/Plots/SANKEY/firmicutes/E2_firmicutes/E2_firmicutes_alldiets_family_steps.pdf", height = 12, width = 16)
E2_firmicutes
#dev.off()
```







Now lets look deeper at the steps being used in each pathway
```{r}
#Plot em
#E2 firmicutes overall
E2_firmicutes <- ggplot(as.data.frame(E2_sankey_firmicutes),
       aes(y = Abundance, axis1 = family, axis2 = Percent_Protein, axis3 = pathway, axis4 = MostLikelySeriesofStepsinPathway)) +
  geom_alluvium(aes(fill = pathway), width = 1/12)+
    geom_stratum(width = 1/12, fill = "black", color = "white") +
  geom_label(stat = "stratum", aes(label = after_stat(stratum))) +
  scale_x_discrete(limits = c("family", "Percent_Protein", "pathway","MostLikelySeriesofStepsinPathway" ), expand = c(.05, .05)) +
scale_fill_manual(values = ESS_pathwayColor) +
  ggtitle("Semi-Natural Treatment: Phylum firmicutes \n only med-high gapmind confidence scores") +
theme_bw() +
  theme(
    title =element_text(size=22, face='bold'),
    axis.text.x = element_text(color="black", size=14),
    axis.text.y = element_text(color="black", size=16),
    strip.text.y = element_text(color="black", size=16),
    legend.title = element_text(color="black", size=22),
    legend.text = element_text(color="black", size=16),
    legend.position = "right",
    strip.background = element_blank(), #to remove facet wrap title
    strip.text = element_text(size = 20),
    axis.title.x = element_text(color="black", size=22),
    axis.title.y = element_text(color="black", size=22, angle=90),
    panel.grid.major = element_blank(), # switch off major grid lines
   panel.grid.minor = element_blank(), # switch off minor grid lines
    panel.border = element_rect(colour = "black", fill=NA, size=.75)
  )
#CREATE A PDF AND SAVES IT TO THE RIGHT DIRECTORY/FOLDER. 
pdf("/Users/connermertz/Dropbox (vlab)/Conner Mertz/UNM biology/Chapter 1 E1 vs E2/Methods/Metagenomics/methods_DataAnalysis/Metagenomic Pipeline/Plots/SANKEY/firmicutes/E2_firmicutes/E2_firmicutes_alldiets_steps.pdf", height = 20, width = 30)
E2_firmicutes
dev.off()
```


Now lets look deeper at the steps being used in each pathway but split up by diet
E2 firmicutes by Percent Protein!
```{r}
#E2_firmicutes_fill pathway
#2.5P
E2_2.5P_firmicutes <- ggplot(as.data.frame(E2_sankey_firmicutes_2.5P),
       aes(y = Abundance, axis1 = family, axis2 = pathway, axis3 = MostLikelySeriesofStepsinPathway)) +
  geom_alluvium(aes(fill = pathway), width = 1/12)+
    geom_stratum(width = 1/12, fill = "black", color = "white") +
  geom_label(stat = "stratum", aes(label = after_stat(stratum))) +
  scale_x_discrete(limits = c("family", "pathway","MostLikelySeriesofStepsinPathway" ), expand = c(.05, .05)) +
  #facet_wrap(~Percent_Protein, scale = "free_x") +
  scale_fill_manual(values = ESS_pathwayColor) +
  ggtitle("Semi-Natural Treatment: Phylum firmicutes from 2.5P Diet \nonly med-high gapmind confidence scores") +
theme_bw() +
  theme(
    title =element_text(size=22, face='bold'),
    axis.text.x = element_text(color="black", size=14),
    axis.text.y = element_text(color="black", size=16),
    strip.text.y = element_text(color="black", size=16),
    legend.title = element_text(color="black", size=22),
    legend.text = element_text(color="black", size=16),
    legend.position = "right",
    strip.background = element_blank(), #to remove facet wrap title
    strip.text = element_text(size = 20),
    axis.title.x = element_text(color="black", size=22),
    axis.title.y = element_text(color="black", size=22, angle=90),
    panel.grid.major = element_blank(), # switch off major grid lines
   panel.grid.minor = element_blank(), # switch off minor grid lines
    panel.border = element_rect(colour = "black", fill=NA, size=.75)
  )
#CREATE A PDF AND SAVES IT TO THE RIGHT DIRECTORY/FOLDER. 
pdf("/Users/connermertz/Dropbox (vlab)/Conner Mertz/UNM biology/Chapter 1 E1 vs E2/Methods/Metagenomics/methods_DataAnalysis/Metagenomic Pipeline/Plots/SANKEY/firmicutes/E2_firmicutes/E2_firmicutes_2.5_path_steps.pdf", height = 12, width = 25)
E2_2.5P_firmicutes
dev.off()

#E2_firmicutes_fill family
E2_2.5P_firmicutes <- ggplot(as.data.frame(E2_sankey_firmicutes_2.5P),
       aes(y = Abundance, axis1 = family, axis2 = pathway, axis3 = MostLikelySeriesofStepsinPathway)) +
  geom_alluvium(aes(fill = family), width = 1/12)+
    geom_stratum(width = 1/12, fill = "black", color = "white") +
  geom_label(stat = "stratum", aes(label = after_stat(stratum))) +
  scale_x_discrete(limits = c("family", "pathway","MostLikelySeriesofStepsinPathway" ), expand = c(.05, .05)) +
scale_fill_manual(values = familyColor) +
  ggtitle("Semi-Natural Treatment: Phylum firmicutes from 2.5P Diet \nonly med-high gapmind confidence scores") +
theme_bw() +
  theme(
    title =element_text(size=22, face='bold'),
    axis.text.x = element_text(color="black", size=14),
    axis.text.y = element_text(color="black", size=16),
    strip.text.y = element_text(color="black", size=16),
    legend.title = element_text(color="black", size=22),
    legend.text = element_text(color="black", size=16),
    legend.position = "right",
    strip.background = element_blank(), #to remove facet wrap title
    strip.text = element_text(size = 20),
    axis.title.x = element_text(color="black", size=22),
    axis.title.y = element_text(color="black", size=22, angle=90),
    panel.grid.major = element_blank(), # switch off major grid lines
   panel.grid.minor = element_blank(), # switch off minor grid lines
    panel.border = element_rect(colour = "black", fill=NA, size=.75)
  )
#CREATE A PDF AND SAVES IT TO THE RIGHT DIRECTORY/FOLDER. 
pdf("/Users/connermertz/Dropbox (vlab)/Conner Mertz/UNM biology/Chapter 1 E1 vs E2/Methods/Metagenomics/methods_DataAnalysis/Metagenomic Pipeline/Plots/SANKEY/firmicutes/E2_firmicutes/E2_firmicutes_2.5P_family_steps.pdf", height = 12, width = 25)
E2_2.5P_firmicutes
dev.off()
```

```{r}
#E2_firmicutes_fill pathway
#5P
E2_5P_firmicutes <- ggplot(as.data.frame(E2_sankey_firmicutes_5P),
       aes(y = Abundance, axis1 = family, axis2 = pathway, axis3 = MostLikelySeriesofStepsinPathway)) +
  geom_alluvium(aes(fill = pathway), width = 1/12)+
    geom_stratum(width = 1/12, fill = "black", color = "white") +
  geom_label(stat = "stratum", aes(label = after_stat(stratum))) +
  scale_x_discrete(limits = c("family", "pathway","MostLikelySeriesofStepsinPathway" ), expand = c(.05, .05)) +
  #facet_wrap(~Percent_Protein, scale = "free_x") +
  scale_fill_manual(values = ESS_pathwayColor) +
  ggtitle("Semi-Natural Treatment: Phylum firmicutes from 5P Diet \nonly med-high gapmind confidence scores") +
theme_bw() +
  theme(
    title =element_text(size=22, face='bold'),
    axis.text.x = element_text(color="black", size=14),
    axis.text.y = element_text(color="black", size=16),
    strip.text.y = element_text(color="black", size=16),
    legend.title = element_text(color="black", size=22),
    legend.text = element_text(color="black", size=16),
    legend.position = "right",
    strip.background = element_blank(), #to remove facet wrap title
    strip.text = element_text(size = 20),
    axis.title.x = element_text(color="black", size=22),
    axis.title.y = element_text(color="black", size=22, angle=90),
    panel.grid.major = element_blank(), # switch off major grid lines
   panel.grid.minor = element_blank(), # switch off minor grid lines
    panel.border = element_rect(colour = "black", fill=NA, size=.75)
  )
#CREATE A PDF AND SAVES IT TO THE RIGHT DIRECTORY/FOLDER. 
pdf("/Users/connermertz/Dropbox (vlab)/Conner Mertz/UNM biology/Chapter 1 E1 vs E2/Methods/Metagenomics/methods_DataAnalysis/Metagenomic Pipeline/Plots/SANKEY/firmicutes/E2_firmicutes/E2_firmicutes_5_path_steps.pdf", height = 12, width = 25)
E2_5P_firmicutes
dev.off()

#E2_firmicutes_fill family
E2_5P_firmicutes <- ggplot(as.data.frame(E2_sankey_firmicutes_5P),
       aes(y = Abundance, axis1 = family, axis2 = pathway, axis3 = MostLikelySeriesofStepsinPathway)) +
  geom_alluvium(aes(fill = family), width = 1/12)+
    geom_stratum(width = 1/12, fill = "black", color = "white") +
  geom_label(stat = "stratum", aes(label = after_stat(stratum))) +
  scale_x_discrete(limits = c("family", "pathway","MostLikelySeriesofStepsinPathway" ), expand = c(.05, .05)) +
scale_fill_manual(values = familyColor) +
  ggtitle("Semi-Natural Treatment: Phylum firmicutes from 5P Diet \nonly med-high gapmind confidence scores") +
theme_bw() +
  theme(
    title =element_text(size=22, face='bold'),
    axis.text.x = element_text(color="black", size=14),
    axis.text.y = element_text(color="black", size=16),
    strip.text.y = element_text(color="black", size=16),
    legend.title = element_text(color="black", size=22),
    legend.text = element_text(color="black", size=16),
    legend.position = "right",
    strip.background = element_blank(), #to remove facet wrap title
    strip.text = element_text(size = 20),
    axis.title.x = element_text(color="black", size=22),
    axis.title.y = element_text(color="black", size=22, angle=90),
    panel.grid.major = element_blank(), # switch off major grid lines
   panel.grid.minor = element_blank(), # switch off minor grid lines
    panel.border = element_rect(colour = "black", fill=NA, size=.75)
  )
#CREATE A PDF AND SAVES IT TO THE RIGHT DIRECTORY/FOLDER. 
pdf("/Users/connermertz/Dropbox (vlab)/Conner Mertz/UNM biology/Chapter 1 E1 vs E2/Methods/Metagenomics/methods_DataAnalysis/Metagenomic Pipeline/Plots/SANKEY/firmicutes/E2_firmicutes/E2_firmicutes_5P_family_steps.pdf", height = 12, width = 25)
E2_5P_firmicutes
dev.off()
```

```{r}
#E2_firmicutes_fill pathway
#10P
E2_10P_firmicutes <- ggplot(as.data.frame(E2_sankey_firmicutes_10P),
       aes(y = Abundance, axis1 = family, axis2 = pathway, axis3 = MostLikelySeriesofStepsinPathway)) +
  geom_alluvium(aes(fill = pathway), width = 1/12)+
    geom_stratum(width = 1/12, fill = "black", color = "white") +
  geom_label(stat = "stratum", aes(label = after_stat(stratum))) +
  scale_x_discrete(limits = c("family", "pathway","MostLikelySeriesofStepsinPathway" ), expand = c(.05, .05)) +
  #facet_wrap(~Percent_Protein, scale = "free_x") +
  scale_fill_manual(values = ESS_pathwayColor) +
  ggtitle("Semi-Natural Treatment: Phylum firmicutes from 10P Diet \nonly med-high gapmind confidence scores") +
theme_bw() +
  theme(
    title =element_text(size=22, face='bold'),
    axis.text.x = element_text(color="black", size=14),
    axis.text.y = element_text(color="black", size=16),
    strip.text.y = element_text(color="black", size=16),
    legend.title = element_text(color="black", size=22),
    legend.text = element_text(color="black", size=16),
    legend.position = "right",
    strip.background = element_blank(), #to remove facet wrap title
    strip.text = element_text(size = 20),
    axis.title.x = element_text(color="black", size=22),
    axis.title.y = element_text(color="black", size=22, angle=90),
    panel.grid.major = element_blank(), # switch off major grid lines
   panel.grid.minor = element_blank(), # switch off minor grid lines
    panel.border = element_rect(colour = "black", fill=NA, size=.75)
  )
#CREATE A PDF AND SAVES IT TO THE RIGHT DIRECTORY/FOLDER. 
pdf("/Users/connermertz/Dropbox (vlab)/Conner Mertz/UNM biology/Chapter 1 E1 vs E2/Methods/Metagenomics/methods_DataAnalysis/Metagenomic Pipeline/Plots/SANKEY/firmicutes/E2_firmicutes/E2_firmicutes_10_path_steps.pdf", height = 12, width = 25)
E2_10P_firmicutes
dev.off()

#E2_firmicutes_fill family
E2_10P_firmicutes <- ggplot(as.data.frame(E2_sankey_firmicutes_10P),
       aes(y = Abundance, axis1 = family, axis2 = pathway, axis3 = MostLikelySeriesofStepsinPathway)) +
  geom_alluvium(aes(fill = family), width = 1/12)+
    geom_stratum(width = 1/12, fill = "black", color = "white") +
  geom_label(stat = "stratum", aes(label = after_stat(stratum))) +
  scale_x_discrete(limits = c("family", "pathway","MostLikelySeriesofStepsinPathway" ), expand = c(.05, .05)) +
scale_fill_manual(values = familyColor) +
  ggtitle("Semi-Natural Treatment: Phylum firmicutes from 10P Diet \nonly med-high gapmind confidence scores") +
theme_bw() +
  theme(
    title =element_text(size=22, face='bold'),
    axis.text.x = element_text(color="black", size=14),
    axis.text.y = element_text(color="black", size=16),
    strip.text.y = element_text(color="black", size=16),
    legend.title = element_text(color="black", size=22),
    legend.text = element_text(color="black", size=16),
    legend.position = "right",
    strip.background = element_blank(), #to remove facet wrap title
    strip.text = element_text(size = 20),
    axis.title.x = element_text(color="black", size=22),
    axis.title.y = element_text(color="black", size=22, angle=90),
    panel.grid.major = element_blank(), # switch off major grid lines
   panel.grid.minor = element_blank(), # switch off minor grid lines
    panel.border = element_rect(colour = "black", fill=NA, size=.75)
  )
#CREATE A PDF AND SAVES IT TO THE RIGHT DIRECTORY/FOLDER. 
pdf("/Users/connermertz/Dropbox (vlab)/Conner Mertz/UNM biology/Chapter 1 E1 vs E2/Methods/Metagenomics/methods_DataAnalysis/Metagenomic Pipeline/Plots/SANKEY/firmicutes/E2_firmicutes/E2_firmicutes_10P_family_steps.pdf", height = 12, width = 25)
E2_10P_firmicutes
dev.off()
```














########E2#############
proteobacteria

E2_proteobacteria overall for paper pathway
```{r}
#Plot em
#E2 proteobacteria overall for paper
E2_proteobacteria <- ggplot(as.data.frame(E2_sankey_proteobacteria),
       aes(y = Abundance, axis1 = family, axis2 = Percent_Protein, axis3 = pathway)) +
  geom_alluvium(aes(fill = pathway), width = 1/12)+
    geom_stratum(width = 1/12, fill = "black", color = "white") +
  geom_label(stat = "stratum", aes(label = after_stat(stratum))) +
  scale_x_discrete(limits = c("family", "Percent_Protein", "pathway"), expand = c(.05, .05)) +
scale_fill_manual(values = ESS_pathwayColor) +
  ggtitle("Semi-Natural Treatment: Phylum proteobacteria \n only med-high gapmind confidence scores") +
theme_bw() +
  theme(
    title =element_text(size=22, face='bold'),
    axis.text.x = element_text(color="black", size=14),
    axis.text.y = element_text(color="black", size=16),
    strip.text.y = element_text(color="black", size=16),
    legend.title = element_text(color="black", size=22),
    legend.text = element_text(color="black", size=16),
    legend.position = "right",
    strip.background = element_blank(), #to remove facet wrap title
    strip.text = element_text(size = 20),
    axis.title.x = element_text(color="black", size=22),
    axis.title.y = element_text(color="black", size=22, angle=90),
    panel.grid.major = element_blank(), # switch off major grid lines
   panel.grid.minor = element_blank(), # switch off minor grid lines
    panel.border = element_rect(colour = "black", fill=NA, size=.75)
  )
#CREATE A PDF AND SAVES IT TO THE RIGHT DIRECTORY/FOLDER. 
pdf("/Users/connermertz/Dropbox (vlab)/Conner Mertz/UNM biology/Chapter 1 E1 vs E2/Methods/Metagenomics/methods_DataAnalysis/Metagenomic Pipeline/Plots/SANKEY/proteobacteria/E2_proteobacteria/E2_proteobacteria_alldiets.pdf", height = 12, width = 16)
E2_proteobacteria
dev.off()
```

E2_proteobacteria overall for paper family
```{r}
#Plot em
#E2 proteobacteria overall for paper
E2_proteobacteria <- ggplot(as.data.frame(E2_sankey_proteobacteria),
       aes(y = Abundance, axis1 = family, axis2 = Percent_Protein, axis3 = pathway)) +
  geom_alluvium(aes(fill = family), width = 1/12)+
    geom_stratum(width = 1/12, fill = "black", color = "white") +
  geom_label(stat = "stratum", aes(label = after_stat(stratum))) +
  scale_x_discrete(limits = c("family", "Percent_Protein", "pathway"), expand = c(.05, .05)) +
scale_fill_manual(values = familyColor) +
  ggtitle("Semi-Natural Treatment: Phylum proteobacteria \n only med-high gapmind confidence scores") +
theme_bw() +
  theme(
    title =element_text(size=22, face='bold'),
    axis.text.x = element_text(color="black", size=14),
    axis.text.y = element_text(color="black", size=16),
    strip.text.y = element_text(color="black", size=16),
    legend.title = element_text(color="black", size=22),
    legend.text = element_text(color="black", size=16),
    legend.position = "right",
    strip.background = element_blank(), #to remove facet wrap title
    strip.text = element_text(size = 20),
    axis.title.x = element_text(color="black", size=22),
    axis.title.y = element_text(color="black", size=22, angle=90),
    panel.grid.major = element_blank(), # switch off major grid lines
   panel.grid.minor = element_blank(), # switch off minor grid lines
    panel.border = element_rect(colour = "black", fill=NA, size=.75)
  )
#CREATE A PDF AND SAVES IT TO THE RIGHT DIRECTORY/FOLDER. 
#pdf("/Users/connermertz/Dropbox (vlab)/Conner Mertz/UNM biology/Chapter 1 E1 vs E2/Methods/Metagenomics/methods_DataAnalysis/Metagenomic Pipeline/Plots/SANKEY/proteobacteria/E2_proteobacteria/E2_proteobacteria_alldiets_family_steps.pdf", height = 12, width = 16)
E2_proteobacteria
#dev.off()
```

Lets export the curve heights for each family belonging to phylum proteobacteria by diet in E2
```{r}
# recover the built plot
p_build <- ggplot_build(E2_proteobacteria)
# extract the data for the alluvium graphical objects
p_alluv <- p_build$data[[1L]]
# what are the fill colors
unique(p_alluv$fill)
#    "#edb331" "#ff875e"
      #Desulfovibrionaceae= "#edb331",
      #Helicobacteraceae= "#ff875e",

# filter to low protein and Desulfovibrionaceae
p_alluv_2.5P_Desulfovibrionaceae <-
  p_alluv[p_alluv$stratum == "2.5P" & p_alluv$fill == "#edb331", ]
# remove (redundant) stratum column (to avoid confusion in merge)
p_alluv_2.5P_Desulfovibrionaceae <- subset(p_alluv_2.5P_Desulfovibrionaceae, select = -stratum)

# filter to pathway data for phylum
p_alluv_pathway_Desulfovibrionaceae <-
  p_alluv[p_alluv$x == 3 & p_alluv$fill == "#edb331", ]
# select only alluvia (by which to merge) and class
p_alluv_pathway_Desulfovibrionaceae <- p_alluv_pathway_Desulfovibrionaceae[, c("alluvium", "stratum")]
# merge path data into 2.5P Desulfovibrionaceae data
p_alluv_2.5P_Desulfovibrionaceae <-
  merge(p_alluv_2.5P_Desulfovibrionaceae, p_alluv_pathway_Desulfovibrionaceae, by = "alluvium")

# calculate ribbon heights
p_alluv_2.5P_Desulfovibrionaceae$height <- p_alluv_2.5P_Desulfovibrionaceae$ymax - p_alluv_2.5P_Desulfovibrionaceae$ymin
# restrict to class strata and ribbon heights
p_alluv_2.5P_Desulfovibrionaceae <- subset(p_alluv_2.5P_Desulfovibrionaceae, select = c(stratum, height))
# add heights within strata 
E2_2.5P_Desulfovibrionaceae <- aggregate(
  p_alluv_2.5P_Desulfovibrionaceae$height,
  by = subset(p_alluv_2.5P_Desulfovibrionaceae, select = stratum),
  FUN = sum
)


# filter to medium protein and Desulfovibrionaceae
p_alluv_5P_Desulfovibrionaceae <-
  p_alluv[p_alluv$stratum == "5P" & p_alluv$fill == "#edb331", ]
# remove (redundant) stratum column (to avoid confusion in merge)
p_alluv_5P_Desulfovibrionaceae <- subset(p_alluv_5P_Desulfovibrionaceae, select = -stratum)

# filter to pathway data for phylum
p_alluv_pathway_Desulfovibrionaceae <-
  p_alluv[p_alluv$x == 3 & p_alluv$fill == "#edb331", ]
# select only alluvia (by which to merge) and class
p_alluv_pathway_Desulfovibrionaceae <- p_alluv_pathway_Desulfovibrionaceae[, c("alluvium", "stratum")]
# merge path data into 5P Desulfovibrionaceae data
p_alluv_5P_Desulfovibrionaceae <-
  merge(p_alluv_5P_Desulfovibrionaceae, p_alluv_pathway_Desulfovibrionaceae, by = "alluvium")

# calculate ribbon heights
p_alluv_5P_Desulfovibrionaceae$height <- p_alluv_5P_Desulfovibrionaceae$ymax - p_alluv_5P_Desulfovibrionaceae$ymin
# restrict to class strata and ribbon heights
p_alluv_5P_Desulfovibrionaceae <- subset(p_alluv_5P_Desulfovibrionaceae, select = c(stratum, height))
# add heights within strata 
E2_5P_Desulfovibrionaceae <-aggregate(
  p_alluv_5P_Desulfovibrionaceae$height,
  by = subset(p_alluv_5P_Desulfovibrionaceae, select = stratum),
  FUN = sum
)

# filter to high protein and Desulfovibrionaceae
p_alluv_10P_Desulfovibrionaceae <-
  p_alluv[p_alluv$stratum == "10P" & p_alluv$fill == "#edb331", ]
# remove (redundant) stratum column (to avoid confusion in merge)
p_alluv_10P_Desulfovibrionaceae <- subset(p_alluv_10P_Desulfovibrionaceae, select = -stratum)

# filter to pathway data for phylum
p_alluv_pathway_Desulfovibrionaceae <-
  p_alluv[p_alluv$x == 3 & p_alluv$fill == "#edb331", ]
# select only alluvia (by which to merge) and class
p_alluv_pathway_Desulfovibrionaceae <- p_alluv_pathway_Desulfovibrionaceae[, c("alluvium", "stratum")]
# merge path data into 10P Desulfovibrionaceae data
p_alluv_10P_Desulfovibrionaceae <-
  merge(p_alluv_10P_Desulfovibrionaceae, p_alluv_pathway_Desulfovibrionaceae, by = "alluvium")

# calculate ribbon heights
p_alluv_10P_Desulfovibrionaceae$height <- p_alluv_10P_Desulfovibrionaceae$ymax - p_alluv_10P_Desulfovibrionaceae$ymin
# restrict to class strata and ribbon heights
p_alluv_10P_Desulfovibrionaceae <- subset(p_alluv_10P_Desulfovibrionaceae, select = c(stratum, height))
# add heights within strata (combine adult and child counts)
E2_10P_Desulfovibrionaceae <-aggregate(
  p_alluv_10P_Desulfovibrionaceae$height,
  by = subset(p_alluv_10P_Desulfovibrionaceae, select = stratum),
  FUN = sum
)

#Export_Desulfovibrionaceae
E2_2.5P_Desulfovibrionaceae
E2_5P_Desulfovibrionaceae
E2_10P_Desulfovibrionaceae

# filter to low protein and Helicobacteraceae
p_alluv_2.5P_Helicobacteraceae <-
  p_alluv[p_alluv$stratum == "2.5P" & p_alluv$fill == "#ff875e", ]
# remove (redundant) stratum column (to avoid confusion in merge)
p_alluv_2.5P_Helicobacteraceae <- subset(p_alluv_2.5P_Helicobacteraceae, select = -stratum)

# filter to pathway data for phylum
p_alluv_pathway_Helicobacteraceae <-
  p_alluv[p_alluv$x == 3 & p_alluv$fill == "#ff875e", ]
# select only alluvia (by which to merge) and class
p_alluv_pathway_Helicobacteraceae <- p_alluv_pathway_Helicobacteraceae[, c("alluvium", "stratum")]
# merge path data into 2.5P Helicobacteraceae data
p_alluv_2.5P_Helicobacteraceae <-
  merge(p_alluv_2.5P_Helicobacteraceae, p_alluv_pathway_Helicobacteraceae, by = "alluvium")

# calculate ribbon heights
p_alluv_2.5P_Helicobacteraceae$height <- p_alluv_2.5P_Helicobacteraceae$ymax - p_alluv_2.5P_Helicobacteraceae$ymin
# restrict to class strata and ribbon heights
p_alluv_2.5P_Helicobacteraceae <- subset(p_alluv_2.5P_Helicobacteraceae, select = c(stratum, height))
# add heights within strata 
E2_2.5P_Helicobacteraceae <- aggregate(
  p_alluv_2.5P_Helicobacteraceae$height,
  by = subset(p_alluv_2.5P_Helicobacteraceae, select = stratum),
  FUN = sum
)


# filter to medium protein and Helicobacteraceae
p_alluv_5P_Helicobacteraceae <-
  p_alluv[p_alluv$stratum == "5P" & p_alluv$fill == "#ff875e", ]
# remove (redundant) stratum column (to avoid confusion in merge)
p_alluv_5P_Helicobacteraceae <- subset(p_alluv_5P_Helicobacteraceae, select = -stratum)

# filter to pathway data for phylum
p_alluv_pathway_Helicobacteraceae <-
  p_alluv[p_alluv$x == 3 & p_alluv$fill == "#ff875e", ]
# select only alluvia (by which to merge) and class
p_alluv_pathway_Helicobacteraceae <- p_alluv_pathway_Helicobacteraceae[, c("alluvium", "stratum")]
# merge path data into 5P Helicobacteraceae data
p_alluv_5P_Helicobacteraceae <-
  merge(p_alluv_5P_Helicobacteraceae, p_alluv_pathway_Helicobacteraceae, by = "alluvium")

# calculate ribbon heights
p_alluv_5P_Helicobacteraceae$height <- p_alluv_5P_Helicobacteraceae$ymax - p_alluv_5P_Helicobacteraceae$ymin
# restrict to class strata and ribbon heights
p_alluv_5P_Helicobacteraceae <- subset(p_alluv_5P_Helicobacteraceae, select = c(stratum, height))
# add heights within strata 
E2_5P_Helicobacteraceae <-aggregate(
  p_alluv_5P_Helicobacteraceae$height,
  by = subset(p_alluv_5P_Helicobacteraceae, select = stratum),
  FUN = sum
)

# filter to high protein and Helicobacteraceae
p_alluv_10P_Helicobacteraceae <-
  p_alluv[p_alluv$stratum == "10P" & p_alluv$fill == "#ff875e", ]
# remove (redundant) stratum column (to avoid confusion in merge)
p_alluv_10P_Helicobacteraceae <- subset(p_alluv_10P_Helicobacteraceae, select = -stratum)

# filter to pathway data for phylum
p_alluv_pathway_Helicobacteraceae <-
  p_alluv[p_alluv$x == 3 & p_alluv$fill == "#ff875e", ]
# select only alluvia (by which to merge) and class
p_alluv_pathway_Helicobacteraceae <- p_alluv_pathway_Helicobacteraceae[, c("alluvium", "stratum")]
# merge path data into 10P Helicobacteraceae data
p_alluv_10P_Helicobacteraceae <-
  merge(p_alluv_10P_Helicobacteraceae, p_alluv_pathway_Helicobacteraceae, by = "alluvium")

# calculate ribbon heights
p_alluv_10P_Helicobacteraceae$height <- p_alluv_10P_Helicobacteraceae$ymax - p_alluv_10P_Helicobacteraceae$ymin
# restrict to class strata and ribbon heights
p_alluv_10P_Helicobacteraceae <- subset(p_alluv_10P_Helicobacteraceae, select = c(stratum, height))
# add heights within strata (combine adult and child counts)
E2_10P_Helicobacteraceae <-aggregate(
  p_alluv_10P_Helicobacteraceae$height,
  by = subset(p_alluv_10P_Helicobacteraceae, select = stratum),
  FUN = sum
)

#Export_Helicobacteraceae
E2_2.5P_Helicobacteraceae
E2_5P_Helicobacteraceae
E2_10P_Helicobacteraceae

```

Now lets look deeper at the steps being used in each pathway
```{r}
#Plot em
#E2 proteobacteria overall
E2_proteobacteria <- ggplot(as.data.frame(E2_sankey_proteobacteria),
       aes(y = Abundance, axis1 = family, axis2 = Percent_Protein, axis3 = pathway, axis4 = MostLikelySeriesofStepsinPathway)) +
  geom_alluvium(aes(fill = pathway), width = 1/12)+
    geom_stratum(width = 1/12, fill = "black", color = "white") +
  geom_label(stat = "stratum", aes(label = after_stat(stratum))) +
  scale_x_discrete(limits = c("family", "Percent_Protein", "pathway","MostLikelySeriesofStepsinPathway" ), expand = c(.05, .05)) +
scale_fill_manual(values = ESS_pathwayColor) +
  ggtitle("Semi-Natural Treatment: Phylum proteobacteria \n only med-high gapmind confidence scores") +
theme_bw() +
  theme(
    title =element_text(size=22, face='bold'),
    axis.text.x = element_text(color="black", size=14),
    axis.text.y = element_text(color="black", size=16),
    strip.text.y = element_text(color="black", size=16),
    legend.title = element_text(color="black", size=22),
    legend.text = element_text(color="black", size=16),
    legend.position = "right",
    strip.background = element_blank(), #to remove facet wrap title
    strip.text = element_text(size = 20),
    axis.title.x = element_text(color="black", size=22),
    axis.title.y = element_text(color="black", size=22, angle=90),
    panel.grid.major = element_blank(), # switch off major grid lines
   panel.grid.minor = element_blank(), # switch off minor grid lines
    panel.border = element_rect(colour = "black", fill=NA, size=.75)
  )
#CREATE A PDF AND SAVES IT TO THE RIGHT DIRECTORY/FOLDER. 
pdf("/Users/connermertz/Dropbox (vlab)/Conner Mertz/UNM biology/Chapter 1 E1 vs E2/Methods/Metagenomics/methods_DataAnalysis/Metagenomic Pipeline/Plots/SANKEY/proteobacteria/E2_proteobacteria/E2_proteobacteria_alldiets_steps.pdf", height = 20, width = 30)
E2_proteobacteria
dev.off()
```


Now lets look deeper at the steps being used in each pathway but split up by diet
E2 proteobacteria by Percent Protein!
```{r}
#E2_proteobacteria_fill pathway
#2.5P
E2_2.5P_proteobacteria <- ggplot(as.data.frame(E2_sankey_proteobacteria_2.5P),
       aes(y = Abundance, axis1 = family, axis2 = pathway, axis3 = MostLikelySeriesofStepsinPathway)) +
  geom_alluvium(aes(fill = pathway), width = 1/12)+
    geom_stratum(width = 1/12, fill = "black", color = "white") +
  geom_label(stat = "stratum", aes(label = after_stat(stratum))) +
  scale_x_discrete(limits = c("family", "pathway","MostLikelySeriesofStepsinPathway" ), expand = c(.05, .05)) +
  #facet_wrap(~Percent_Protein, scale = "free_x") +
  scale_fill_manual(values = ESS_pathwayColor) +
  ggtitle("Semi-Natural Treatment: Phylum proteobacteria from 2.5P Diet \nonly med-high gapmind confidence scores") +
theme_bw() +
  theme(
    title =element_text(size=22, face='bold'),
    axis.text.x = element_text(color="black", size=14),
    axis.text.y = element_text(color="black", size=16),
    strip.text.y = element_text(color="black", size=16),
    legend.title = element_text(color="black", size=22),
    legend.text = element_text(color="black", size=16),
    legend.position = "right",
    strip.background = element_blank(), #to remove facet wrap title
    strip.text = element_text(size = 20),
    axis.title.x = element_text(color="black", size=22),
    axis.title.y = element_text(color="black", size=22, angle=90),
    panel.grid.major = element_blank(), # switch off major grid lines
   panel.grid.minor = element_blank(), # switch off minor grid lines
    panel.border = element_rect(colour = "black", fill=NA, size=.75)
  )
#CREATE A PDF AND SAVES IT TO THE RIGHT DIRECTORY/FOLDER. 
pdf("/Users/connermertz/Dropbox (vlab)/Conner Mertz/UNM biology/Chapter 1 E1 vs E2/Methods/Metagenomics/methods_DataAnalysis/Metagenomic Pipeline/Plots/SANKEY/proteobacteria/E2_proteobacteria/E2_proteobacteria_2.5_path_steps.pdf", height = 12, width = 25)
E2_2.5P_proteobacteria
dev.off()

#E2_proteobacteria_fill family
E2_2.5P_proteobacteria <- ggplot(as.data.frame(E2_sankey_proteobacteria_2.5P),
       aes(y = Abundance, axis1 = family, axis2 = pathway, axis3 = MostLikelySeriesofStepsinPathway)) +
  geom_alluvium(aes(fill = family), width = 1/12)+
    geom_stratum(width = 1/12, fill = "black", color = "white") +
  geom_label(stat = "stratum", aes(label = after_stat(stratum))) +
  scale_x_discrete(limits = c("family", "pathway","MostLikelySeriesofStepsinPathway" ), expand = c(.05, .05)) +
scale_fill_manual(values = familyColor) +
  ggtitle("Semi-Natural Treatment: Phylum proteobacteria from 2.5P Diet \nonly med-high gapmind confidence scores") +
theme_bw() +
  theme(
    title =element_text(size=22, face='bold'),
    axis.text.x = element_text(color="black", size=14),
    axis.text.y = element_text(color="black", size=16),
    strip.text.y = element_text(color="black", size=16),
    legend.title = element_text(color="black", size=22),
    legend.text = element_text(color="black", size=16),
    legend.position = "right",
    strip.background = element_blank(), #to remove facet wrap title
    strip.text = element_text(size = 20),
    axis.title.x = element_text(color="black", size=22),
    axis.title.y = element_text(color="black", size=22, angle=90),
    panel.grid.major = element_blank(), # switch off major grid lines
   panel.grid.minor = element_blank(), # switch off minor grid lines
    panel.border = element_rect(colour = "black", fill=NA, size=.75)
  )
#CREATE A PDF AND SAVES IT TO THE RIGHT DIRECTORY/FOLDER. 
pdf("/Users/connermertz/Dropbox (vlab)/Conner Mertz/UNM biology/Chapter 1 E1 vs E2/Methods/Metagenomics/methods_DataAnalysis/Metagenomic Pipeline/Plots/SANKEY/proteobacteria/E2_proteobacteria/E2_proteobacteria_2.5P_family_steps.pdf", height = 12, width = 25)
E2_2.5P_proteobacteria
dev.off()
```

```{r}
#E2_proteobacteria_fill pathway
#5P
E2_5P_proteobacteria <- ggplot(as.data.frame(E2_sankey_proteobacteria_5P),
       aes(y = Abundance, axis1 = family, axis2 = pathway, axis3 = MostLikelySeriesofStepsinPathway)) +
  geom_alluvium(aes(fill = pathway), width = 1/12)+
    geom_stratum(width = 1/12, fill = "black", color = "white") +
  geom_label(stat = "stratum", aes(label = after_stat(stratum))) +
  scale_x_discrete(limits = c("family", "pathway","MostLikelySeriesofStepsinPathway" ), expand = c(.05, .05)) +
  #facet_wrap(~Percent_Protein, scale = "free_x") +
  scale_fill_manual(values = ESS_pathwayColor) +
  ggtitle("Semi-Natural Treatment: Phylum proteobacteria from 5P Diet \nonly med-high gapmind confidence scores") +
theme_bw() +
  theme(
    title =element_text(size=22, face='bold'),
    axis.text.x = element_text(color="black", size=14),
    axis.text.y = element_text(color="black", size=16),
    strip.text.y = element_text(color="black", size=16),
    legend.title = element_text(color="black", size=22),
    legend.text = element_text(color="black", size=16),
    legend.position = "right",
    strip.background = element_blank(), #to remove facet wrap title
    strip.text = element_text(size = 20),
    axis.title.x = element_text(color="black", size=22),
    axis.title.y = element_text(color="black", size=22, angle=90),
    panel.grid.major = element_blank(), # switch off major grid lines
   panel.grid.minor = element_blank(), # switch off minor grid lines
    panel.border = element_rect(colour = "black", fill=NA, size=.75)
  )
#CREATE A PDF AND SAVES IT TO THE RIGHT DIRECTORY/FOLDER. 
pdf("/Users/connermertz/Dropbox (vlab)/Conner Mertz/UNM biology/Chapter 1 E1 vs E2/Methods/Metagenomics/methods_DataAnalysis/Metagenomic Pipeline/Plots/SANKEY/proteobacteria/E2_proteobacteria/E2_proteobacteria_5_path_steps.pdf", height = 12, width = 25)
E2_5P_proteobacteria
dev.off()

#E2_proteobacteria_fill family
E2_5P_proteobacteria <- ggplot(as.data.frame(E2_sankey_proteobacteria_5P),
       aes(y = Abundance, axis1 = family, axis2 = pathway, axis3 = MostLikelySeriesofStepsinPathway)) +
  geom_alluvium(aes(fill = family), width = 1/12)+
    geom_stratum(width = 1/12, fill = "black", color = "white") +
  geom_label(stat = "stratum", aes(label = after_stat(stratum))) +
  scale_x_discrete(limits = c("family", "pathway","MostLikelySeriesofStepsinPathway" ), expand = c(.05, .05)) +
scale_fill_manual(values = familyColor) +
  ggtitle("Semi-Natural Treatment: Phylum proteobacteria from 5P Diet \nonly med-high gapmind confidence scores") +
theme_bw() +
  theme(
    title =element_text(size=22, face='bold'),
    axis.text.x = element_text(color="black", size=14),
    axis.text.y = element_text(color="black", size=16),
    strip.text.y = element_text(color="black", size=16),
    legend.title = element_text(color="black", size=22),
    legend.text = element_text(color="black", size=16),
    legend.position = "right",
    strip.background = element_blank(), #to remove facet wrap title
    strip.text = element_text(size = 20),
    axis.title.x = element_text(color="black", size=22),
    axis.title.y = element_text(color="black", size=22, angle=90),
    panel.grid.major = element_blank(), # switch off major grid lines
   panel.grid.minor = element_blank(), # switch off minor grid lines
    panel.border = element_rect(colour = "black", fill=NA, size=.75)
  )
#CREATE A PDF AND SAVES IT TO THE RIGHT DIRECTORY/FOLDER. 
pdf("/Users/connermertz/Dropbox (vlab)/Conner Mertz/UNM biology/Chapter 1 E1 vs E2/Methods/Metagenomics/methods_DataAnalysis/Metagenomic Pipeline/Plots/SANKEY/proteobacteria/E2_proteobacteria/E2_proteobacteria_5P_family_steps.pdf", height = 12, width = 25)
E2_5P_proteobacteria
dev.off()
```

```{r}
#E2_proteobacteria_fill pathway
#10P
E2_10P_proteobacteria <- ggplot(as.data.frame(E2_sankey_proteobacteria_10P),
       aes(y = Abundance, axis1 = family, axis2 = pathway, axis3 = MostLikelySeriesofStepsinPathway)) +
  geom_alluvium(aes(fill = pathway), width = 1/12)+
    geom_stratum(width = 1/12, fill = "black", color = "white") +
  geom_label(stat = "stratum", aes(label = after_stat(stratum))) +
  scale_x_discrete(limits = c("family", "pathway","MostLikelySeriesofStepsinPathway" ), expand = c(.05, .05)) +
  #facet_wrap(~Percent_Protein, scale = "free_x") +
  scale_fill_manual(values = ESS_pathwayColor) +
  ggtitle("Semi-Natural Treatment: Phylum proteobacteria from 10P Diet \nonly med-high gapmind confidence scores") +
theme_bw() +
  theme(
    title =element_text(size=22, face='bold'),
    axis.text.x = element_text(color="black", size=14),
    axis.text.y = element_text(color="black", size=16),
    strip.text.y = element_text(color="black", size=16),
    legend.title = element_text(color="black", size=22),
    legend.text = element_text(color="black", size=16),
    legend.position = "right",
    strip.background = element_blank(), #to remove facet wrap title
    strip.text = element_text(size = 20),
    axis.title.x = element_text(color="black", size=22),
    axis.title.y = element_text(color="black", size=22, angle=90),
    panel.grid.major = element_blank(), # switch off major grid lines
   panel.grid.minor = element_blank(), # switch off minor grid lines
    panel.border = element_rect(colour = "black", fill=NA, size=.75)
  )
#CREATE A PDF AND SAVES IT TO THE RIGHT DIRECTORY/FOLDER. 
pdf("/Users/connermertz/Dropbox (vlab)/Conner Mertz/UNM biology/Chapter 1 E1 vs E2/Methods/Metagenomics/methods_DataAnalysis/Metagenomic Pipeline/Plots/SANKEY/proteobacteria/E2_proteobacteria/E2_proteobacteria_10_path_steps.pdf", height = 12, width = 25)
E2_10P_proteobacteria
dev.off()

#E2_proteobacteria_fill family
E2_10P_proteobacteria <- ggplot(as.data.frame(E2_sankey_proteobacteria_10P),
       aes(y = Abundance, axis1 = family, axis2 = pathway, axis3 = MostLikelySeriesofStepsinPathway)) +
  geom_alluvium(aes(fill = family), width = 1/12)+
    geom_stratum(width = 1/12, fill = "black", color = "white") +
  geom_label(stat = "stratum", aes(label = after_stat(stratum))) +
  scale_x_discrete(limits = c("family", "pathway","MostLikelySeriesofStepsinPathway" ), expand = c(.05, .05)) +
scale_fill_manual(values = familyColor) +
  ggtitle("Semi-Natural Treatment: Phylum proteobacteria from 10P Diet \nonly med-high gapmind confidence scores") +
theme_bw() +
  theme(
    title =element_text(size=22, face='bold'),
    axis.text.x = element_text(color="black", size=14),
    axis.text.y = element_text(color="black", size=16),
    strip.text.y = element_text(color="black", size=16),
    legend.title = element_text(color="black", size=22),
    legend.text = element_text(color="black", size=16),
    legend.position = "right",
    strip.background = element_blank(), #to remove facet wrap title
    strip.text = element_text(size = 20),
    axis.title.x = element_text(color="black", size=22),
    axis.title.y = element_text(color="black", size=22, angle=90),
    panel.grid.major = element_blank(), # switch off major grid lines
   panel.grid.minor = element_blank(), # switch off minor grid lines
    panel.border = element_rect(colour = "black", fill=NA, size=.75)
  )
#CREATE A PDF AND SAVES IT TO THE RIGHT DIRECTORY/FOLDER. 
pdf("/Users/connermertz/Dropbox (vlab)/Conner Mertz/UNM biology/Chapter 1 E1 vs E2/Methods/Metagenomics/methods_DataAnalysis/Metagenomic Pipeline/Plots/SANKEY/proteobacteria/E2_proteobacteria/E2_proteobacteria_10P_family_steps.pdf", height = 12, width = 25)
E2_10P_proteobacteria
dev.off()
```







